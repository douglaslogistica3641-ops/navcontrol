<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NavControl — Gestão de Abastecimento Naval</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* ===== RESET ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* ===== VARIÁVEIS — TEMA NEUTRO ===== */
    :root {
      --primary:       #1e3a5f;
      --primary-light: #2d5286;
      --primary-dark:  #132740;
      --accent:        #2563eb;
      --accent-light:  #3b82f6;
      --oleo-color:    #0ea5e9;   /* azul petróleo */
      --oleo-dark:     #0284c7;   /* texto sobre fundo claro */
      --agua-dark:     #0891b2;   /* texto sobre fundo claro */
      --agua-color:    #06b6d4;   /* ciano água */
      --success:       #059669;
      --warning:       #d97706;
      --danger:        #dc2626;
      --info:          #2563eb;
      --gray-50:  #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0;
      --gray-300: #cbd5e1; --gray-400: #94a3b8; --gray-500: #64748b;
      --gray-600: #475569; --gray-700: #334155; --gray-800: #1e293b; --gray-900: #0f172a;
      --white: #ffffff; --black: #000000;
      --bg-body:     #f1f5f9;
      --bg-app:      #f1f5f9;
      --text-primary:   var(--gray-800);
      --text-secondary: var(--gray-500);
      --border-color:   var(--gray-200);
      --card-bg:        var(--white);
      --shadow:     0 1px 3px 0 rgba(0,0,0,0.08), 0 1px 2px -1px rgba(0,0,0,0.06);
      --shadow-md:  0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -2px rgba(0,0,0,0.06);
      --shadow-lg:  0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.05);
      --shadow-xl:  0 20px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.04);
      --sidebar-width: 260px;
      --sidebar-collapsed-width: 72px;
      --radius-sm: 4px; --radius-md: 6px; --radius-lg: 8px; --radius-xl: 12px; --radius-2xl: 16px;
    }
    body.dark-mode {
      --oleo-dark: #38bdf8; --agua-dark: #22d3ee;
      --primary: #334155; --primary-light: #475569; --primary-dark: #1e293b;
      --accent: #60a5fa; --accent-light: #93c5fd;
      --gray-50: #1e293b; --gray-100: #253349; --gray-200: #334155;
      --gray-300: #475569; --gray-400: #64748b; --gray-500: #94a3b8;
      --gray-600: #cbd5e1; --gray-700: #e2e8f0; --gray-800: #f1f5f9; --gray-900: #f8fafc;
      --white: #1e293b; --black: #f8fafc;
      --bg-body: #0f172a; --bg-app: #0f172a;
      --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --border-color: #334155; --card-bg: #1e293b;
    }

    /* ===== BASE ===== */
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      min-height: 100vh;
      color: var(--text-primary);
      transition: background 0.3s, color 0.3s;
    }

    /* ===== LOGIN ===== */
    .login-wrapper {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; background: var(--bg-body);
    }
    .login-container { width: 100%; max-width: 400px; padding: 20px; }
    .login-card {
      background: var(--card-bg); border-radius: var(--radius-2xl);
      padding: 40px 32px; box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
    }
    .login-header { text-align: center; margin-bottom: 32px; }
    .login-logo {
      font-size: 32px; font-weight: 700; color: var(--primary);
      margin-bottom: 8px; letter-spacing: -0.5px;
    }
    .login-subtitle { color: var(--text-secondary); font-size: 13px; }
    .login-divider { display: flex; align-items: center; gap: 8px; margin: 20px 0; }
    .login-divider hr { flex: 1; border: none; border-top: 1px solid var(--border-color); }
    .login-divider span { font-size: 11px; color: var(--text-secondary); white-space: nowrap; }

    /* ===== FORMS ===== */
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block; font-size: 12px; font-weight: 600;
      color: var(--text-secondary); text-transform: uppercase;
      letter-spacing: 0.4px; margin-bottom: 6px;
    }
    .form-control {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border-color);
      border-radius: var(--radius-lg); font-size: 13px; font-family: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: var(--card-bg); color: var(--text-primary);
    }
    .form-control:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
    }
    .form-control[readonly] { background: var(--gray-100); color: var(--gray-600); cursor: default; }
    .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .form-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

    /* ===== BTNS ===== */
    .btn {
      padding: 10px 18px; border-radius: var(--radius-lg); font-size: 13px;
      font-weight: 600; cursor: pointer; transition: all 0.15s; border: none;
      display: inline-flex; align-items: center; justify-content: center; gap: 7px;
      font-family: inherit;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-light); box-shadow: var(--shadow-md); }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-accent:hover { background: var(--accent-light); }
    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }
    .btn-outline:hover { background: var(--gray-100); color: var(--text-primary); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { background: #b91c1c; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: #047857; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-icon { width: 34px; height: 34px; padding: 0; border-radius: var(--radius-md); }
    .btn-full { width: 100%; }
    .btn-logout {
      background: transparent; border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.8); padding: 8px 14px; border-radius: var(--radius-lg);
      font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex;
      align-items: center; gap: 6px; font-family: inherit; transition: all 0.15s;
    }
    .btn-logout:hover { background: rgba(255,255,255,0.1); color: #fff; }

    /* ===== APP CONTAINER ===== */
    .app-container { width: 100%; min-height: 100vh; background: var(--bg-app); display: none; }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: var(--sidebar-width); background: var(--primary-dark);
      color: #fff; position: fixed; height: 100vh; overflow-y: auto;
      box-shadow: var(--shadow-lg); transition: width 0.25s; z-index: 100;
      display: flex; flex-direction: column;
    }
    .sidebar.collapsed { width: var(--sidebar-collapsed-width); }
    .sidebar-header {
      padding: 18px 16px; border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; align-items: center; justify-content: space-between;
      min-height: 64px; flex-shrink: 0;
    }
    .sidebar-logo {
      font-size: 18px; font-weight: 700; color: #fff;
      white-space: nowrap; overflow: hidden; letter-spacing: -0.3px;
    }
    .sidebar-logo span { color: var(--accent-light); }
    .sidebar.collapsed .sidebar-logo { opacity: 0; width: 0; }
    .toggle-sidebar {
      background: rgba(255,255,255,0.08); border: none; color: rgba(255,255,255,0.7);
      width: 30px; height: 30px; border-radius: var(--radius-md); cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 14px;
      transition: background 0.15s; flex-shrink: 0;
    }
    .toggle-sidebar:hover { background: rgba(255,255,255,0.15); color: #fff; }
    .user-info {
      padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex; align-items: center; gap: 10px; flex-shrink: 0;
    }
    .user-avatar {
      width: 34px; height: 34px; background: var(--accent);
      border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-weight: 700; font-size: 13px;
      flex-shrink: 0;
    }
    .user-details { white-space: nowrap; overflow: hidden; }
    .user-name { font-weight: 600; font-size: 13px; color: #fff; }
    .user-role { font-size: 11px; color: rgba(255,255,255,0.5); }
    .sidebar.collapsed .user-details { display: none; }
    .sidebar-nav { padding: 12px 8px; flex: 1; }
    .nav-section {
      font-size: 10px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 1px; color: rgba(255,255,255,0.35);
      padding: 12px 8px 6px; white-space: nowrap; overflow: hidden;
    }
    .sidebar.collapsed .nav-section { opacity: 0; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 9px 10px;
      border-radius: var(--radius-lg); color: rgba(255,255,255,0.65);
      cursor: pointer; transition: all 0.15s; margin-bottom: 2px;
      white-space: nowrap; overflow: hidden;
    }
    .nav-item:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .nav-item.active { background: var(--accent); color: #fff; }
    .nav-item i { width: 18px; font-size: 15px; flex-shrink: 0; text-align: center; }
    .nav-item span { font-size: 13px; font-weight: 500; }
    .sidebar.collapsed .nav-item span { display: none; }
    .sidebar-footer { padding: 12px 8px; border-top: 1px solid rgba(255,255,255,0.08); flex-shrink: 0; }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      margin-left: var(--sidebar-width); padding: 24px 28px;
      transition: margin-left 0.25s; min-height: 100vh;
      background: var(--bg-app); color: var(--text-primary);
    }
    .main-content.expanded { margin-left: var(--sidebar-collapsed-width); }

    /* ===== TOPBAR ===== */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
    }
    .header-title h2 { font-size: 22px; font-weight: 700; color: var(--text-primary); margin-bottom: 2px; }
    .header-title p { color: var(--text-secondary); font-size: 13px; }
    .header-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    /* ===== CARDS ===== */
    .card {
      background: var(--card-bg); border-radius: var(--radius-xl); padding: 20px;
      box-shadow: var(--shadow); border: 1px solid var(--border-color);
      margin-bottom: 20px; color: var(--text-primary);
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    .card-header h3 { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .badge {
      font-size: 11px; padding: 3px 10px; border-radius: 20px;
      background: var(--gray-100); color: var(--text-secondary); font-weight: 600;
    }
    .badge-oleo { background: rgba(14,165,233,0.1); color: var(--oleo-color); }
    .badge-agua { background: rgba(6,182,212,0.1); color: var(--agua-color); }

    /* ===== KPI GRID ===== */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .kpi-grid-2 { grid-template-columns: repeat(2, 1fr); }
    .kpi-grid-3 { grid-template-columns: repeat(3, 1fr); }
    .kpi-card {
      background: var(--card-bg); border-radius: var(--radius-xl); padding: 20px;
      box-shadow: var(--shadow); border: 1px solid var(--border-color);
      position: relative; overflow: hidden;
    }
    .kpi-card-oleo { border-left: 3px solid var(--oleo-color); }
    .kpi-card-agua { border-left: 3px solid var(--agua-color); }
    .kpi-card-neutral { border-left: 3px solid var(--gray-300); }
    .kpi-icon {
      width: 40px; height: 40px; border-radius: var(--radius-lg);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; margin-bottom: 12px;
    }
    .kpi-icon-oleo { background: var(--gray-100); color: var(--oleo-color); }
    .kpi-icon-agua { background: var(--gray-100); color: var(--agua-color); }
    .kpi-icon-neutral { background: var(--gray-100); color: var(--gray-500); }
    .kpi-icon-success { background: var(--gray-100); color: var(--success); }
    .kpi-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 6px; }
    .kpi-value { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700; color: var(--text-primary); line-height: 1.2; margin-bottom: 4px; }
    .kpi-trend { font-size: 12px; color: var(--text-secondary); }

    /* ===== CHARTS ===== */
    .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px; }
    .chart-card { background: var(--card-bg); border-radius: var(--radius-xl); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
    .chart-container { height: 260px; position: relative; }
    .chart-container-sm { height: 200px; position: relative; max-width: 320px; margin: 0 auto; }
    .chart-container-full { height: 320px; position: relative; }

    /* ===== TABLE ===== */
    .table-container {
      background: var(--card-bg); border-radius: var(--radius-xl);
      box-shadow: var(--shadow); border: 1px solid var(--border-color);
      overflow: hidden; margin-bottom: 20px;
    }
    .table-header {
      padding: 16px 20px; border-bottom: 1px solid var(--border-color);
      display: flex; align-items: center; justify-content: space-between;
    }
    .table-header h3 { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .table-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th {
      text-align: left; padding: 12px 16px; font-size: 11px; font-weight: 600;
      color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.4px;
      background: var(--gray-50); border-bottom: 1px solid var(--border-color);
      cursor: pointer; user-select: none; white-space: nowrap;
    }
    th:hover { background: var(--gray-100); }
    td { padding: 12px 16px; font-size: 13px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--gray-50); }

    /* ===== BADGES ===== */
    .pill {
      display: inline-flex; align-items: center; padding: 3px 10px;
      border-radius: 20px; font-size: 11px; font-weight: 600; gap: 4px;
    }
    .pill-aco { background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-300); }
    .pill-madeira { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
    .pill-oleo { background: rgba(14,165,233,0.1); color: var(--oleo-color); border: 1px solid rgba(14,165,233,0.3); }
    .pill-agua { background: rgba(6,182,212,0.1); color: var(--agua-color); border: 1px solid rgba(6,182,212,0.3); }
    .pill-compra { background: rgba(5,150,105,0.1); color: var(--success); border: 1px solid rgba(5,150,105,0.3); }
    .pill-passagem { background: rgba(37,99,235,0.1); color: var(--accent); border: 1px solid rgba(37,99,235,0.3); }
    .pill-consumo { background: rgba(220,100,0,0.1); color: #9a3412; border: 1px solid rgba(220,100,0,0.3); }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      backdrop-filter: blur(3px); z-index: 1000; display: none;
      align-items: center; justify-content: center; padding: 16px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--card-bg); border-radius: var(--radius-2xl);
      width: 560px; max-width: 100%; max-height: 90vh; overflow-y: auto;
      box-shadow: var(--shadow-xl); border: 1px solid var(--border-color);
      animation: modalIn 0.2s ease;
    }
    @keyframes modalIn { from { opacity: 0; transform: translateY(-12px); } to { opacity: 1; transform: translateY(0); } }
    .modal-header {
      padding: 18px 20px; border-bottom: 1px solid var(--border-color);
      display: flex; align-items: center; justify-content: space-between;
      background: var(--primary-dark); color: #fff;
      border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
    }
    .modal-header h3 { font-size: 15px; font-weight: 600; color: #fff; }
    .modal-close {
      width: 30px; height: 30px; border-radius: 50%; border: none;
      background: rgba(255,255,255,0.15); color: #fff; cursor: pointer;
      font-size: 16px; display: flex; align-items: center; justify-content: center;
      transition: background 0.15s;
    }
    .modal-close:hover { background: rgba(255,255,255,0.25); }
    .modal-body { padding: 20px; }
    .modal-footer {
      padding: 16px 20px; border-top: 1px solid var(--border-color);
      display: flex; justify-content: flex-end; gap: 10px; background: var(--gray-50);
      border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
    }

    /* ===== FILTERS / SEARCH ===== */
    .filter-bar {
      display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;
      background: var(--card-bg); padding: 16px; border-radius: var(--radius-xl);
      box-shadow: var(--shadow); border: 1px solid var(--border-color); align-items: center;
    }
    .filter-group { display: flex; align-items: center; gap: 8px; }
    .filter-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); white-space: nowrap; }
    .filter-select, .filter-input {
      padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md);
      font-size: 12px; background: var(--card-bg); color: var(--text-primary);
    }
    .search-box {
      padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md);
      font-size: 13px; min-width: 200px; background: var(--card-bg); color: var(--text-primary);
    }

    /* ===== PAGINATION ===== */
    .pagination {
      display: flex; justify-content: flex-end; align-items: center;
      gap: 6px; padding: 12px 16px; background: var(--gray-50);
      border-top: 1px solid var(--border-color);
    }
    .pagination button {
      padding: 5px 10px; border: 1px solid var(--border-color); background: var(--card-bg);
      color: var(--text-primary); border-radius: var(--radius-md); cursor: pointer; font-size: 12px;
    }
    .pagination button:disabled { opacity: 0.4; cursor: not-allowed; }
    .pagination span { font-size: 12px; color: var(--text-secondary); }

    /* ===== SUPPLY MODAL SPECIFIC ===== */
    .fluid-tabs {
      display: flex; gap: 0; margin-bottom: 16px;
      border: 1px solid var(--border-color); border-radius: var(--radius-lg); overflow: hidden;
    }
    .fluid-tab {
      flex: 1; padding: 10px; text-align: center; cursor: pointer;
      font-size: 13px; font-weight: 600; transition: all 0.15s;
      background: var(--card-bg); color: var(--text-secondary);
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .fluid-tab.active-oleo { background: rgba(14,165,233,0.1); color: var(--oleo-color); border-bottom: 2px solid var(--oleo-color); }
    .fluid-tab.active-agua { background: rgba(6,182,212,0.1); color: var(--agua-color); border-bottom: 2px solid var(--agua-color); }
    .fluid-tab:not(.active-oleo):not(.active-agua):hover { background: var(--gray-100); }

    .op-tabs {
      display: flex; gap: 0; margin-bottom: 16px;
      border: 1px solid var(--border-color); border-radius: var(--radius-lg); overflow: hidden;
    }
    .op-tab {
      flex: 1; padding: 9px; text-align: center; cursor: pointer;
      font-size: 12px; font-weight: 600; transition: all 0.15s;
      background: var(--card-bg); color: var(--text-secondary);
    }
    .op-tab.active { background: var(--primary); color: #fff; }
    .op-tab:not(.active):hover { background: var(--gray-100); }

    .calc-panel {
      background: var(--gray-50); border-radius: var(--radius-lg); padding: 16px;
      border: 1px solid var(--border-color); margin-top: 4px;
    }
    .calc-panel h4 { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    .calc-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; border-bottom: 1px solid var(--border-color); }
    .calc-row:last-child { border-bottom: none; }
    .calc-row.total { font-weight: 700; font-size: 15px; color: var(--primary); padding-top: 10px; }
    .calc-label { color: var(--text-secondary); }
    .calc-value { font-family: 'JetBrains Mono', monospace; font-weight: 600; }

    .stock-info {
      background: rgba(14,165,233,0.05); border: 1px solid rgba(14,165,233,0.2);
      border-radius: var(--radius-md); padding: 10px 14px; margin-bottom: 12px;
      font-size: 12px; color: var(--oleo-dark); display: flex; align-items: center; gap: 8px;
    }
    .stock-info-agua {
      background: rgba(6,182,212,0.05); border-color: rgba(6,182,212,0.2); color: var(--agua-dark);
    }
    .stock-info i { font-size: 14px; }

    /* ===== STOCK POSITION DASHBOARD ===== */
    .stock-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
    .stock-vessel-card {
      background: var(--card-bg); border-radius: var(--radius-xl);
      border: 1px solid var(--border-color); box-shadow: var(--shadow); overflow: hidden;
    }
    .stock-vessel-header {
      padding: 14px 16px; background: var(--gray-50);
      border-bottom: 1px solid var(--border-color);
      display: flex; align-items: center; justify-content: space-between;
    }
    .stock-vessel-name { font-size: 13px; font-weight: 700; color: var(--text-primary); }
    .stock-vessel-body { padding: 14px 16px; }
    .stock-fluid-row { margin-bottom: 12px; }
    .stock-fluid-row:last-child { margin-bottom: 0; }
    .stock-fluid-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .stock-fluid-label span { font-size: 12px; font-weight: 600; }
    .stock-fluid-label .qty { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-secondary); }
    .progress-bar { height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; }
    .progress-fill-oleo { height: 100%; border-radius: 3px; background: var(--oleo-color); transition: width 0.4s; }
    .progress-fill-agua { height: 100%; border-radius: 3px; background: var(--agua-color); transition: width 0.4s; }
    .pct-label { font-size: 11px; color: var(--text-secondary); margin-top: 3px; text-align: right; }

    /* ===== AUTOSAVE WIDGET ===== */
    .autosave-widget {
      display: inline-flex; align-items: center; gap: 7px; padding: 7px 12px;
      border-radius: var(--radius-lg); border: 1px solid var(--border-color);
      background: var(--card-bg); color: var(--text-secondary);
      font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s;
    }
    .autosave-widget:hover { border-color: var(--accent); color: var(--accent); }
    .autosave-widget.active { border-color: var(--success); color: var(--success); background: rgba(5,150,105,0.05); }
    .autosave-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--gray-300); }
    .autosave-widget.active .autosave-dot {
      background: var(--success);
      animation: pulse-dot 2.5s infinite;
    }
    @keyframes pulse-dot {
      0%   { box-shadow: 0 0 0 0 rgba(5,150,105,0.5); }
      70%  { box-shadow: 0 0 0 6px rgba(5,150,105,0); }
      100% { box-shadow: 0 0 0 0 rgba(5,150,105,0); }
    }
    .autosave-countdown { font-family: 'JetBrains Mono', monospace; font-size: 11px; min-width: 30px; text-align: right; }
    .btn-save-now {
      background: var(--primary); color: #fff; padding: 7px 13px;
      border-radius: var(--radius-lg); font-size: 12px; font-weight: 600;
      border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
      transition: all 0.15s; font-family: inherit;
    }
    .btn-save-now:hover { background: var(--primary-light); }

    /* ===== TOAST ===== */
    .toast {
      position: fixed; top: 20px; right: 20px; max-width: 360px;
      padding: 14px 18px; border-radius: var(--radius-lg); font-size: 13px;
      font-weight: 500; z-index: 2000; box-shadow: var(--shadow-lg);
      display: flex; align-items: center; gap: 10px; overflow: hidden;
      animation: toastIn 0.25s ease;
    }
    @keyframes toastIn { from { opacity: 0; transform: translateX(16px); } to { opacity: 1; transform: translateX(0); } }
    .toast { background: var(--gray-800); color: #fff; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    .toast.warning { background: var(--warning); }
    .toast.info { background: var(--info); }
    .toast-progress {
      position: absolute; bottom: 0; left: 0; height: 2px;
      background: rgba(255,255,255,0.35); border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      animation: toast-bar 3.2s linear forwards;
    }
    @keyframes toast-bar { from { width: 100%; } to { width: 0%; } }

    /* ===== MISC ===== */
    .radio-group { display: flex; gap: 16px; align-items: center; }
    .radio-group label { display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; color: var(--text-primary); }
    .loading-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.25);
      backdrop-filter: blur(2px); z-index: 3000; display: flex;
      align-items: center; justify-content: center;
    }
    .spinner {
      width: 40px; height: 40px; border: 3px solid var(--gray-200);
      border-top-color: var(--primary); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tooltip-icon { margin-left: 3px; color: var(--info); cursor: help; font-size: 11px; }
    .section-divider { border: none; border-top: 1px solid var(--border-color); margin: 16px 0; }
    .text-muted { color: var(--text-secondary); }
    .text-oleo { color: var(--oleo-color); }
    .text-agua { color: var(--agua-color); }
    .info-box {
      background: rgba(37,99,235,0.05); border: 1px solid rgba(37,99,235,0.15);
      border-radius: var(--radius-lg); padding: 12px 16px;
      font-size: 13px; color: var(--info); margin-bottom: 16px;
      display: flex; align-items: flex-start; gap: 8px;
    }

    /* ===== ALERTAS DE ESTOQUE ===== */
    .stock-alert-badge { display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;border-radius:9px;font-size:10px;font-weight:700;background:var(--danger);color:#fff;margin-left:4px;padding:0 4px; }
    .stock-alert-badge.warning { background:var(--warning); }
    .progress-fill-oleo.critical,.progress-fill-agua.critical { background:var(--danger) !important; }
    .progress-fill-oleo.warning,.progress-fill-agua.warning { background:var(--warning) !important; }
    .alert-tag { display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:10px;font-size:10px;font-weight:700; }
    .alert-tag-critical { background:rgba(220,38,38,0.08);color:var(--danger);border:1px solid rgba(220,38,38,0.3); }
    .alert-tag-warning { background:rgba(217,119,6,0.08);color:var(--warning);border:1px solid rgba(217,119,6,0.3); }
    .alert-banner { padding:12px 16px;border-radius:var(--radius-lg);margin-bottom:16px;font-size:13px;display:flex;align-items:center;gap:10px;flex-wrap:wrap; }
    .alert-banner-critical { background:rgba(220,38,38,0.07);border:1px solid rgba(220,38,38,0.25);color:var(--danger); }
    .alert-banner-warning { background:rgba(217,119,6,0.07);border:1px solid rgba(217,119,6,0.25);color:var(--warning); }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1400px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } .chart-grid { grid-template-columns: 1fr; } .stock-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 1024px) { .sidebar { width: var(--sidebar-collapsed-width); } .sidebar .sidebar-logo, .sidebar .user-details, .sidebar .nav-item span, .sidebar .nav-section { display: none; } .main-content { margin-left: var(--sidebar-collapsed-width); } }
    @media (max-width: 768px) { .main-content { margin-left: 0; padding: 16px; } .sidebar { transform: translateX(-100%); } .sidebar.show { transform: translateX(0); } .kpi-grid { grid-template-columns: 1fr 1fr; } .form-row, .form-row-3 { grid-template-columns: 1fr; } .stock-grid { grid-template-columns: 1fr; } }
  
    /* ===== BADGES DE PERFIL ===== */
    .badge-admin { background:rgba(124,58,237,0.12); color:#6d28d9; border:1px solid rgba(124,58,237,0.25); font-size:11px; padding:2px 9px; border-radius:20px; font-weight:600; }
    .badge-operador { background:rgba(37,99,235,0.12); color:#1d4ed8; border:1px solid rgba(37,99,235,0.25); font-size:11px; padding:2px 9px; border-radius:20px; font-weight:600; }
    .badge-inativo { background:var(--gray-100); color:var(--gray-400); border:1px solid var(--gray-200); font-size:11px; padding:2px 9px; border-radius:20px; font-weight:600; }

    /* ===== SOLICITAÇÕES DE CORREÇÃO ===== */
    .req-card { background:var(--card-bg); border:1px solid var(--border-color); border-left:4px solid var(--warning); border-radius:var(--radius-xl); padding:16px 20px; margin-bottom:12px; }
    .req-card.req-resolvida { border-left-color:var(--success); opacity:0.65; }
    .req-header { display:flex; align-items:flex-start; gap:12px; margin-bottom:8px; }
    .req-num { font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--text-secondary); }
    .req-body { font-size:13px; color:var(--text-primary); margin-bottom:8px; line-height:1.6; }
    .req-meta { font-size:11px; color:var(--text-secondary); display:flex; gap:16px; flex-wrap:wrap; }
    .notif-dot { display:inline-block; width:8px; height:8px; background:var(--danger); border-radius:50%; margin-left:6px; vertical-align:middle; animation:pulse-dot 1.5s infinite; }
    @keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.6;transform:scale(1.3)} }

    /* ===== VESSEL CHIPS ===== */
    .vessel-chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .vessel-chip { display:inline-flex; align-items:center; gap:5px; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; background:var(--gray-100); border:1px solid var(--gray-200); color:var(--gray-700); cursor:default; }
    .vessel-chip.selected { background:rgba(14,165,233,0.12); border-color:rgba(14,165,233,0.35); color:var(--oleo-dark); }

    /* ===== BLOCO DE PERMISSÃO NEGADA ===== */
    .perm-block { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:48px 20px; text-align:center; color:var(--text-secondary); }
    .perm-block i { font-size:40px; margin-bottom:12px; opacity:.3; }
    .perm-block h3 { font-size:16px; font-weight:600; margin-bottom:6px; color:var(--text-primary); }
    .perm-block p { font-size:13px; max-width:340px; }

    /* ===== SOLICITAR CORREÇÃO BTN ===== */
    .btn-solicitar { background:rgba(217,119,6,0.08); color:var(--warning); border:1px solid rgba(217,119,6,0.3); padding:4px 10px; border-radius:var(--radius-md); font-size:11px; font-weight:600; cursor:pointer; white-space:nowrap; transition:all .15s; }
    .btn-solicitar:hover { background:rgba(217,119,6,0.18); }

    /* ===== MODAL USER ===== */
    .vessel-select-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:8px; max-height:200px; overflow-y:auto; padding:4px; }
    .vessel-select-item { display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border-color); border-radius:var(--radius-md); cursor:pointer; transition:all .15s; font-size:13px; user-select:none; }
    .vessel-select-item:hover { background:var(--gray-50); }
    .vessel-select-item.selected { background:rgba(14,165,233,0.1); border-color:var(--oleo-color); color:var(--oleo-dark); }
    .vessel-select-item input { accent-color:var(--oleo-color); cursor:pointer; }

    /* ===== SIDEBAR BADGE ===== */
    .nav-item .nav-badge { margin-left:auto; background:var(--danger); color:#fff; font-size:10px; font-weight:700; padding:1px 7px; border-radius:10px; min-width:20px; text-align:center; }

    </style>
</head>
<body>

  <!-- LOGIN -->
  <div class="login-wrapper" id="loginScreen">
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <div class="login-logo">NavControl</div>
          <div class="login-subtitle">Gestão de Abastecimento Naval</div>
        </div>
        <div class="form-group">
          <label class="form-label">Usuário</label>
          <input type="text" class="form-control" id="username" placeholder="Digite seu usuário" autocomplete="username">
        </div>
        <div class="form-group">
          <label class="form-label">Senha</label>
          <input type="password" class="form-control" id="password" placeholder="Digite sua senha" autocomplete="current-password" onkeydown="if(event.key==='Enter') login()">
        </div>
        <button class="btn btn-primary btn-full" onclick="login()">
          <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
        </button>
        <div class="login-divider"><hr><span id="loginHint">Acesso restrito</span><hr></div>
      <div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border-color);text-align:center;">
        <div style="font-size:11px;color:var(--text-secondary);line-height:1.7;">
          <div style="font-weight:600;color:var(--text-primary);font-size:12px;">Douglas de Oliveira da Silva</div>
          <div style="color:var(--accent);font-size:11px;font-weight:500;">Engenheiro</div>
          <div style="font-size:10px;opacity:.55;margin-top:4px;">NavControl &copy; 2026 &mdash; Gestão de Abastecimento Naval</div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app-container" id="appContainer">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">Nav<span>Control</span></div>
        <button class="toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
      </div>
      <div class="user-info" id="sidebarUser">
        <div class="user-avatar" id="sidebarAvatar">AD</div>
        <div class="user-details">
          <div class="user-name" id="sidebarName">Admin</div>
          <div class="user-role" id="sidebarRole">Administrador</div>
        </div>
      </div>
      <nav class="sidebar-nav" id="sidebarNav">
        <!-- gerado por renderSidebar() -->
      </nav>
      <div class="sidebar-footer">
        <button class="btn-logout btn-full" style="width:100%;justify-content:center;" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> <span class="sidebar-logout-label">Sair</span>
        </button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content" id="mainContent">
      <div class="header">
        <div class="header-title">
          <h2 id="dashboardTitle">Dashboard</h2>
          <p id="dashboardDesc">Visão geral dos abastecimentos</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary btn-sm" id="btnNovoAbast" onclick="openSupplyModal()">
            <i class="fas fa-plus"></i> Novo Abastecimento
          </button>
          <button class="btn-save-now" id="btnSaveNow" onclick="salvarAgora()">
            <i class="fas fa-download" id="saveNowIcon"></i> Salvar Agora
          </button>
          <div class="autosave-widget" id="autosaveWidget" onclick="toggleAutoSave()">
            <div class="autosave-dot" id="autosaveDot"></div>
            <span id="autosaveLabel">Auto-Save OFF</span>
            <span class="autosave-countdown" id="autosaveCountdown" style="display:none"></span>
          </div>
          <button class="btn btn-outline btn-icon" onclick="toggleDarkMode()" title="Alternar modo escuro">
            <i class="fas fa-moon" id="darkModeIcon"></i>
          </button>
        </div>
      </div>
      <div id="dashboardContent"></div>
    </main>
  </div>

  <!-- MODAL: ABASTECIMENTO -->
  <div class="modal-overlay" id="supplyModal">
    <div class="modal" style="width:580px;">
      <div class="modal-header">
        <h3 id="modalTitle">Novo Abastecimento</h3>
        <button class="modal-close" onclick="closeModal('supplyModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="supplyModalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('supplyModal')">Cancelar</button>
        <button class="btn btn-primary" onclick="saveSupply()"><i class="fas fa-save"></i> Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: EMPRESA -->
  <div class="modal-overlay" id="companyModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="companyModalTitle">Nova Empresa</h3>
        <button class="modal-close" onclick="closeModal('companyModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="companyModalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('companyModal')">Cancelar</button>
        <button class="btn btn-primary" onclick="saveCompany()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: EMBARCAÇÃO -->
  <div class="modal-overlay" id="vesselModal">
    <div class="modal" style="width:620px;">
      <div class="modal-header">
        <h3 id="vesselModalTitle">Nova Embarcação</h3>
        <button class="modal-close" onclick="closeModal('vesselModal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" id="vesselModalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('vesselModal')">Cancelar</button>
        <button class="btn btn-primary" onclick="saveVessel()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="spinner"></div>
  </div>

  <script>
  // =====================================================================
  //  DADOS INICIAIS
  // =====================================================================
  const INITIAL_DB = {
    vessels: [
      { id: 1,  name: "RS CORREGO DO OURO",   sigla: "RS_CDO",  material: "Aço",    cc: 1001, cr: "R1001", tripulacao: 12, capacidadeOleo: 14, capacidadeAgua: 5 },
      { id: 2,  name: "RS FRADE",             sigla: "RS_FRD",  material: "Aço",    cc: 1002, cr: "R1002", tripulacao: 12, capacidadeOleo: 14, capacidadeAgua: 5 },
      { id: 3,  name: "RS MACAÉ",             sigla: "RS_MAC",  material: "Aço",    cc: 1003, cr: "R1003", tripulacao: 12, capacidadeOleo: 14, capacidadeAgua: 5 },
      { id: 4,  name: "RS TRAPICHE",          sigla: "RS_TRP",  material: "Madeira",cc: 1004, cr: "R1004", tripulacao: 12, capacidadeOleo: 10, capacidadeAgua: 3 },
      { id: 5,  name: "RS SANA",              sigla: "RS_SNA",  material: "Aço",    cc: 1005, cr: "R1005", tripulacao: 12, capacidadeOleo: 14, capacidadeAgua: 5 },
      { id: 6,  name: "RS TRAPOLEO",          sigla: "RS_TPO",  material: "Madeira",cc: 1006, cr: "R1006", tripulacao: 12, capacidadeOleo: 10, capacidadeAgua: 3 },
      { id: 7,  name: "SEM LIMITES II",       sigla: "SL_II",   material: "Madeira",cc: 1007, cr: "R1007", tripulacao: 18, capacidadeOleo: 22, capacidadeAgua: 8 },
      { id: 8,  name: "SEM LIMITES III",      sigla: "SL_III",  material: "Madeira",cc: 1008, cr: "R1008", tripulacao: 18, capacidadeOleo: 22, capacidadeAgua: 8 },
      { id: 9,  name: "SEM LIMITES V",        sigla: "SL_V",    material: "Madeira",cc: 1009, cr: "R1009", tripulacao: 18, capacidadeOleo: 22, capacidadeAgua: 8 },
      { id: 10, name: "RS SEM LIMITES 2013",  sigla: "RS_SL13", material: "Madeira",cc: 1010, cr: "R1010", tripulacao: 12, capacidadeOleo: 14, capacidadeAgua: 4 },
      { id: 11, name: "RS MARIA DO CARMO",    sigla: "RS_MDC",  material: "Madeira",cc: 1011, cr: "R1011", tripulacao: 12, capacidadeOleo: 14, capacidadeAgua: 4 },
      { id: 12, name: "RS AREIA BRANCA",      sigla: "RS_ABR",  material: "Aço",    cc: 1012, cr: "R1012", tripulacao: 12, capacidadeOleo: 14, capacidadeAgua: 5 }
    ],
    companies: [
      { id: 1, name: "Petrobras Distribuidora", cnpj: "12.345.678/0001-90", contato: "joao@petrobras.com", telefone: "(21) 1234-5678", endereco: "Av. Rio Branco, 100" },
      { id: 2, name: "Vibra Energia",           cnpj: "98.765.432/0001-10", contato: "maria@vibra.com",    telefone: "(21) 8765-4321", endereco: "Rua da Assembleia, 50" },
      { id: 3, name: "Raízen",                  cnpj: "11.222.333/0001-44", contato: "carlos@raizen.com",  telefone: "(21) 1122-3344", endereco: "Av. das Américas, 500" }
    ],
    supplies: [
      { id: 1, vesselId: 1, companyId: 1, data: "2026-02-15", tipoFluido: "oleo", quantidade: 5000, valorUnitario: 5.80, valorTotal: 29000,  quantidadeAntes: 3500, quantidadeSolicitada: 5000, quantidadeBordo: 8500,  tipoOperacao: "compra",    observacao: "Abastecimento programado" },
      { id: 2, vesselId: 1, companyId: 2, data: "2026-02-20", tipoFluido: "oleo", quantidade: 3000, valorUnitario: 5.85, valorTotal: 17550,  quantidadeAntes: 8500, quantidadeSolicitada: 3000, quantidadeBordo: 11500, tipoOperacao: "compra",    observacao: "" },
      { id: 3, vesselId: 2, companyId: 1, data: "2026-02-18", tipoFluido: "oleo", quantidade: 4500, valorUnitario: 5.82, valorTotal: 26190,  quantidadeAntes: 4700, quantidadeSolicitada: 4500, quantidadeBordo: 9200,  tipoOperacao: "compra",    observacao: "" },
      { id: 4, vesselId: 7, companyId: 3, data: "2026-02-22", tipoFluido: "oleo", quantidade: 8000, valorUnitario: 5.75, valorTotal: 46000,  quantidadeAntes: 7000, quantidadeSolicitada: 8000, quantidadeBordo: 15000, tipoOperacao: "compra",    observacao: "Abastecimento emergencial" },
      { id: 5, vesselId: 4, companyId: 2, data: "2026-02-25", tipoFluido: "oleo", quantidade: 3500, valorUnitario: 5.88, valorTotal: 20580,  quantidadeAntes: 3300, quantidadeSolicitada: 3500, quantidadeBordo: 6800,  tipoOperacao: "compra",    observacao: "" },
      { id: 6, vesselId: 1, companyId: null, data: "2026-02-10", tipoFluido: "agua", quantidade: 2000, valorUnitario: 0,   valorTotal: 0,      quantidadeAntes: 1000, quantidadeSolicitada: 2000, quantidadeBordo: 3000,  tipoOperacao: "compra",    observacao: "Abastecimento de água" },
      { id: 7, vesselId: 2, companyId: null, data: "2026-02-18", tipoFluido: "agua", quantidade: 1500, valorUnitario: 0,   valorTotal: 0,      quantidadeAntes: 500,  quantidadeSolicitada: 1500, quantidadeBordo: 2000,  tipoOperacao: "compra",    observacao: "" }
    ],
    nextId: { supplies: 8, companies: 4, vessels: 13, consumoOp: 1, users: 2, solicitacoes: 1 },
    users: [
      { id: 1, nome: 'Administrador', username: 'admin', pwdHash: 'YWRtaW4lM0ExMjM0NTY=', perfil: 'admin', embarcacoes: 'all', ativo: true, criadoEm: '2026-01-01', ultimoLogin: null }
    ],
    solicitacoes: []
  };

  let DB = JSON.parse(JSON.stringify(INITIAL_DB));
  if (!DB.consumoOp) DB.consumoOp = [];
  let charts = {};
  let currentDashboard = 'dashboard';
  let loggedIn = false;
  let currentUser = null; // { id, nome, username, perfil, embarcacoes }
  let config = {
    defaultDensity: 0.85,
    darkMode: false,
    autoSave: false,
    rowsPerPage: { supplies: 10, companies: 10, vessels: 10 }
  };

  let suppliesPage = 1, suppliesSearch = '', suppliesSort = { column: 'data', direction: 'desc' };
  let companiesPage = 1, companiesSearch = '', companiesSort = { column: 'name', direction: 'asc' };
  let vesselsPage = 1, vesselsSearch = '', vesselsSort = { column: 'name', direction: 'asc' };
  let currentEditSupply = null, currentEditCompany = null, currentEditVessel = null;

  // =====================================================================
  //  UTILITÁRIOS
  // =====================================================================
  function validarCNPJ(cnpj) {
    cnpj = cnpj.replace(/[^\d]+/g, '');
    if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
    let t = cnpj.length - 2, n = cnpj.substring(0, t), d = cnpj.substring(t), s = 0, p = t - 7;
    for (let i = t; i >= 1; i--) { s += n.charAt(t - i) * p--; if (p < 2) p = 9; }
    let r = s % 11 < 2 ? 0 : 11 - (s % 11);
    if (r != d.charAt(0)) return false;
    t = t + 1; n = cnpj.substring(0, t); s = 0; p = t - 7;
    for (let i = t; i >= 1; i--) { s += n.charAt(t - i) * p--; if (p < 2) p = 9; }
    r = s % 11 < 2 ? 0 : 11 - (s % 11);
    return r == d.charAt(1);
  }

  function validarDataNaoFutura(data) {
    return data <= new Date().toISOString().split('T')[0];
  }

  function formatMoney(v) {
    if (isNaN(v)) v = 0;
    return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  // Retorna a posição (quantidadeBordo) mais recente para a embarcação + fluido
  // passagem_saida é INCLUÍDA pois contém o quantidadeBordo correto pós-transferência
  function getPosicaoAtual(vesselId, tipoFluido) {
    const fluid = tipoFluido || 'oleo';
    const lista = DB.supplies
      .filter(s => s.vesselId === vesselId &&
                   (fluid === 'oleo' ? (s.tipoFluido === 'oleo' || !s.tipoFluido) : s.tipoFluido === fluid))
      .sort((a, b) => b.data.localeCompare(a.data) || b.id - a.id);
    return lista.length ? Math.max(0, lista[0].quantidadeBordo || 0) : 0;
  }

  function getCapacidade(vesselId, tipoFluido) {
    const v = DB.vessels.find(x => x.id === vesselId);
    if (!v) return Infinity;
    if (tipoFluido === 'agua') return (v.capacidadeAgua || 0) * 1000;
    return (v.capacidadeOleo || v.capacidade || 0) * 1000;
  }

  function toast(message, type = 'success', duration = 3200) {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `<i class="fas ${icons[type] || 'fa-info-circle'}"></i><span>${message}</span><div class="toast-progress"></div>`;
    document.body.appendChild(el);
    setTimeout(() => { el.style.transition = 'all 0.25s'; el.style.opacity = '0'; el.style.transform = 'translateX(12px)'; setTimeout(() => el.remove(), 260); }, duration);
  }

  function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
  }

  // =====================================================================
  //  STORAGE
  // =====================================================================
  function loadFromStorage() {
    try {
      const saved = localStorage.getItem('navcontrol_db');
      if (saved) {
        DB = JSON.parse(saved);
        if (!DB.nextId) {
          const safeMax = arr => arr.length ? Math.max(...arr.map(x => x.id || 0)) + 1 : 1;
          DB.nextId = { supplies: safeMax(DB.supplies), companies: safeMax(DB.companies), vessels: safeMax(DB.vessels) };
        }
        // migrate consumoOp table
        if (!DB.consumoOp) DB.consumoOp = [];
        if (!DB.nextId.consumoOp) DB.nextId.consumoOp = (DB.consumoOp.length ? Math.max(...DB.consumoOp.map(x=>x.id||0))+1 : 1);
        // migrate legacy consumoOp records that have no linked supply deduction entries
        DB.consumoOp.forEach(r => {
          const hasSupply = DB.supplies.some(s => s.consumoOpId === r.id && s.tipoOperacao === 'consumo_op');
          if (!hasSupply) {
            const obs = `Consumo operacional${r.observacao ? ': '+r.observacao : ''}`;
            if ((r.qtdOleo||0) > 0) {
              DB.supplies.push({ id: DB.nextId.supplies++, consumoOpId: r.id, vesselId: r.vesselId,
                companyId: null, data: r.data, tipoFluido: 'oleo', tipoOperacao: 'consumo_op',
                quantidade: r.qtdOleo, quantidadeAntes: 0, quantidadeSolicitada: r.qtdOleo,
                quantidadeBordo: 0, valorUnitario: 0, valorTotal: 0, observacao: obs });
            }
            if ((r.qtdAgua||0) > 0) {
              DB.supplies.push({ id: DB.nextId.supplies++, consumoOpId: r.id, vesselId: r.vesselId,
                companyId: null, data: r.data, tipoFluido: 'agua', tipoOperacao: 'consumo_op',
                quantidade: r.qtdAgua, quantidadeAntes: 0, quantidadeSolicitada: r.qtdAgua,
                quantidadeBordo: 0, valorUnitario: 0, valorTotal: 0, observacao: obs });
            }
          }
        });
        // migrate old vessels without separate capacities
        DB.vessels.forEach(v => {
          if (v.capacidadeOleo === undefined) v.capacidadeOleo = v.capacidade || 14;
          if (v.capacidadeAgua === undefined) v.capacidadeAgua = 5;
        });
        // migrate old supplies without tipoFluido
        DB.supplies.forEach(s => { if (!s.tipoFluido) s.tipoFluido = 'oleo'; });
        // migrate: users e solicitacoes
        if (!DB.users) {
          DB.users = [{ id: 1, nome: 'Administrador', username: 'admin', pwdHash: 'YWRtaW4lM0ExMjM0NTY=', perfil: 'admin', embarcacoes: 'all', ativo: true, criadoEm: '2026-01-01', ultimoLogin: null }];
        }
        if (!DB.solicitacoes) DB.solicitacoes = [];
        if (!DB.nextId.users) DB.nextId.users = (DB.users.length ? Math.max(...DB.users.map(x=>x.id||0))+1 : 2);
        // Migrar hash antigo (btoa sem encodeURIComponent) para novo formato
        const OLD_ADMIN_HASH = btoa('admin:123456');
        const NEW_ADMIN_HASH = 'YWRtaW4lM0ExMjM0NTY=';
        DB.users.forEach(u => {
          if (u.pwdHash === OLD_ADMIN_HASH) u.pwdHash = NEW_ADMIN_HASH;
        });
        if (!DB.nextId.solicitacoes) DB.nextId.solicitacoes = (DB.solicitacoes.length ? Math.max(...DB.solicitacoes.map(x=>x.id||0))+1 : 1);
      }
      const savedCfg = localStorage.getItem('navcontrol_config');
      if (savedCfg) { const p = JSON.parse(savedCfg); config = { ...config, ...p }; config.rowsPerPage = { ...config.rowsPerPage, ...(p.rowsPerPage || {}) }; }
    } catch(e) { console.error('[NavControl] loadFromStorage:', e); }
  }

  function saveToStorage() {
    localStorage.setItem('navcontrol_db', JSON.stringify(DB));
    localStorage.setItem('navcontrol_config', JSON.stringify(config));
  }

  function resetDatabase() {
    if (!confirm('Restaurar base de demonstração? Todos os dados serão substituídos.')) return;
    DB = JSON.parse(JSON.stringify(INITIAL_DB));
    if (!DB.consumoOp) DB.consumoOp = [];
    if (!DB.nextId.consumoOp) DB.nextId.consumoOp = 1;
    if (!DB.nextId.solicitacoes) DB.nextId.solicitacoes = 1;
    saveToStorage();
    toast('Base restaurada!', 'success');
    renderDashboard(currentDashboard);
  }

  function clearAllData() {
    if (!confirm('Apagar TODOS os dados? Ação irreversível.')) return;
    DB.supplies = []; DB.companies = []; DB.vessels = [];
    DB.consumoOp = []; DB.solicitacoes = [];
    DB.nextId = { supplies: 1, companies: 1, vessels: 1, consumoOp: 1, users: DB.nextId?.users||2, solicitacoes: 1 };
    saveToStorage();
    toast('Dados apagados!', 'success');
    renderDashboard(currentDashboard);
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    config.darkMode = document.body.classList.contains('dark-mode');
    document.getElementById('darkModeIcon').className = config.darkMode ? 'fas fa-sun' : 'fas fa-moon';
    saveToStorage();
  }

  // =====================================================================
  //  AUTH

  // =====================================================================
  //  SISTEMA DE PERMISSÕES
  // =====================================================================
  function _hashPwd(username, senha) {
    // btoa puro falha com acentos. encodeURIComponent torna seguro para base64.
    try { return btoa(encodeURIComponent(username + ':' + senha)); }
    catch(e) { return btoa(unescape(encodeURIComponent(username + ':' + senha))); }
  }

  function isAdmin() { return currentUser?.perfil === 'admin'; }

  function renderPermBlock(container, nome) {
    container.innerHTML = `<div class="card"><div class="perm-block"><i class="fas fa-lock"></i><h3>Acesso Restrito</h3><p>A seção <strong>${nome}</strong> é exclusiva para administradores.<br>Se precisar de algo, utilize o menu <em>Solicitações</em> para enviar um pedido ao administrador.</p></div></div>`;
  }

  function podeVerEmbarcacao(vesselId) {
    if (isAdmin()) return true;
    if (!currentUser) return false;
    if (currentUser.embarcacoes === 'all') return true;
    return Array.isArray(currentUser.embarcacoes) && currentUser.embarcacoes.includes(Number(vesselId));
  }

  function minhasEmbarcacoes() {
    if (isAdmin()) return DB.vessels;
    return DB.vessels.filter(v => podeVerEmbarcacao(v.id));
  }

  // Retorna os supplies visíveis para o usuário corrente
  function minhasSupplies() {
    const vIds = new Set(minhasEmbarcacoes().map(v => v.id));
    return DB.supplies.filter(s => vIds.has(s.vesselId));
  }

  function guardaAdmin(fn) {
    if (!isAdmin()) { toast('Acesso restrito ao administrador.', 'error'); return; }
    fn();
  }

  function solicitarCorrecao(tipo, refId, refDesc) {
    openSolicitacaoModal(tipo, refId, refDesc);
  }

  // =====================================================================


  // =====================================================================
  //  SIDEBAR DINÂMICA
  // =====================================================================
  function renderSidebar() {
    if (!currentUser) return;
    const av = document.getElementById('sidebarAvatar');
    const nm = document.getElementById('sidebarName');
    const rl = document.getElementById('sidebarRole');
    const initials = currentUser.nome.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    if (av) av.textContent = initials;
    if (nm) nm.textContent = currentUser.nome;
    if (rl) rl.textContent = currentUser.perfil === 'admin' ? 'Administrador' : 'Operador';

    const admin = isAdmin();
    const pendentes = (DB.solicitacoes||[]).filter(r=>r.status==='pendente').length;
    const reqBadgeHtml = admin && pendentes > 0
      ? `<span id="reqAlertBadge" class="nav-badge">${pendentes}</span>`
      : `<span id="reqAlertBadge" class="nav-badge" style="display:none"></span>`;

    const nav = document.getElementById('sidebarNav');
    if (!nav) return;
    nav.innerHTML = `
      <div class="nav-section">PRINCIPAL</div>
      <div class="nav-item" onclick="changeDashboard('dashboard')"><i class="fas fa-chart-line"></i><span>Dashboard</span></div>
      <div class="nav-section">OPERAÇÕES</div>
      <div class="nav-item" onclick="changeDashboard('supplies')"><i class="fas fa-list"></i><span>Registros</span></div>
      <div class="nav-item" onclick="changeDashboard('stock')"><i class="fas fa-warehouse"></i><span>Posição de Estoque</span><span id="stockAlertBadge" style="display:none;margin-left:auto;border-radius:10px;font-size:10px;font-weight:700;padding:1px 7px;background:var(--danger);color:#fff;"></span></div>
      ${admin ? `
      <div class="nav-item" onclick="changeDashboard('companies')"><i class="fas fa-building"></i><span>Empresas</span></div>
      <div class="nav-item" onclick="changeDashboard('vessels')"><i class="fas fa-ship"></i><span>Embarcações</span></div>` : ''}
      <div class="nav-section">MOVIMENTAÇÕES</div>
      <div class="nav-item" onclick="changeDashboard('logs')"><i class="fas fa-history"></i><span>Logs</span></div>
      <div class="nav-item" onclick="changeDashboard('consumoOp')"><i class="fas fa-fire"></i><span>Consumo Operacional</span></div>
      <div class="nav-section">RELATÓRIOS</div>
      <div class="nav-item" onclick="changeDashboard('consumption')"><i class="fas fa-chart-bar"></i><span>Consumo</span></div>
      <div class="nav-item" onclick="changeDashboard('comparative')"><i class="fas fa-balance-scale"></i><span>Comparativo</span></div>
      <div class="nav-item" onclick="changeDashboard('relatorio')"><i class="fas fa-file-pdf"></i><span>Relatório PDF</span></div>
      <div class="nav-section">FERRAMENTAS</div>
      <div class="nav-item" onclick="changeDashboard('memorial')"><i class="fas fa-calculator"></i><span>Memorial</span></div>
      <div class="nav-item" onclick="changeDashboard('evolution')"><i class="fas fa-chart-area"></i><span>Evolução</span></div>
      ${admin ? `
      <div class="nav-section">DADOS</div>
      <div class="nav-item" onclick="changeDashboard('import')"><i class="fas fa-file-import"></i><span>Importar</span></div>
      <div class="nav-item" onclick="changeDashboard('export')"><i class="fas fa-file-export"></i><span>Exportar</span></div>
      <div class="nav-item" onclick="changeDashboard('backup')"><i class="fas fa-database"></i><span>Backup</span></div>
      <div class="nav-section">SISTEMA</div>
      <div class="nav-item" onclick="changeDashboard('settings')"><i class="fas fa-cog"></i><span>Configurações</span></div>
      <div class="nav-item" onclick="changeDashboard('users')"><i class="fas fa-users-cog"></i><span>Gestão de Usuários</span></div>
      <div class="nav-item" onclick="changeDashboard('solicitacoes')"><i class="fas fa-bell"></i><span>Solicitações</span>${reqBadgeHtml}</div>
      ` : `
      <div class="nav-section">SISTEMA</div>
      <div class="nav-item" onclick="changeDashboard('solicitacoes')"><i class="fas fa-paper-plane"></i><span>Minhas Solicitações</span></div>
      `}
    `;
  }

  // =====================================================================
  //  MODAL SOLICITAÇÃO DE CORREÇÃO
  // =====================================================================
  function openSolicitacaoModal(tipo, refId, refDesc) {
    const existingModal = document.getElementById('solicitacaoModal');
    if (existingModal) existingModal.remove();
    const m = document.createElement('div');
    m.id = 'solicitacaoModal';
    m.className = 'modal-overlay show';
    m.innerHTML = `
      <div class="modal" style="max-width:500px;">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-paper-plane"></i> Solicitar Correção</h3>
          <button class="modal-close" onclick="document.getElementById('solicitacaoModal').remove()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div class="info-box" style="margin-bottom:16px;">
            <i class="fas fa-info-circle"></i>
            <div><strong>Referência:</strong> ${refDesc || tipo + ' #' + refId}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Descreva o problema e a correção necessária *</label>
            <textarea class="form-control" id="solicitacaoTexto" rows="4" placeholder="Ex: O valor unitário foi digitado como 5,80 mas era 5,08. Solicito a correção desta entrada." style="resize:vertical"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Urgência</label>
            <select class="form-control" id="solicitacaoUrgencia">
              <option value="normal">Normal</option>
              <option value="alta">Alta</option>
              <option value="critica">Crítica</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="document.getElementById('solicitacaoModal').remove()">Cancelar</button>
          <button class="btn btn-primary" onclick="enviarSolicitacao('${tipo}', ${refId})">
            <i class="fas fa-paper-plane"></i> Enviar Solicitação
          </button>
        </div>
      </div>`;
    document.body.appendChild(m);
    m.addEventListener('click', e => { if (e.target === m) m.remove(); });
    setTimeout(() => document.getElementById('solicitacaoTexto')?.focus(), 100);
  }

  function enviarSolicitacao(tipo, refId) {
    refId = Number(refId);
    const texto = document.getElementById('solicitacaoTexto')?.value.trim();
    const urgencia = document.getElementById('solicitacaoUrgencia')?.value || 'normal';
    if (!texto) { toast('Descreva o problema antes de enviar.', 'error'); return; }
    if (!DB.solicitacoes) DB.solicitacoes = [];
    if (!DB.nextId.solicitacoes) DB.nextId.solicitacoes = 1;
    DB.solicitacoes.push({
      id: DB.nextId.solicitacoes++,
      tipo, refId: Number(refId),
      texto, urgencia,
      status: 'pendente',
      usuarioId: currentUser.id,
      usuarioNome: currentUser.nome,
      criadoEm: new Date().toISOString(),
      resolvidoEm: null,
      resolvidoPor: null,
      notaAdmin: null
    });
    saveToStorage();
    document.getElementById('solicitacaoModal')?.remove();
    renderSidebar();
    _atualizarSidebarAlerts();
    toast('Solicitação enviada ao administrador!', 'success');
  }

  // =====================================================================
  function login() {
    const uname = document.getElementById('username').value.trim().toLowerCase();
    const pwd   = document.getElementById('password').value;
    loadFromStorage();
    if (!DB.users) DB.users = [];
    const user = DB.users.find(u => u.username.toLowerCase() === uname && u.ativo !== false);
    if (!user || user.pwdHash !== _hashPwd(uname, pwd)) {
      toast('Usuário ou senha inválidos!', 'error');
      document.getElementById('password').value = '';
      return;
    }
    // Atualizar ultimoLogin
    user.ultimoLogin = new Date().toISOString();
    saveToStorage();

    currentUser = { id: user.id, nome: user.nome, username: user.username, perfil: user.perfil, embarcacoes: user.embarcacoes };
    loggedIn = true;

    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    if (config.darkMode) document.body.classList.add('dark-mode');

    renderSidebar();
    renderDashboard('dashboard');
    inicializarAutoSaveAposLogin();
    toast(`Bem-vindo, ${user.nome}!`, 'success');
  }

  function logout() {
    if (!confirm('Deseja sair?')) return;
    pararAutoSave();
    loggedIn = false;
    currentUser = null;
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appContainer').style.display = 'none';
    // Limpar campos de login para segurança
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
  }

  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('collapsed');
    document.getElementById('mainContent').classList.toggle('expanded');
  }

  // =====================================================================
  //  ROUTING
  // =====================================================================
  function changeDashboard(dashboard) {
    if (!loggedIn) return;
    currentDashboard = dashboard;
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    const active = Array.from(document.querySelectorAll('.nav-item')).find(i => i.getAttribute('onclick')?.includes(`'${dashboard}'`));
    if (active) active.classList.add('active');
    renderDashboard(dashboard);
  }

  function renderDashboard(type) {
    const content = document.getElementById('dashboardContent');
    if (!content) return;
    Object.values(charts).forEach(c => { if (c) c.destroy(); });
    charts = {};
    content.innerHTML = '';
    const map = {
      dashboard:      renderMainDashboard,
      supplies:       renderSupplies,
      stock:          renderStockPosition,
      companies:      renderCompanies,
      vessels:        renderVessels,
      logs:           renderLogs,
      consumption:    renderConsumption,
      comparative:    renderComparative,
      memorial:       renderMemorial,
      evolution:      renderEvolution,
      consumoOp:      renderConsumoOp,
      relatorio:      renderRelatorio,
      import:         (c) => { if (!isAdmin()) { renderPermBlock(c, 'Importar Dados'); return; } renderImport(c); },
      export:         (c) => { if (!isAdmin()) { renderPermBlock(c, 'Exportar Dados'); return; } renderExport(c); },
      backup:         (c) => { if (!isAdmin()) { renderPermBlock(c, 'Backup e Restauração'); return; } renderBackup(c); },
      settings:       (c) => { if (!isAdmin()) { renderPermBlock(c, 'Configurações do Sistema'); return; } renderSettings(c); },
      users:          renderUsers,
      solicitacoes:   renderSolicitacoes,
    };
    if (map[type]) map[type](content);
    const titles = {
      dashboard: ["Dashboard","Visão geral dos abastecimentos"],
      supplies:  ["Registros de Abastecimento","Histórico completo"],
      stock:     ["Posição de Estoque","Estoque atual por embarcação — óleo e água"],
      companies: ["Empresas Fornecedoras","Cadastro"],
      vessels:   ["Embarcações","Frota e capacidades"],
      logs:      ["Logs de Movimentação","Todas as operações"],
      consumption:["Análise de Consumo","Total abastecido por embarcação"],
      comparative:["Comparativo Aço vs Madeira","Análise por tipo de casco"],
      consumoOp:  ["Consumo Operacional","Lançamento de óleo e água consumidos por embarcação"],
      relatorio:  ["Relatório Naval PDF","Filtro por embarcação e data — saída para auditoria"],
      memorial:   ["Memorial de Cálculo","Conversão de unidades"],
      evolution: ["Evolução do Consumo","Consumo ao longo do tempo"],
      import:    ["Importar Dados","Planilhas Excel/CSV"],
      export:    ["Exportar Dados","Relatórios e templates"],
      backup:         ["Backup e Restauração","Salvar/carregar base"],
      settings:       ["Configurações","Preferências do sistema"],
      users:          ["Gestão de Usuários","Cadastro de operadores e controle de acesso por embarcação"],
      solicitacoes:   ["Solicitações de Correção","Pedidos enviados pelos operadores"],
    };
    const t = titles[type] || ["Dashboard",""];
    document.getElementById('dashboardTitle').innerText = t[0];
    document.getElementById('dashboardDesc').innerText = t[1];
    _atualizarSidebarAlerts();
  }

  function _atualizarSidebarAlerts() {
    try {
      const badge = document.getElementById('stockAlertBadge');
      if (!badge) return;
      const crit = config.alertCritical || 20;
      const warn = config.alertWarning || 40;
      let nCrit = 0, nWarn = 0;
      minhasEmbarcacoes().forEach(v => {
        const posO = getPosicaoAtual(v.id, 'oleo'), capO = (v.capacidadeOleo||v.capacidade||0)*1000;
        const posA = getPosicaoAtual(v.id, 'agua'), capA = (v.capacidadeAgua||0)*1000;
        const pO = capO > 0 ? posO/capO*100 : 100, pA = capA > 0 ? posA/capA*100 : 100;
        if (pO < crit || pA < crit) nCrit++;
        else if (pO < warn || pA < warn) nWarn++;
      });
      if (nCrit > 0) { badge.style.display='inline-block'; badge.style.background='var(--danger)'; badge.textContent=nCrit; }
      else if (nWarn > 0) { badge.style.display='inline-block'; badge.style.background='var(--warning)'; badge.textContent=nWarn; }
      else { badge.style.display='none'; }
      // Badge de solicitações pendentes (admin)
      const reqBadge = document.getElementById('reqAlertBadge');
      if (reqBadge && isAdmin()) {
        const pendentes = (DB.solicitacoes||[]).filter(r=>r.status==='pendente').length;
        if (pendentes > 0) { reqBadge.style.display='inline-block'; reqBadge.textContent=pendentes; }
        else { reqBadge.style.display='none'; }
      }
    } catch(e) {}
  }

  // =====================================================================
  //  DASHBOARD PRINCIPAL
  // =====================================================================
  function getAlertasEstoque() {
    const crit = config.alertCritical || 20, warn = config.alertWarning || 40;
    const criticos = [], avisos = [];
    minhasEmbarcacoes().forEach(v => {
      const pO = (v.capacidadeOleo||v.capacidade||0)*1000 > 0 ? getPosicaoAtual(v.id,'oleo')/((v.capacidadeOleo||v.capacidade||0)*1000)*100 : 100;
      const pA = (v.capacidadeAgua||0)*1000 > 0 ? getPosicaoAtual(v.id,'agua')/((v.capacidadeAgua||0)*1000)*100 : 100;
      if (pO < crit || pA < crit) criticos.push(v);
      else if (pO < warn || pA < warn) avisos.push(v);
    });
    return { criticos, avisos };
  }

  function renderMainDashboard(container) {
    const _myVIds = new Set(minhasEmbarcacoes().map(v=>v.id));
    const oleoCmpras = DB.supplies.filter(s => s.tipoFluido === 'oleo' && s.tipoOperacao === 'compra' && s.quantidade > 0 && _myVIds.has(s.vesselId));
    const aguaRecs   = DB.supplies.filter(s => s.tipoFluido === 'agua' && s.tipoOperacao === 'compra' && s.quantidade > 0 && _myVIds.has(s.vesselId));
    const totalOleo  = oleoCmpras.reduce((s, r) => s + r.quantidade, 0);
    const totalAgua  = aguaRecs.reduce((s, r) => s + r.quantidade, 0);
    const totalGasto = oleoCmpras.reduce((s, r) => s + (r.valorTotal || 0), 0);
    const mediaPreco = totalOleo > 0 ? totalGasto / totalOleo : 0;
    const { criticos, avisos } = getAlertasEstoque();

    const ultimos = DB.supplies.filter(s => s.quantidade > 0 && s.tipoOperacao !== 'passagem_saida' && _myVIds.has(s.vesselId))
      .sort((a, b) => b.data.localeCompare(a.data) || b.id - a.id).slice(0, 6);

    let alertaHtml = '';
    if (criticos.length > 0) {
      alertaHtml = `<div class="alert-banner alert-banner-critical"><i class="fas fa-exclamation-triangle"></i><strong>${criticos.length} embarcação(ões) com estoque crítico (&lt;${config.alertCritical||20}%):</strong> ${criticos.map(v=>`<span style="font-weight:700">${v.sigla}</span>`).join(', ')}<button class="btn btn-sm" style="margin-left:auto;background:var(--danger);color:#fff" onclick="changeDashboard('stock')">Ver Estoque</button></div>`;
    } else if (avisos.length > 0) {
      alertaHtml = `<div class="alert-banner alert-banner-warning"><i class="fas fa-exclamation-circle"></i><strong>${avisos.length} embarcação(ões) com estoque baixo (&lt;${config.alertWarning||40}%):</strong> ${avisos.map(v=>`<span style="font-weight:700">${v.sigla}</span>`).join(', ')}<button class="btn btn-sm" style="margin-left:auto;background:var(--warning);color:#fff" onclick="changeDashboard('stock')">Ver Estoque</button></div>`;
    }

    const kpiAlertLabel = criticos.length > 0
      ? `<span style="color:var(--danger);font-weight:700">${criticos.length} com estoque crítico</span>`
      : avisos.length > 0
      ? `<span style="color:var(--warning);font-weight:700">${avisos.length} com estoque baixo</span>`
      : `${new Set(DB.supplies.filter(s=>s.quantidade>0).map(s=>s.vesselId)).size} abastecidas`;

    container.innerHTML = alertaHtml + `
      <div class="kpi-grid">
        <div class="kpi-card kpi-card-oleo">
          <div class="kpi-icon kpi-icon-oleo"><i class="fas fa-oil-can"></i></div>
          <div class="kpi-label">Total Óleo Abastecido</div>
          <div class="kpi-value">${totalOleo.toLocaleString()} L</div>
          <div class="kpi-trend">${oleoCmpras.length} compras</div>
        </div>
        <div class="kpi-card kpi-card-agua">
          <div class="kpi-icon kpi-icon-agua"><i class="fas fa-tint"></i></div>
          <div class="kpi-label">Total Água Abastecida</div>
          <div class="kpi-value">${totalAgua.toLocaleString()} L</div>
          <div class="kpi-trend">${aguaRecs.length} registros</div>
        </div>
        <div class="kpi-card kpi-card-neutral">
          <div class="kpi-icon kpi-icon-neutral"><i class="fas fa-dollar-sign"></i></div>
          <div class="kpi-label">Total Gasto (Óleo)</div>
          <div class="kpi-value">${formatMoney(totalGasto)}</div>
          <div class="kpi-trend">Preço médio pond.: ${formatMoney(mediaPreco)}/L</div>
        </div>
        <div class="kpi-card kpi-card-neutral" style="cursor:pointer" onclick="changeDashboard('stock')">
          <div class="kpi-icon kpi-icon-success"><i class="fas fa-ship"></i></div>
          <div class="kpi-label">Embarcações ${criticos.length>0?`<span class="stock-alert-badge">${criticos.length}</span>`:avisos.length>0?`<span class="stock-alert-badge warning">${avisos.length}</span>`:''}</div>
          <div class="kpi-value">${DB.vessels.length}</div>
          <div class="kpi-trend">${kpiAlertLabel}</div>
        </div>
      </div>
      <div class="chart-grid">
        <div class="chart-card"><div class="card-header"><h3>Estoque de Óleo por Embarcação</h3></div><div class="chart-container"><canvas id="chartStockOleo"></canvas></div></div>
        <div class="chart-card"><div class="card-header"><h3>Estoque de Água por Embarcação</h3></div><div class="chart-container"><canvas id="chartStockAgua"></canvas></div></div>
      </div>
      <div class="chart-grid">
        <div class="chart-card"><div class="card-header"><h3>Gasto por Empresa (Óleo)</h3></div><div class="chart-container"><canvas id="chartEmpresa"></canvas></div></div>
        <div class="chart-card"><div class="card-header"><h3>Custo Mensal de Óleo (R$)</h3></div><div class="chart-container"><canvas id="chartMensal"></canvas></div></div>
      </div>
      <div class="table-container">
        <div class="table-header"><h3>Últimos Abastecimentos</h3><button class="btn btn-outline btn-sm" onclick="changeDashboard('supplies')">Ver todos</button></div>
        <div class="table-responsive"><table>
          <thead><tr><th>Data</th><th>Embarcação</th><th>Fluido</th><th>Tipo Op.</th><th>Antes (L)</th><th>Solicitado (L)</th><th>Abastecido (L)</th><th>Após (L)</th><th>Valor Total</th></tr></thead>
          <tbody>${ultimos.map(s => {
            const v = DB.vessels.find(x => x.id === s.vesselId);
            return `<tr>
              <td>${new Date(s.data+'T12:00:00').toLocaleDateString('pt-BR')}</td>
              <td><span class="pill ${v?.material==='Aço'?'pill-aco':'pill-madeira'}">${v?.sigla||'-'}</span></td>
              <td><span class="pill ${s.tipoFluido==='agua'?'pill-agua':'pill-oleo'}">${s.tipoFluido==='agua'?'💧 Água':'🛢 Óleo'}</span></td>
              <td><span class="pill ${s.tipoOperacao==='compra'?'pill-compra':'pill-passagem'}">${s.tipoOperacao==='compra'?'Compra':s.tipoOperacao==='passagem_saida'?'Pass. saída':'Pass. entrada'}</span></td>
              <td>${(s.quantidadeAntes||0).toLocaleString()}</td>
              <td>${(s.quantidadeSolicitada||0).toLocaleString()}</td>
              <td>${s.quantidade.toLocaleString()}</td>
              <td>${(s.quantidadeBordo||0).toLocaleString()}</td>
              <td>${s.valorTotal ? formatMoney(s.valorTotal) : '—'}</td>
            </tr>`;
          }).join('')}</tbody>
        </table></div>
      </div>
    `;
    setTimeout(() => {
      _chartStockOleo();
      _chartStockAgua();
      _chartEmpresa();
      _chartMensal();
    }, 80);
  }

  function _chartStockOleo() {
    const crit = config.alertCritical||20, warn = config.alertWarning||40;
    const labels=[], data=[], colors=[];
    DB.vessels.forEach(v => {
      const pos = getPosicaoAtual(v.id,'oleo'), cap = (v.capacidadeOleo||v.capacidade||0)*1000;
      const pct = cap > 0 ? pos/cap*100 : 100;
      labels.push(v.sigla); data.push(pos);
      colors.push(pct < crit ? 'rgba(220,38,38,0.75)' : pct < warn ? 'rgba(217,119,6,0.75)' : 'rgba(14,165,233,0.75)');
    });
    const ctx = document.getElementById('chartStockOleo')?.getContext('2d');
    if (!ctx) return;
    if (charts.stockOleo) charts.stockOleo.destroy();
    charts.stockOleo = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Óleo (L)', data, backgroundColor:colors, borderRadius:5 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Litros' } } } } });
  }

  function _chartStockAgua() {
    const crit = config.alertCritical||20, warn = config.alertWarning||40;
    const labels=[], data=[], colors=[];
    DB.vessels.forEach(v => {
      const pos = getPosicaoAtual(v.id,'agua'), cap = (v.capacidadeAgua||0)*1000;
      const pct = cap > 0 ? pos/cap*100 : 100;
      labels.push(v.sigla); data.push(pos);
      colors.push(pct < crit ? 'rgba(220,38,38,0.75)' : pct < warn ? 'rgba(217,119,6,0.75)' : 'rgba(6,182,212,0.75)');
    });
    const ctx = document.getElementById('chartStockAgua')?.getContext('2d');
    if (!ctx) return;
    if (charts.stockAgua) charts.stockAgua.destroy();
    charts.stockAgua = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Água (L)', data, backgroundColor:colors, borderRadius:5 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Litros' } } } } });
  }

  function _chartEmpresa() {
    const gasto = {};
    DB.supplies.filter(s => s.tipoOperacao==='compra' && s.tipoFluido==='oleo').forEach(s => { gasto[s.companyId] = (gasto[s.companyId]||0) + (s.valorTotal||0); });
    const labels=[], data=[];
    Object.keys(gasto).forEach(cid => { const c = DB.companies.find(c => c.id===parseInt(cid)); if(c){ labels.push(c.name.split(' ')[0]); data.push(gasto[cid]); } });
    const ctx = document.getElementById('chartEmpresa')?.getContext('2d');
    if (!ctx) return;
    if (charts.empresa) charts.empresa.destroy();
    charts.empresa = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data, backgroundColor:['#1e3a5f','#2563eb','#059669','#d97706','#dc2626'], borderWidth:2, borderColor:'#fff' }] }, options:{ cutout:'65%', plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label:c => `${c.label}: ${formatMoney(c.raw)}` } } } } });
  }

  function _chartMensal() {
    const monthly = {};
    DB.supplies.filter(s => s.tipoOperacao==='compra' && s.tipoFluido==='oleo' && s.valorTotal > 0).forEach(s => {
      const m = s.data.substring(0,7); monthly[m] = (monthly[m]||0) + s.valorTotal;
    });
    const months = Object.keys(monthly).sort().slice(-12);
    const ctx = document.getElementById('chartMensal')?.getContext('2d');
    if (!ctx) return;
    if (charts.mensal) charts.mensal.destroy();
    charts.mensal = new Chart(ctx, { type:'bar', data:{ labels:months, datasets:[{ label:'R$', data:months.map(m=>monthly[m]), backgroundColor:'rgba(37,99,235,0.65)', borderRadius:4 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:c => formatMoney(c.raw) } } }, scales:{ y:{ beginAtZero:true, ticks:{ callback:v => formatMoney(v) } } } } });
  }

  // =====================================================================
  //  POSIÇÃO DE ESTOQUE
  // =====================================================================
  function renderStockPosition(container) {
    const totalOleoL = minhasEmbarcacoes().reduce((s, v) => s + getPosicaoAtual(v.id, 'oleo'), 0);
    const totalAguaL = minhasEmbarcacoes().reduce((s, v) => s + getPosicaoAtual(v.id, 'agua'), 0);
    const capOleoTotal = minhasEmbarcacoes().reduce((s, v) => s + (v.capacidadeOleo || 0) * 1000, 0);
    const capAguaTotal = minhasEmbarcacoes().reduce((s, v) => s + (v.capacidadeAgua || 0) * 1000, 0);
    const pctOleo = capOleoTotal > 0 ? (totalOleoL / capOleoTotal * 100).toFixed(1) : 0;
    const pctAgua = capAguaTotal > 0 ? (totalAguaL / capAguaTotal * 100).toFixed(1) : 0;

    const cardsHtml = minhasEmbarcacoes().map(v => {
      const posOleo = getPosicaoAtual(v.id, 'oleo');
      const posAgua = getPosicaoAtual(v.id, 'agua');
      const capOleo = (v.capacidadeOleo || 0) * 1000;
      const capAgua = (v.capacidadeAgua || 0) * 1000;
      const pctO = capOleo > 0 ? Math.min(100, posOleo / capOleo * 100) : 0;
      const pctA = capAgua > 0 ? Math.min(100, posAgua / capAgua * 100) : 0;
      const crit = config.alertCritical||20, warn = config.alertWarning||40;
      const lastOleo = DB.supplies.filter(s => s.vesselId === v.id && (s.tipoFluido === 'oleo' || !s.tipoFluido)).sort((a,b) => b.data.localeCompare(a.data) || b.id - a.id)[0];
      const lastAgua = DB.supplies.filter(s => s.vesselId === v.id && s.tipoFluido === 'agua').sort((a,b) => b.data.localeCompare(a.data) || b.id - a.id)[0];
      const isCrit = pctO < crit || pctA < crit;
      const isWarn = !isCrit && (pctO < warn || pctA < warn);
      const borderColor = isCrit ? 'var(--danger)' : isWarn ? 'var(--warning)' : 'var(--border-color)';
      return `
        <div class="stock-vessel-card" style="border-color:${borderColor}">
          <div class="stock-vessel-header">
            <span class="stock-vessel-name">${v.name}</span>
            <span class="pill ${v.material==='Aço'?'pill-aco':'pill-madeira'}" style="font-size:10px;">${v.sigla}</span>
          </div>
          <div class="stock-vessel-body">
            <div class="stock-fluid-row">
              <div class="stock-fluid-label">
                <span class="text-oleo"><i class="fas fa-oil-can"></i> Óleo</span>
                <span class="qty">${posOleo.toLocaleString()} / ${capOleo.toLocaleString()} L</span>
              </div>
              <div class="progress-bar"><div class="progress-fill-oleo ${pctO<crit?'critical':pctO<warn?'warning':''}" style="width:${pctO}%"></div></div>
              <div class="pct-label" style="${pctO<crit?'color:var(--danger);font-weight:600':pctO<warn?'color:var(--warning);font-weight:600':''}">${pctO.toFixed(1)}%${pctO<crit?' ⚠ CRÍTICO':pctO<warn?' ⚠ baixo':''} ${lastOleo ? '· '+new Date(lastOleo.data+'T12:00:00').toLocaleDateString('pt-BR') : '· sem registro'}</div>
            </div>
            <div class="stock-fluid-row">
              <div class="stock-fluid-label">
                <span class="text-agua"><i class="fas fa-tint"></i> Água</span>
                <span class="qty">${posAgua.toLocaleString()} / ${capAgua.toLocaleString()} L</span>
              </div>
              <div class="progress-bar"><div class="progress-fill-agua ${pctA<crit?'critical':pctA<warn?'warning':''}" style="width:${pctA}%"></div></div>
              <div class="pct-label" style="${pctA<crit?'color:var(--danger);font-weight:600':pctA<warn?'color:var(--warning);font-weight:600':''}">${pctA.toFixed(1)}%${pctA<crit?' ⚠ CRÍTICO':pctA<warn?' ⚠ baixo':''} ${lastAgua ? '· '+new Date(lastAgua.data+'T12:00:00').toLocaleDateString('pt-BR') : '· sem registro'}</div>
            </div>
            <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border-color);display:flex;gap:6px;">
              <button class="btn btn-sm btn-outline" style="flex:1;font-size:11px;" onclick="openSupplyModalPreset(${v.id},'oleo')"><i class="fas fa-plus"></i> Óleo</button>
              <button class="btn btn-sm btn-outline" style="flex:1;font-size:11px;color:var(--agua-color);border-color:var(--agua-color);" onclick="openSupplyModalPreset(${v.id},'agua')"><i class="fas fa-plus"></i> Água</button>
            </div>
          </div>
        </div>`;
    }).join('');

    container.innerHTML = `
      <div class="kpi-grid">
        <div class="kpi-card kpi-card-oleo">
          <div class="kpi-icon kpi-icon-oleo"><i class="fas fa-oil-can"></i></div>
          <div class="kpi-label">Total Óleo a Bordo</div>
          <div class="kpi-value">${totalOleoL.toLocaleString()} L</div>
          <div class="kpi-trend">${pctOleo}% da capacidade total</div>
        </div>
        <div class="kpi-card kpi-card-agua">
          <div class="kpi-icon kpi-icon-agua"><i class="fas fa-tint"></i></div>
          <div class="kpi-label">Total Água a Bordo</div>
          <div class="kpi-value">${totalAguaL.toLocaleString()} L</div>
          <div class="kpi-trend">${pctAgua}% da capacidade total</div>
        </div>
        <div class="kpi-card kpi-card-neutral">
          <div class="kpi-icon kpi-icon-neutral"><i class="fas fa-ship"></i></div>
          <div class="kpi-label">Cap. Total Óleo</div>
          <div class="kpi-value">${capOleoTotal.toLocaleString()} L</div>
          <div class="kpi-trend">${minhasEmbarcacoes().length} embarcações</div>
        </div>
        <div class="kpi-card kpi-card-neutral">
          <div class="kpi-icon kpi-icon-neutral"><i class="fas fa-water"></i></div>
          <div class="kpi-label">Cap. Total Água</div>
          <div class="kpi-value">${capAguaTotal.toLocaleString()} L</div>
          <div class="kpi-trend">${minhasEmbarcacoes().length} embarcações</div>
        </div>
      </div>
      <div class="info-box"><i class="fas fa-info-circle"></i> A posição de estoque reflete o último <strong>Quantidade a Bordo Após</strong> registrado. Clique em <strong>+ Óleo</strong> ou <strong>+ Água</strong> nos cards para abastecimento rápido.</div>
      <div class="filter-bar" style="gap:10px;margin-bottom:12px;">
        <span style="font-size:12px;padding:3px 10px;background:rgba(220,38,38,0.08);color:var(--danger);border-radius:20px;border:1px solid rgba(220,38,38,0.25);">⚠ Crítico (&lt;${config.alertCritical||20}%)</span>
        <span style="font-size:12px;padding:3px 10px;background:rgba(217,119,6,0.08);color:var(--warning);border-radius:20px;border:1px solid rgba(217,119,6,0.25);">⚠ Baixo (&lt;${config.alertWarning||40}%)</span>
        <span style="font-size:12px;padding:3px 10px;background:rgba(14,165,233,0.08);color:var(--oleo-color);border-radius:20px;border:1px solid rgba(14,165,233,0.25);">OK (≥${config.alertWarning||40}%)</span>
        <button class="btn btn-primary btn-sm" style="margin-left:auto;" onclick="openSupplyModal()"><i class="fas fa-plus"></i> Novo Abastecimento</button>
      </div>
      <div class="stock-grid">${cardsHtml}</div>
      <div class="table-container">
        <div class="table-header"><h3>Resumo por Embarcação</h3></div>
        <div class="table-responsive"><table>
          <thead><tr><th>Embarcação</th><th>Sigla</th><th>Material</th><th>Óleo Atual (L)</th><th>Cap. Óleo (L)</th><th>% Óleo</th><th>Água Atual (L)</th><th>Cap. Água (L)</th><th>% Água</th><th>Último Abast. Óleo</th></tr></thead>
          <tbody>${minhasEmbarcacoes().map(v => {
            const posO = getPosicaoAtual(v.id, 'oleo'), posA = getPosicaoAtual(v.id, 'agua');
            const capO = (v.capacidadeOleo||0)*1000, capA = (v.capacidadeAgua||0)*1000;
            const pO = capO > 0 ? (posO/capO*100).toFixed(1) : '—';
            const pA = capA > 0 ? (posA/capA*100).toFixed(1) : '—';
            const pON = capO > 0 ? posO/capO*100 : 100, pAN = capA > 0 ? posA/capA*100 : 100;
            const crit = config.alertCritical||20, warn = config.alertWarning||40;
            const rowCrit = pON < crit || pAN < crit, rowWarn = !rowCrit && (pON < warn || pAN < warn);
            const last = DB.supplies.filter(s=>s.vesselId===v.id&&(s.tipoFluido==='oleo'||!s.tipoFluido)).sort((a,b)=>b.data.localeCompare(a.data)||b.id-a.id)[0];
            return `<tr style="${rowCrit?'background:rgba(220,38,38,0.04)':rowWarn?'background:rgba(217,119,6,0.04)':''}">
              <td><strong>${v.name}</strong> ${rowCrit?'<span class="alert-tag alert-tag-critical">⚠ crítico</span>':rowWarn?'<span class="alert-tag alert-tag-warning">⚠ baixo</span>':''}</td>
              <td><span class="pill ${v.material==='Aço'?'pill-aco':'pill-madeira'}">${v.sigla}</span></td>
              <td>${v.material}</td>
              <td><strong style="${pON<crit?'color:var(--danger)':pON<warn?'color:var(--warning)':'color:var(--oleo-color)'}">${posO.toLocaleString()}</strong></td>
              <td>${capO.toLocaleString()}</td>
              <td style="${pON<crit?'color:var(--danger);font-weight:700':pON<warn?'color:var(--warning);font-weight:700':''}">${pO}%</td>
              <td><strong style="${pAN<crit?'color:var(--danger)':pAN<warn?'color:var(--warning)':'color:var(--agua-color)'}">${posA.toLocaleString()}</strong></td>
              <td>${capA.toLocaleString()}</td>
              <td style="${pAN<crit?'color:var(--danger);font-weight:700':pAN<warn?'color:var(--warning);font-weight:700':''}">${pA}%</td>
              <td>${last ? new Date(last.data+'T12:00:00').toLocaleDateString('pt-BR') : '—'}</td>
            </tr>`;
          }).join('')}</tbody>
        </table></div>
      </div>
    `;
  }

  // =====================================================================
  //  MODAL DE ABASTECIMENTO — CORRIGIDO
  // =====================================================================
  window.openSupplyModalPreset = function(vesselId, tipoFluido) {
    if (!podeVerEmbarcacao(vesselId)) { toast('Sem permissão para esta embarcação.','error'); return; }
    openSupplyModal(null, vesselId, tipoFluido);
  };

  function openSupplyModal(editId = null, presetVesselId = null, presetFluido = null) {
    // Operadores não podem editar registros existentes
    if (editId !== null && !isAdmin()) {
      toast('Para corrigir um lançamento, use o botão "Corrigir" na linha do registro.','error');
      return;
    }
    currentEditSupply = editId ? DB.supplies.find(s => s.id === editId) : null;
    document.getElementById('modalTitle').innerText = currentEditSupply ? 'Editar Abastecimento' : 'Novo Abastecimento';

    const es = currentEditSupply;
    const tipoFluido = es?.tipoFluido || presetFluido || 'oleo';
    const tipoOp = es?.tipoOperacao === 'passagem' ? 'passagem' : 'compra';
    const today = new Date().toISOString().split('T')[0];
    const vesselId = es?.vesselId || presetVesselId || (DB.vessels[0]?.id || '');
    const companyId = es?.companyId || '';
    const qtdAntes = es?.quantidadeAntes !== undefined ? es.quantidadeAntes : (vesselId ? getPosicaoAtual(vesselId, tipoFluido) : 0);
    const qtdSolicitada = es?.quantidadeSolicitada !== undefined ? es.quantidadeSolicitada : '';
    const qtdRecebida = es?.quantidade !== undefined ? Math.abs(es.quantidade) : (qtdSolicitada || '');
    const valorUnit = es?.valorUnitario || '';
    const obs = es?.observacao || '';
    const data = es?.data || today;
    const origemId = es?.embarcacaoOrigemId || '';

    const vesselOpts = DB.vessels.map(v => `<option value="${v.id}" ${v.id == vesselId ? 'selected' : ''}>${v.name} (${v.sigla})</option>`).join('');
    const companyOpts = `<option value="">Selecione...</option>` + DB.companies.map(c => `<option value="${c.id}" ${c.id == companyId ? 'selected' : ''}>${c.name}</option>`).join('');

    document.getElementById('supplyModalBody').innerHTML = `
      <!-- Tipo de Fluido -->
      <div style="margin-bottom:12px;">
        <div class="form-label">Tipo de Fluido</div>
        <div class="fluid-tabs">
          <div class="fluid-tab ${tipoFluido==='oleo'?'active-oleo':''}" onclick="setFluidoTipo('oleo')" id="tabOleo">
            🛢 Óleo / Diesel
          </div>
          <div class="fluid-tab ${tipoFluido==='agua'?'active-agua':''}" onclick="setFluidoTipo('agua')" id="tabAgua">
            💧 Água Potável
          </div>
        </div>
        <input type="hidden" id="supplyTipoFluido" value="${tipoFluido}">
      </div>

      <!-- Tipo de Operação -->
      <div style="margin-bottom:12px;">
        <div class="form-label">Tipo de Operação</div>
        <div class="op-tabs">
          <div class="op-tab ${tipoOp==='compra'?'active':''}" onclick="setTipoOperacao('compra')" id="tabCompra">Compra / Recebimento</div>
          <div class="op-tab ${tipoOp==='passagem'?'active':''}" onclick="setTipoOperacao('passagem')" id="tabPassagem">Passagem entre Embarcações</div>
        </div>
        <input type="hidden" id="supplyTipoOp" value="${tipoOp}">
      </div>

      <!-- Embarcação Destino -->
      <div class="form-group">
        <label class="form-label">Embarcação <span id="labelDestino">(Destino)</span></label>
        <select class="form-control" id="supplyVessel" onchange="onVesselOrFluidChange()" required>
          ${vesselOpts}
        </select>
      </div>

      <!-- Origem (passagem) -->
      <div id="origemGroup" style="${tipoOp==='passagem'?'':'display:none'}">
        <div class="form-group">
          <label class="form-label">Embarcação de Origem <i class="fas fa-info-circle tooltip-icon" title="Embarcação que cederá o fluido"></i></label>
          <select class="form-control" id="supplyOrigem">
            ${DB.vessels.filter(v => v.id != vesselId).map(v => `<option value="${v.id}" ${v.id==origemId?'selected':''}>${v.name} (${v.sigla}) — Posição: ${getPosicaoAtual(v.id, tipoFluido).toLocaleString()} L</option>`).join('')}
          </select>
        </div>
      </div>

      <!-- Empresa (somente compra óleo) -->
      <div id="empresaGroup" style="${tipoOp==='compra'&&tipoFluido==='oleo'?'':'display:none'}">
        <div class="form-group">
          <label class="form-label">Empresa Fornecedora <i class="fas fa-info-circle tooltip-icon" title="Obrigatório para compra de óleo"></i></label>
          <select class="form-control" id="supplyCompany">${companyOpts}</select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Data do Abastecimento</label>
        <input type="date" class="form-control" id="supplyDate" value="${data}" required>
      </div>

      <!-- Posição atual (informativo) -->
      <div id="posicaoAtualInfo" class="stock-info ${tipoFluido==='agua'?'stock-info-agua':''}">
        <i class="fas fa-info-circle"></i>
        <span id="posicaoAtualTexto">Posição atual de estoque: calculando...</span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Quantidade a Bordo Antes (L)</label>
          <input type="number" class="form-control" id="supplyAntes" step="1" min="0" value="${qtdAntes}" readonly style="background:var(--gray-100);cursor:default;" title="Preenchido automaticamente com a posição atual">
        </div>
        <div class="form-group">
          <label class="form-label">Quantidade Solicitada (L)</label>
          <input type="number" class="form-control" id="supplySolicitada" step="1" min="0" value="${qtdSolicitada}" oninput="onSolicitadaChange()">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Quantidade Recebida (L) <i class="fas fa-info-circle tooltip-icon" title="Pode diferir do solicitado — edite se necessário"></i></label>
          <input type="number" class="form-control" id="supplyAbastecida" step="1" min="0" value="${qtdRecebida}" required oninput="recalcular()">
        </div>
        <div class="form-group">
          <label class="form-label">Quantidade a Bordo Após (L)</label>
          <input type="number" class="form-control" id="supplyApos" step="1" min="0" value="${es?.quantidadeBordo||''}" readonly>
        </div>
      </div>

      <!-- Calculadora -->
      <div id="calcPanel" style="${tipoOp==='compra'&&tipoFluido==='oleo'?'':'display:none'}">
        <div class="calc-panel">
          <h4><i class="fas fa-calculator"></i> Calculadora de Valor</h4>
          <div class="form-row" style="margin-bottom:8px;">
            <div class="form-group" style="margin-bottom:0">
              <label class="form-label">Valor Unitário (R$/L)</label>
              <input type="number" class="form-control" id="supplyUnitPrice" step="0.001" min="0" value="${valorUnit}" oninput="recalcular()">
            </div>
            <div style="display:flex;align-items:flex-end;padding-bottom:0;">
            </div>
          </div>
          <div class="calc-row">
            <span class="calc-label">Quantidade recebida</span>
            <span class="calc-value" id="calcQtd">—</span>
          </div>
          <div class="calc-row">
            <span class="calc-label">Valor unitário</span>
            <span class="calc-value" id="calcUnitario">—</span>
          </div>
          <div class="calc-row total">
            <span class="calc-label">Valor Total</span>
            <span class="calc-value" id="calcTotal">—</span>
          </div>
        </div>
      </div>

      <div class="form-group" style="margin-top:12px;">
        <label class="form-label">Observação</label>
        <input type="text" class="form-control" id="supplyObs" value="${obs}" placeholder="Opcional...">
      </div>
    `;

    document.getElementById('supplyModal').classList.add('show');
    setTimeout(() => {
      onVesselOrFluidChange();
      recalcular();
    }, 50);
  }

  window.setFluidoTipo = function(tipo) {
    document.getElementById('supplyTipoFluido').value = tipo;
    document.getElementById('tabOleo').className = 'fluid-tab' + (tipo === 'oleo' ? ' active-oleo' : '');
    document.getElementById('tabAgua').className = 'fluid-tab' + (tipo === 'agua' ? ' active-agua' : '');
    // oculta/mostra empresa e calc
    const tipoOp = document.getElementById('supplyTipoOp').value;
    document.getElementById('empresaGroup').style.display = (tipoOp === 'compra' && tipo === 'oleo') ? '' : 'none';
    document.getElementById('calcPanel').style.display = (tipoOp === 'compra' && tipo === 'oleo') ? '' : 'none';
    document.getElementById('posicaoAtualInfo').className = 'stock-info' + (tipo === 'agua' ? ' stock-info-agua' : '');
    onVesselOrFluidChange();
    // atualiza origem com posições corretas
    _atualizarOrigem();
  };

  window.setTipoOperacao = function(tipo) {
    document.getElementById('supplyTipoOp').value = tipo;
    document.getElementById('tabCompra').className = 'op-tab' + (tipo === 'compra' ? ' active' : '');
    document.getElementById('tabPassagem').className = 'op-tab' + (tipo === 'passagem' ? ' active' : '');
    // Operadores só podem fazer passagem
    if (!isAdmin()) {
      document.getElementById('tabCompra').style.display = 'none';
      if (tipo !== 'passagem') setTipoOperacao('passagem');
    } else {
      document.getElementById('tabCompra').style.display = '';
    }
    document.getElementById('origemGroup').style.display = tipo === 'passagem' ? '' : 'none';
    const fluido = document.getElementById('supplyTipoFluido').value;
    document.getElementById('empresaGroup').style.display = (tipo === 'compra' && fluido === 'oleo') ? '' : 'none';
    document.getElementById('calcPanel').style.display = (tipo === 'compra' && fluido === 'oleo') ? '' : 'none';
    document.getElementById('labelDestino').textContent = tipo === 'passagem' ? '(Destino)' : '';
  };

  window.onVesselOrFluidChange = function() {
    const vesselId = parseInt(document.getElementById('supplyVessel')?.value);
    const tipoFluido = document.getElementById('supplyTipoFluido')?.value || 'oleo';
    if (!vesselId || isNaN(vesselId)) return;
    const pos = getPosicaoAtual(vesselId, tipoFluido);
    document.getElementById('supplyAntes').value = pos;
    const v = DB.vessels.find(x => x.id === vesselId);
    const cap = tipoFluido === 'agua' ? (v?.capacidadeAgua||0)*1000 : (v?.capacidadeOleo||v?.capacidade||0)*1000;
    const nomeF = tipoFluido === 'agua' ? '💧 Água' : '🛢 Óleo';
    document.getElementById('posicaoAtualTexto').innerHTML = `Posição atual (${nomeF}): <strong>${pos.toLocaleString()} L</strong> de ${cap.toLocaleString()} L (${cap>0?(pos/cap*100).toFixed(1):0}%)`;
    recalcular();
    _atualizarOrigem();
  };

  function _atualizarOrigem() {
    const vesselId = parseInt(document.getElementById('supplyVessel')?.value);
    const tipoFluido = document.getElementById('supplyTipoFluido')?.value || 'oleo';
    const origemSel = document.getElementById('supplyOrigem');
    if (!origemSel) return;
    const prevVal = origemSel.value;
    origemSel.innerHTML = DB.vessels.filter(v => v.id != vesselId)
      .map(v => `<option value="${v.id}" ${v.id==prevVal?'selected':''}>${v.name} (${v.sigla}) — Posição: ${getPosicaoAtual(v.id, tipoFluido).toLocaleString()} L</option>`).join('');
  }

  window.onSolicitadaChange = function() {
    const sol = document.getElementById('supplySolicitada')?.value;
    const rec = document.getElementById('supplyAbastecida');
    if (rec && sol) rec.value = sol;
    recalcular();
  };

  window.recalcular = function() {
    const antes = parseFloat(document.getElementById('supplyAntes')?.value) || 0;
    const rec = parseFloat(document.getElementById('supplyAbastecida')?.value) || 0;
    const aposEl = document.getElementById('supplyApos');
    if (aposEl) aposEl.value = antes + rec;

    const unit = parseFloat(document.getElementById('supplyUnitPrice')?.value) || 0;
    const total = rec * unit;
    const calcQtd = document.getElementById('calcQtd');
    const calcUnit = document.getElementById('calcUnitario');
    const calcTot = document.getElementById('calcTotal');
    if (calcQtd) calcQtd.textContent = rec ? rec.toLocaleString() + ' L' : '—';
    if (calcUnit) calcUnit.textContent = unit ? formatMoney(unit) + '/L' : '—';
    if (calcTot) calcTot.textContent = (rec && unit) ? formatMoney(total) : '—';
  };

  function saveSupply() {
    try {
      const tipoFluido = document.getElementById('supplyTipoFluido')?.value || 'oleo';
      const tipoOperacao = document.getElementById('supplyTipoOp')?.value || 'compra';
      const vesselId = parseInt(document.getElementById('supplyVessel').value);
      const data = document.getElementById('supplyDate').value;

      if (!vesselId) { toast('Selecione a embarcação!', 'error'); return; }
      if (!data) { toast('Informe a data!', 'error'); return; }
      if (!validarDataNaoFutura(data)) { toast('A data não pode ser futura!', 'error'); return; }

      const quantidadeAntes = parseFloat(document.getElementById('supplyAntes').value) || 0;
      const quantidadeSolicitada = parseFloat(document.getElementById('supplySolicitada').value) || 0;
      const quantidadeAbastecida = parseFloat(document.getElementById('supplyAbastecida').value) || 0;
      if (quantidadeAbastecida <= 0) { toast('Informe a quantidade recebida!', 'error'); return; }

      const quantidadeApos = quantidadeAntes + quantidadeAbastecida;
      const capacidadeMax = getCapacidade(vesselId, tipoFluido);
      if (quantidadeApos > capacidadeMax) { toast(`Capacidade excedida! Máximo: ${capacidadeMax.toLocaleString()} L`, 'error'); return; }

      let companyId = null, valorUnitario = 0, valorTotal = 0;
      if (tipoOperacao === 'compra' && tipoFluido === 'oleo') {
        companyId = parseInt(document.getElementById('supplyCompany')?.value) || null;
        valorUnitario = parseFloat(document.getElementById('supplyUnitPrice')?.value) || 0;
        if (!companyId) { toast('Selecione a empresa fornecedora!', 'error'); return; }
        if (valorUnitario <= 0) { toast('Informe o valor unitário!', 'error'); return; }
        valorTotal = quantidadeAbastecida * valorUnitario;
      }

      if (tipoOperacao === 'passagem') {
        const origemId = parseInt(document.getElementById('supplyOrigem')?.value);
        if (!origemId || origemId === vesselId) { toast('Selecione uma embarcação de origem diferente!', 'error'); return; }
        const estoqueOrigem = getPosicaoAtual(origemId, tipoFluido);
        if (estoqueOrigem < quantidadeAbastecida) { toast(`Estoque insuficiente na origem! Disponível: ${estoqueOrigem.toLocaleString()} L`, 'error'); return; }
      }

      const obs = document.getElementById('supplyObs').value;

      // Remove antigo se edição
      if (currentEditSupply) {
        const idx = DB.supplies.findIndex(s => s.id === currentEditSupply.id);
        if (idx !== -1) {
          if (currentEditSupply.tipoOperacao === 'passagem') {
            const saidaIdx = DB.supplies.findIndex(s =>
              s.vesselId === currentEditSupply.embarcacaoOrigemId &&
              s.tipoOperacao === 'passagem_saida' &&
              s.embarcacaoDestinoId === currentEditSupply.vesselId &&
              s.data === currentEditSupply.data
            );
            if (saidaIdx !== -1) DB.supplies.splice(saidaIdx, 1);
          }
          DB.supplies.splice(idx, 1);
        }
      }

      const newSupply = {
        id: DB.nextId.supplies++,
        vesselId, companyId, data, tipoFluido,
        usuarioId: currentUser?.id, usuarioNome: currentUser?.nome,
        tipo: tipoFluido === 'agua' ? 'Água Potável' : 'Diesel Marítimo',
        quantidade: quantidadeAbastecida,
        valorUnitario, valorTotal,
        quantidadeAntes, quantidadeSolicitada,
        quantidadeBordo: quantidadeApos,
        tipoOperacao, observacao: obs
      };
      DB.supplies.push(newSupply);

      if (tipoOperacao === 'passagem') {
        const origemId = parseInt(document.getElementById('supplyOrigem').value);
        const posOrigem = getPosicaoAtual(origemId, tipoFluido);
        const saida = {
          id: DB.nextId.supplies++,
          vesselId: origemId, companyId: null, data, tipoFluido,
          tipo: newSupply.tipo,
          quantidade: -quantidadeAbastecida,
          valorUnitario: 0, valorTotal: 0,
          quantidadeAntes: posOrigem,
          quantidadeSolicitada: 0,
          quantidadeBordo: posOrigem - quantidadeAbastecida,
          tipoOperacao: 'passagem_saida',
          embarcacaoDestinoId: vesselId,
          observacao: `Transferência para ${DB.vessels.find(v=>v.id===vesselId)?.sigla}`
        };
        DB.supplies.push(saida);
        newSupply.embarcacaoOrigemId = origemId;
      }

      saveToStorage();
      toast(currentEditSupply ? 'Abastecimento atualizado!' : 'Abastecimento registrado!', 'success');
      closeModal('supplyModal');
      renderDashboard(currentDashboard);
    } catch(e) { toast('Erro ao salvar: ' + e.message, 'error'); console.error(e); }
  }

  function deleteSupply(id) {
    if (!isAdmin()) { toast('Sem permissão. Use o botão Corrigir para solicitar ao administrador.','error'); return; }
    if (!confirm('Excluir este registro?')) return;
    const s = DB.supplies.find(x => x.id === id);
    if (s?.tipoOperacao === 'passagem') {
      const saidaIdx = DB.supplies.findIndex(x =>
        x.vesselId === s.embarcacaoOrigemId &&
        x.tipoOperacao === 'passagem_saida' &&
        x.embarcacaoDestinoId === s.vesselId &&
        x.data === s.data
      );
      if (saidaIdx !== -1) DB.supplies.splice(saidaIdx, 1);
    }
    DB.supplies = DB.supplies.filter(x => x.id !== id);
    saveToStorage();
    toast('Registro excluído!', 'success');
    renderDashboard(currentDashboard);
  }

  // =====================================================================
  //  REGISTROS (TABELA)
  // =====================================================================
  let suppliesFilterFluido='all', suppliesFilterOp='all', suppliesFilterVessel='all', suppliesFilterEmpresa='all', suppliesFilterDateStart='', suppliesFilterDateEnd='';

  function clearSuppliesFilters() {
    suppliesSearch=''; suppliesFilterFluido='all'; suppliesFilterOp='all';
    suppliesFilterVessel='all'; suppliesFilterEmpresa='all';
    suppliesFilterDateStart=''; suppliesFilterDateEnd='';
    suppliesPage=1; renderDashboard('supplies');
  }

  function renderSupplies(container) {
    const myVesselIds = new Set(minhasEmbarcacoes().map(v=>v.id));
    let filtered = DB.supplies.filter(s => s.tipoOperacao !== 'passagem_saida' && s.tipoOperacao !== 'consumo_op' && myVesselIds.has(s.vesselId));
    if (suppliesSearch) {
      const q = suppliesSearch.toLowerCase();
      filtered = filtered.filter(s =>
        s.observacao?.toLowerCase().includes(q) ||
        DB.vessels.find(v=>v.id===s.vesselId)?.name.toLowerCase().includes(q) ||
        DB.companies.find(c=>c.id===s.companyId)?.name.toLowerCase().includes(q)
      );
    }
    if (suppliesFilterFluido !== 'all') filtered = filtered.filter(s => suppliesFilterFluido==='oleo' ? (s.tipoFluido==='oleo'||!s.tipoFluido) : s.tipoFluido===suppliesFilterFluido);
    if (suppliesFilterOp !== 'all') filtered = filtered.filter(s => s.tipoOperacao === suppliesFilterOp);
    if (suppliesFilterVessel !== 'all') filtered = filtered.filter(s => s.vesselId === parseInt(suppliesFilterVessel));
    if (suppliesFilterEmpresa !== 'all') filtered = filtered.filter(s => s.companyId === parseInt(suppliesFilterEmpresa));
    if (suppliesFilterDateStart) filtered = filtered.filter(s => s.data >= suppliesFilterDateStart);
    if (suppliesFilterDateEnd) filtered = filtered.filter(s => s.data <= suppliesFilterDateEnd);
    filtered.sort((a, b) => {
      let va = a[suppliesSort.column], vb = b[suppliesSort.column];
      if (suppliesSort.column === 'vesselName') { va = DB.vessels.find(v=>v.id===a.vesselId)?.name||''; vb = DB.vessels.find(v=>v.id===b.vesselId)?.name||''; }
      if (va < vb) return suppliesSort.direction === 'asc' ? -1 : 1;
      if (va > vb) return suppliesSort.direction === 'asc' ? 1 : -1;
      return 0;
    });
    const totalPages = Math.ceil(filtered.length / config.rowsPerPage.supplies);
    const start = (suppliesPage - 1) * config.rowsPerPage.supplies;
    const paginated = filtered.slice(start, start + config.rowsPerPage.supplies);
    const totalOleoFilt = filtered.filter(s=>s.tipoOperacao==='compra'&&(s.tipoFluido==='oleo'||!s.tipoFluido)).reduce((a,s)=>a+s.quantidade,0);
    const totalGastoFilt = filtered.filter(s=>s.tipoOperacao==='compra'&&(s.tipoFluido==='oleo'||!s.tipoFluido)).reduce((a,s)=>a+(s.valorTotal||0),0);

    container.innerHTML = `
      <div class="filter-bar" style="flex-wrap:wrap;gap:10px;">
        <div class="filter-group"><span class="filter-label">Buscar:</span><input type="text" class="search-box" style="min-width:150px;" placeholder="Embarc., obs., empresa" value="${suppliesSearch}" onkeyup="suppliesSearch=this.value;suppliesPage=1;renderDashboard('supplies')"></div>
        <div class="filter-group"><span class="filter-label">Fluido:</span>
          <select class="filter-select" onchange="suppliesFilterFluido=this.value;suppliesPage=1;renderDashboard('supplies')">
            <option value="all" ${suppliesFilterFluido==='all'?'selected':''}>Todos</option>
            <option value="oleo" ${suppliesFilterFluido==='oleo'?'selected':''}>🛢 Óleo</option>
            <option value="agua" ${suppliesFilterFluido==='agua'?'selected':''}>💧 Água</option>
          </select>
        </div>
        <div class="filter-group"><span class="filter-label">Tipo:</span>
          <select class="filter-select" onchange="suppliesFilterOp=this.value;suppliesPage=1;renderDashboard('supplies')">
            <option value="all" ${suppliesFilterOp==='all'?'selected':''}>Todos</option>
            <option value="compra" ${suppliesFilterOp==='compra'?'selected':''}>Compra</option>
            <option value="passagem" ${suppliesFilterOp==='passagem'?'selected':''}>Passagem</option>
          </select>
        </div>
        <div class="filter-group"><span class="filter-label">Embarcação:</span>
          <select class="filter-select" onchange="suppliesFilterVessel=this.value;suppliesPage=1;renderDashboard('supplies')">
            <option value="all">Todas</option>
            ${DB.vessels.map(v=>`<option value="${v.id}" ${suppliesFilterVessel==v.id?'selected':''}>${v.sigla}</option>`).join('')}
          </select>
        </div>
        <div class="filter-group"><span class="filter-label">Empresa:</span>
          <select class="filter-select" onchange="suppliesFilterEmpresa=this.value;suppliesPage=1;renderDashboard('supplies')">
            <option value="all">Todas</option>
            ${DB.companies.map(c=>`<option value="${c.id}" ${suppliesFilterEmpresa==c.id?'selected':''}>${c.name.split(' ')[0]}</option>`).join('')}
          </select>
        </div>
        <div class="filter-group"><span class="filter-label">De:</span><input type="date" class="filter-select" value="${suppliesFilterDateStart}" onchange="suppliesFilterDateStart=this.value;suppliesPage=1;renderDashboard('supplies')"></div>
        <div class="filter-group"><span class="filter-label">Até:</span><input type="date" class="filter-select" value="${suppliesFilterDateEnd}" onchange="suppliesFilterDateEnd=this.value;suppliesPage=1;renderDashboard('supplies')"></div>
        <div style="display:flex;gap:8px;margin-left:auto;align-items:center;">
          <button class="btn btn-outline btn-sm" onclick="clearSuppliesFilters()"><i class="fas fa-times"></i> Limpar</button>
          ${isAdmin() || !isAdmin() ? `<button class="btn btn-primary btn-sm" onclick="openSupplyModal()"><i class="fas fa-plus"></i> ${isAdmin()?'Novo':'Nova Passagem'}</button>` : ''}
        </div>
      </div>
      ${filtered.length > 0 ? `<div style="display:flex;gap:16px;padding:10px 16px;background:var(--card-bg);border:1px solid var(--border-color);border-radius:var(--radius-xl);margin-bottom:12px;font-size:12px;flex-wrap:wrap;">
        <span><strong>${filtered.length}</strong> registros</span>
        ${totalOleoFilt>0?`<span class="text-oleo"><i class="fas fa-oil-can"></i> ${totalOleoFilt.toLocaleString()} L</span>`:''}
        ${totalGastoFilt>0?`<span style="color:var(--success)"><i class="fas fa-dollar-sign"></i> ${formatMoney(totalGastoFilt)}</span>`:''}
      </div>` : ''}
      <div class="table-container">
        <div class="table-header"><h3>Registros de Abastecimento</h3><span class="badge">${filtered.length} registros</span></div>
        <div class="table-responsive"><table>
          <thead><tr>
            <th onclick="sortSupplies('data')">Data ${suppliesSort.column==='data'?(suppliesSort.direction==='asc'?'↑':'↓'):''}</th>
            <th onclick="sortSupplies('vesselName')">Embarcação ${suppliesSort.column==='vesselName'?(suppliesSort.direction==='asc'?'↑':'↓'):''}</th>
            <th>Fluido</th><th>Tipo Op.</th><th>Empresa / Origem</th>
            <th>Antes (L)</th><th>Solicitado (L)</th>
            <th onclick="sortSupplies('quantidade')">Recebido (L) ${suppliesSort.column==='quantidade'?(suppliesSort.direction==='asc'?'↑':'↓'):''}</th>
            <th>Após (L)</th><th>V. Unit.</th>
            <th onclick="sortSupplies('valorTotal')">V. Total ${suppliesSort.column==='valorTotal'?(suppliesSort.direction==='asc'?'↑':'↓'):''}</th>
            <th>Ações</th>
          </tr></thead>
          <tbody>${paginated.length ? paginated.map(s => {
            const v = DB.vessels.find(x=>x.id===s.vesselId);
            const c = DB.companies.find(x=>x.id===s.companyId);
            const origemV = s.embarcacaoOrigemId ? DB.vessels.find(x=>x.id===s.embarcacaoOrigemId) : null;
            const empOuOrigem = s.tipoOperacao==='passagem' ? `<span class="text-muted" style="font-size:11px;">⟵ ${origemV?.sigla||'?'}</span>` : (c?.name||'—');
            return `<tr>
              <td>${new Date(s.data+'T12:00:00').toLocaleDateString('pt-BR')}</td>
              <td><span class="pill ${v?.material==='Aço'?'pill-aco':'pill-madeira'}">${v?.sigla||'-'}</span></td>
              <td><span class="pill ${s.tipoFluido==='agua'?'pill-agua':'pill-oleo'}">${s.tipoFluido==='agua'?'💧 Água':'🛢 Óleo'}</span></td>
              <td><span class="pill ${s.tipoOperacao==='compra'?'pill-compra':'pill-passagem'}">${s.tipoOperacao==='compra'?'Compra':'Passagem'}</span></td>
              <td>${empOuOrigem}</td>
              <td>${(s.quantidadeAntes||0).toLocaleString()}</td>
              <td>${(s.quantidadeSolicitada||0).toLocaleString()}</td>
              <td><strong>${s.quantidade.toLocaleString()}</strong></td>
              <td>${(s.quantidadeBordo||0).toLocaleString()}</td>
              <td>${s.valorUnitario ? formatMoney(s.valorUnitario) : '—'}</td>
              <td>${s.valorTotal ? formatMoney(s.valorTotal) : '—'}</td>
              <td style="white-space:nowrap;">
                ${isAdmin() ? `
                <button class="btn btn-sm btn-outline btn-icon" onclick="openSupplyModal(${s.id})" title="Editar"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger btn-icon" onclick="deleteSupply(${s.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                ` : `
                <button class="btn-solicitar" onclick="solicitarCorrecao('supply', ${s.id}, 'Abastecimento de ${DB.vessels.find(x=>x.id===s.vesselId)?.sigla||'?'} em ${s.data}')" title="Solicitar correção"><i class="fas fa-exclamation-circle"></i> Corrigir</button>
                `}
              </td>
            </tr>`;
          }).join('') : `<tr><td colspan="12" style="text-align:center;padding:32px;color:var(--text-secondary)">Nenhum registro encontrado</td></tr>`}</tbody>
        </table></div>
        <div class="pagination">
          <button onclick="changeSuppliesPage(1)" ${suppliesPage===1?'disabled':''}><i class="fas fa-angle-double-left"></i></button>
          <button onclick="changeSuppliesPage(${suppliesPage-1})" ${suppliesPage===1?'disabled':''}><i class="fas fa-angle-left"></i></button>
          <span>Página ${suppliesPage} de ${totalPages||1} &nbsp;|&nbsp; Linhas:
            <select style="font-size:12px;padding:2px 4px;border:1px solid var(--border-color);border-radius:4px;background:var(--card-bg);color:var(--text-primary);" onchange="config.rowsPerPage.supplies=parseInt(this.value);suppliesPage=1;renderDashboard('supplies')">
              ${[5,10,20,50].map(n=>`<option value="${n}" ${config.rowsPerPage.supplies===n?'selected':''}>${n}</option>`).join('')}
            </select>
          </span>
          <button onclick="changeSuppliesPage(${suppliesPage+1})" ${suppliesPage>=totalPages?'disabled':''}><i class="fas fa-angle-right"></i></button>
          <button onclick="changeSuppliesPage(${totalPages})" ${suppliesPage>=totalPages?'disabled':''}><i class="fas fa-angle-double-right"></i></button>
        </div>
      </div>
    `;
  }

  function sortSupplies(col) {
    if (suppliesSort.column === col) suppliesSort.direction = suppliesSort.direction === 'asc' ? 'desc' : 'asc';
    else { suppliesSort.column = col; suppliesSort.direction = 'desc'; }
    suppliesPage = 1;
    renderDashboard('supplies');
  }
  function changeSuppliesPage(p) { suppliesPage = p; renderDashboard('supplies'); }

  // =====================================================================
  //  EMPRESAS
  // =====================================================================
  function renderCompanies(container) {
    let filtered = DB.companies;
    if (companiesSearch) {
      const q = companiesSearch.toLowerCase();
      filtered = filtered.filter(c =>
        c.name.toLowerCase().includes(q) ||
        (c.cnpj||'').toLowerCase().includes(q) ||
        (c.contato||'').toLowerCase().includes(q) ||
        (c.telefone||'').toLowerCase().includes(q)
      );
    }
    filtered.sort((a,b) => {
      if (a[companiesSort.column] < b[companiesSort.column]) return companiesSort.direction === 'asc' ? -1 : 1;
      if (a[companiesSort.column] > b[companiesSort.column]) return companiesSort.direction === 'asc' ? 1 : -1;
      return 0;
    });
    const totalPages = Math.ceil(filtered.length / config.rowsPerPage.companies);
    const start = (companiesPage - 1) * config.rowsPerPage.companies;
    const paginated = filtered.slice(start, start + config.rowsPerPage.companies);

    container.innerHTML = `
      <div class="filter-bar">
        <div class="filter-group"><span class="filter-label">Buscar:</span><input type="text" class="search-box" placeholder="Nome da empresa" value="${companiesSearch}" onkeyup="companiesSearch=this.value;companiesPage=1;renderDashboard('companies')"></div>
        ${isAdmin() ? `<button class="btn btn-primary btn-sm" onclick="openCompanyModal()"><i class="fas fa-plus"></i> Nova Empresa</button>` : ''}
      </div>
      <div class="table-container">
        <div class="table-header"><h3>Empresas Fornecedoras</h3></div>
        <div class="table-responsive"><table>
          <thead><tr><th onclick="sortCompanies('name')">Nome</th><th>CNPJ</th><th>Contato</th><th>Telefone</th><th>Ações</th></tr></thead>
          <tbody>${paginated.map(c=>`<tr>
            <td><strong>${c.name}</strong></td><td>${c.cnpj}</td><td>${c.contato}</td><td>${c.telefone}</td>
            <td>${isAdmin() ? `
                <button class="btn btn-sm btn-outline btn-icon" onclick="openCompanyModal(${c.id})"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger btn-icon" onclick="deleteCompany(${c.id})"><i class="fas fa-trash"></i></button>
                ` : `<span style="font-size:11px;color:var(--text-secondary)">—</span>`}</td>
          </tr>`).join('')}</tbody>
        </table></div>
        <div class="pagination">
          <button onclick="changeCompaniesPage(1)" ${companiesPage===1?'disabled':''}><i class="fas fa-angle-double-left"></i></button>
          <button onclick="changeCompaniesPage(${companiesPage-1})" ${companiesPage===1?'disabled':''}><i class="fas fa-angle-left"></i></button>
          <span>Página ${companiesPage} de ${totalPages||1}</span>
          <button onclick="changeCompaniesPage(${companiesPage+1})" ${companiesPage>=totalPages?'disabled':''}><i class="fas fa-angle-right"></i></button>
          <button onclick="changeCompaniesPage(${totalPages})" ${companiesPage>=totalPages?'disabled':''}><i class="fas fa-angle-double-right"></i></button>
        </div>
      </div>
    `;
  }

  function sortCompanies(col) { if (companiesSort.column===col) companiesSort.direction=companiesSort.direction==='asc'?'desc':'asc'; else { companiesSort.column=col; companiesSort.direction='asc'; } companiesPage=1; renderDashboard('companies'); }
  function changeCompaniesPage(p) { companiesPage=p; renderDashboard('companies'); }

  function openCompanyModal(editId=null) {
    if (!isAdmin()) { toast('Ação restrita ao administrador.','error'); return; }
    currentEditCompany = editId ? DB.companies.find(c=>c.id===editId) : null;
    document.getElementById('companyModalTitle').innerText = currentEditCompany ? 'Editar Empresa' : 'Nova Empresa';
    document.getElementById('companyModalBody').innerHTML = `
      <div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-control" id="companyName" value="${currentEditCompany?.name||''}"></div>
      <div class="form-group"><label class="form-label">CNPJ *</label><input type="text" class="form-control" id="companyCnpj" value="${currentEditCompany?.cnpj||''}"></div>
      <div class="form-group"><label class="form-label">Contato / E-mail</label><input type="text" class="form-control" id="companyContato" value="${currentEditCompany?.contato||''}"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Telefone</label><input type="text" class="form-control" id="companyTelefone" value="${currentEditCompany?.telefone||''}"></div>
        <div class="form-group"><label class="form-label">Endereço</label><input type="text" class="form-control" id="companyEndereco" value="${currentEditCompany?.endereco||''}"></div>
      </div>
    `;
    document.getElementById('companyModal').classList.add('show');
  }

  function saveCompany() {
    const name = document.getElementById('companyName').value.trim();
    const cnpj = document.getElementById('companyCnpj').value.trim();
    if (!name || !cnpj) { toast('Nome e CNPJ são obrigatórios!', 'error'); return; }
    if (!validarCNPJ(cnpj)) { toast('CNPJ inválido!', 'error'); return; }
    const data = { name, cnpj, contato: document.getElementById('companyContato').value.trim(), telefone: document.getElementById('companyTelefone').value.trim(), endereco: document.getElementById('companyEndereco').value.trim() };
    if (currentEditCompany) { Object.assign(currentEditCompany, data); toast('Empresa atualizada!', 'success'); }
    else { DB.companies.push({ id: DB.nextId.companies++, ...data }); toast('Empresa criada!', 'success'); }
    saveToStorage(); closeModal('companyModal'); renderDashboard('companies');
  }

  function deleteCompany(id) {
    if (!isAdmin()) { toast('Ação restrita ao administrador.','error'); return; }
    if (!confirm('Excluir esta empresa?')) return;
    if (DB.supplies.some(s=>s.companyId===id)) { toast('Não é possível excluir empresa com abastecimentos vinculados!', 'error'); return; }
    DB.companies = DB.companies.filter(c=>c.id!==id);
    saveToStorage(); toast('Empresa excluída!', 'success'); renderDashboard('companies');
  }

  // =====================================================================
  //  EMBARCAÇÕES
  // =====================================================================
  function renderVessels(container) {
    let filtered = DB.vessels;
    if (vesselsSearch) filtered = filtered.filter(v=>v.name.toLowerCase().includes(vesselsSearch.toLowerCase())||v.sigla.toLowerCase().includes(vesselsSearch.toLowerCase()));
    filtered.sort((a,b)=>{ if(a[vesselsSort.column]<b[vesselsSort.column]) return vesselsSort.direction==='asc'?-1:1; if(a[vesselsSort.column]>b[vesselsSort.column]) return vesselsSort.direction==='asc'?1:-1; return 0; });
    const totalPages = Math.ceil(filtered.length/config.rowsPerPage.vessels);
    const start=(vesselsPage-1)*config.rowsPerPage.vessels;
    const paginated=filtered.slice(start,start+config.rowsPerPage.vessels);

    container.innerHTML = `
      <div class="filter-bar">
        <div class="filter-group"><span class="filter-label">Buscar:</span><input type="text" class="search-box" placeholder="Nome ou sigla" value="${vesselsSearch}" onkeyup="vesselsSearch=this.value;vesselsPage=1;renderDashboard('vessels')"></div>
        ${isAdmin() ? `<button class="btn btn-primary btn-sm" onclick="openVesselModal()"><i class="fas fa-plus"></i> Nova Embarcação</button>` : ''}
      </div>
      <div class="table-container">
        <div class="table-header"><h3>Embarcações</h3></div>
        <div class="table-responsive"><table>
          <thead><tr>
            <th onclick="sortVessels('name')">Nome</th>
            <th>Sigla</th>
            <th>Material</th>
            <th>CC</th><th>CR</th><th>Tripulação</th>
            <th>Cap. Óleo (m³)</th>
            <th>Cap. Água (m³)</th>
            <th>Ações</th>
          </tr></thead>
          <tbody>${paginated.map(v=>`<tr>
            <td><strong>${v.name}</strong></td>
            <td><span class="pill ${v.material==='Aço'?'pill-aco':'pill-madeira'}">${v.sigla}</span></td>
            <td>${v.material}</td>
            <td>${v.cc}</td><td>${v.cr}</td><td>${v.tripulacao}</td>
            <td class="text-oleo"><strong>${v.capacidadeOleo||v.capacidade||0}</strong></td>
            <td class="text-agua"><strong>${v.capacidadeAgua||0}</strong></td>
            <td>
              ${isAdmin() ? `
              <button class="btn btn-sm btn-outline btn-icon" onclick="openVesselModal(${v.id})"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-danger btn-icon" onclick="deleteVessel(${v.id})"><i class="fas fa-trash"></i></button>
              ` : `<span style="font-size:11px;color:var(--text-secondary)">somente leitura</span>`}
            </td>
          </tr>`).join('')}</tbody>
        </table></div>
        <div class="pagination">
          <button onclick="changeVesselsPage(1)" ${vesselsPage===1?'disabled':''}><i class="fas fa-angle-double-left"></i></button>
          <button onclick="changeVesselsPage(${vesselsPage-1})" ${vesselsPage===1?'disabled':''}><i class="fas fa-angle-left"></i></button>
          <span>Página ${vesselsPage} de ${totalPages||1}</span>
          <button onclick="changeVesselsPage(${vesselsPage+1})" ${vesselsPage>=totalPages?'disabled':''}><i class="fas fa-angle-right"></i></button>
          <button onclick="changeVesselsPage(${totalPages})" ${vesselsPage>=totalPages?'disabled':''}><i class="fas fa-angle-double-right"></i></button>
        </div>
      </div>
    `;
  }

  function sortVessels(col) { if(vesselsSort.column===col) vesselsSort.direction=vesselsSort.direction==='asc'?'desc':'asc'; else{vesselsSort.column=col;vesselsSort.direction='asc';} vesselsPage=1; renderDashboard('vessels'); }
  function changeVesselsPage(p) { vesselsPage=p; renderDashboard('vessels'); }

  function openVesselModal(editId=null) {
    if (!isAdmin()) { toast('Ação restrita ao administrador.','error'); return; }
    currentEditVessel = editId ? DB.vessels.find(v=>v.id===editId) : null;
    document.getElementById('vesselModalTitle').innerText = currentEditVessel ? 'Editar Embarcação' : 'Nova Embarcação';
    const v = currentEditVessel;
    document.getElementById('vesselModalBody').innerHTML = `
      <div class="form-row">
        <div class="form-group"><label class="form-label">Nome *</label><input type="text" class="form-control" id="vesselName" value="${v?.name||''}"></div>
        <div class="form-group"><label class="form-label">Sigla *</label><input type="text" class="form-control" id="vesselSigla" value="${v?.sigla||''}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Material</label><select class="form-control" id="vesselMaterial"><option value="Aço" ${v?.material==='Aço'?'selected':''}>Aço</option><option value="Madeira" ${v?.material==='Madeira'?'selected':''}>Madeira</option></select></div>
        <div class="form-group"><label class="form-label">Tripulação</label><input type="number" class="form-control" id="vesselTripulacao" value="${v?.tripulacao||''}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">CC</label><input type="number" class="form-control" id="vesselCc" value="${v?.cc||''}"></div>
        <div class="form-group"><label class="form-label">CR *</label><input type="text" class="form-control" id="vesselCr" value="${v?.cr||''}"></div>
      </div>
      <hr class="section-divider">
      <div class="info-box"><i class="fas fa-info-circle"></i> Informe as capacidades máximas dos tanques em m³ (1 m³ = 1.000 L)</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label" style="color:var(--oleo-color)">Capacidade Tanque Óleo (m³) *</label><input type="number" class="form-control" id="vesselCapOleo" step="0.1" min="0" value="${v?.capacidadeOleo||v?.capacidade||''}"></div>
        <div class="form-group"><label class="form-label" style="color:var(--agua-color)">Capacidade Tanque Água (m³) *</label><input type="number" class="form-control" id="vesselCapAgua" step="0.1" min="0" value="${v?.capacidadeAgua||''}"></div>
      </div>
    `;
    document.getElementById('vesselModal').classList.add('show');
  }

  function saveVessel() {
    const name = document.getElementById('vesselName').value.trim();
    const sigla = document.getElementById('vesselSigla').value.trim();
    const cr = document.getElementById('vesselCr').value.trim();
    if (!name || !sigla || !cr) { toast('Preencha os campos obrigatórios!', 'error'); return; }
    const data = {
      name, sigla, cr,
      material: document.getElementById('vesselMaterial').value,
      cc: parseInt(document.getElementById('vesselCc').value)||0,
      tripulacao: parseInt(document.getElementById('vesselTripulacao').value)||0,
      capacidadeOleo: parseFloat(document.getElementById('vesselCapOleo').value)||0,
      capacidadeAgua: parseFloat(document.getElementById('vesselCapAgua').value)||0,
    };
    if (currentEditVessel) { Object.assign(currentEditVessel, data); toast('Embarcação atualizada!', 'success'); }
    else { DB.vessels.push({ id: DB.nextId.vessels++, ...data }); toast('Embarcação criada!', 'success'); }
    saveToStorage(); closeModal('vesselModal'); renderDashboard('vessels');
  }

  function deleteVessel(id) {
    if (!isAdmin()) { toast('Ação restrita ao administrador.','error'); return; }
    if (!confirm('Excluir esta embarcação?')) return;
    if (DB.supplies.some(s=>s.vesselId===id||s.embarcacaoOrigemId===id||s.embarcacaoDestinoId===id)) { toast('Não é possível excluir embarcação com movimentações!', 'error'); return; }
    DB.vessels = DB.vessels.filter(v=>v.id!==id);
    saveToStorage(); toast('Embarcação excluída!', 'success'); renderDashboard('vessels');
  }

  // =====================================================================
  //  LOGS
  // =====================================================================
  let logsSearch = '';
  function renderLogs(container) {
    container.innerHTML = `
      <div class="filter-bar" style="flex-wrap:wrap;gap:10px;">
        <div class="filter-group"><span class="filter-label">Buscar:</span><input type="text" class="search-box" placeholder="Embarcação, empresa, obs..." value="${logsSearch}" onkeyup="logsSearch=this.value;filterLogs()"></div>
        <div class="filter-group"><span class="filter-label">Embarcação:</span><select class="filter-select" id="logVesselFilter" onchange="filterLogs()"><option value="all">Todas</option>${minhasEmbarcacoes().map(v=>`<option value="${v.id}">${v.sigla} — ${v.name}</option>`).join('')}</select></div>
        <div class="filter-group"><span class="filter-label">Fluido:</span><select class="filter-select" id="logFluidoFilter" onchange="filterLogs()"><option value="all">Todos</option><option value="oleo">🛢 Óleo</option><option value="agua">💧 Água</option></select></div>
        <div class="filter-group"><span class="filter-label">Tipo:</span><select class="filter-select" id="logTypeFilter" onchange="filterLogs()"><option value="all">Todos</option><option value="compra">Compra</option><option value="passagem">Passagem (entrada)</option><option value="passagem_saida">Passagem (saída)</option><option value="consumo_op">🔥 Consumo Operacional</option></select></div>
        <div class="filter-group"><span class="filter-label">De:</span><input type="date" class="filter-select" id="logDateStart" value="${new Date(new Date().setDate(new Date().getDate()-30)).toISOString().split('T')[0]}" onchange="filterLogs()"></div>
        <div class="filter-group"><span class="filter-label">Até:</span><input type="date" class="filter-select" id="logDateEnd" value="${new Date().toISOString().split('T')[0]}" onchange="filterLogs()"></div>
        <button class="btn btn-outline btn-sm" onclick="clearLogFilters()"><i class="fas fa-times"></i> Limpar</button>
      </div>
      <div class="table-container"><div class="table-header"><h3>Registro de Movimentações</h3><span id="logsCount" class="badge">0 registros</span></div><div class="table-responsive" id="logsTableContainer"></div></div>
    `;
    filterLogs();
  }

  function filterLogs() {
    const vessel = document.getElementById('logVesselFilter')?.value || 'all';
    const fluido = document.getElementById('logFluidoFilter')?.value || 'all';
    const tipo   = document.getElementById('logTypeFilter')?.value || 'all';
    const start  = document.getElementById('logDateStart')?.value || '';
    const end    = document.getElementById('logDateEnd')?.value || '';
    const q      = logsSearch.toLowerCase();

    const myVIdsL = new Set(minhasEmbarcacoes().map(v=>v.id));
    let f = DB.supplies.filter(s => myVIdsL.has(s.vesselId) && (!start||s.data>=start) && (!end||s.data<=end));
    if (vessel !== 'all') f = f.filter(s=>s.vesselId===parseInt(vessel)||s.embarcacaoOrigemId===parseInt(vessel)||s.embarcacaoDestinoId===parseInt(vessel));
    if (fluido !== 'all') f = f.filter(s=>(fluido==='oleo'?(s.tipoFluido==='oleo'||!s.tipoFluido):s.tipoFluido===fluido));
    if (tipo   !== 'all') f = f.filter(s=>s.tipoOperacao===tipo);
    if (q) {
      f = f.filter(s => {
        const v = DB.vessels.find(x=>x.id===s.vesselId);
        const c = DB.companies.find(x=>x.id===s.companyId);
        return (v?.name||'').toLowerCase().includes(q) ||
               (v?.sigla||'').toLowerCase().includes(q) ||
               (c?.name||'').toLowerCase().includes(q) ||
               (s.observacao||'').toLowerCase().includes(q);
      });
    }
    f.sort((a,b)=>b.data.localeCompare(a.data)||b.id-a.id);

    const badge = document.getElementById('logsCount');
    if (badge) badge.textContent = `${f.length} registros`;

    let html = '<table><thead><tr><th>Data</th><th>Embarcação</th><th>Fluido</th><th>Tipo</th><th>Antes (L)</th><th>Movimentado</th><th>Após (L)</th><th>Empresa / Origem</th><th>Obs.</th></tr></thead><tbody>';
    if (!f.length) html += '<tr><td colspan="9" style="text-align:center;padding:32px;color:var(--text-secondary)">Nenhum registro encontrado</td></tr>';
    f.forEach(s => {
      const v=s.vesselId?DB.vessels.find(x=>x.id===s.vesselId):null;
      const emp=s.companyId?DB.companies.find(c=>c.id===s.companyId)?.name:'—';
      const isConsumo = s.tipoOperacao === 'consumo_op';
      const tipoLabel = s.tipoOperacao==='compra' ? 'Compra'
                      : s.tipoOperacao==='passagem' ? 'Pass. entrada'
                      : s.tipoOperacao==='passagem_saida' ? 'Pass. saída'
                      : s.tipoOperacao==='consumo_op' ? '🔥 Consumo Op.' : s.tipoOperacao;
      const tipoPill  = s.tipoOperacao==='compra' ? 'pill-compra'
                      : s.tipoOperacao==='consumo_op' ? 'pill-consumo'
                      : 'pill-passagem';
      const movLabel  = isConsumo
        ? `<strong style="color:var(--danger)">−${s.quantidade.toLocaleString()}</strong>`
        : `<strong>${s.quantidade.toLocaleString()}</strong>`;
      html+=`<tr${isConsumo?' style="background:rgba(220,100,0,0.025);"':''}>
        <td>${new Date(s.data+'T12:00:00').toLocaleDateString('pt-BR')}</td>
        <td><span class="pill ${v?.material==='Aço'?'pill-aco':'pill-madeira'}">${v?.sigla||'—'}</span></td>
        <td><span class="pill ${s.tipoFluido==='agua'?'pill-agua':'pill-oleo'}">${s.tipoFluido==='agua'?'💧 Água':'🛢 Óleo'}</span></td>
        <td><span class="pill ${tipoPill}">${tipoLabel}</span></td>
        <td>${(s.quantidadeAntes||0).toLocaleString()}</td>
        <td>${movLabel}</td>
        <td><strong>${(s.quantidadeBordo||0).toLocaleString()}</strong></td>
        <td>${emp}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${s.observacao||''}">${s.observacao||''}</td>
      </tr>`;
    });
    html+='</tbody></table>';
    document.getElementById('logsTableContainer').innerHTML=html;
  }

  function clearLogFilters() {
    logsSearch='';
    ['logVesselFilter','logFluidoFilter','logTypeFilter'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='all';});
    const hoje=new Date().toISOString().split('T')[0];
    const trinta=new Date(new Date().setDate(new Date().getDate()-30)).toISOString().split('T')[0];
    const ds=document.getElementById('logDateStart'); if(ds)ds.value=trinta;
    const de=document.getElementById('logDateEnd'); if(de)de.value=hoje;
    filterLogs();
  }

  // =====================================================================
  //  CONSUMO
  // =====================================================================
  function renderConsumption(container) {
    const consumoOleo={}, consumoAgua={}, gastoTotal={};
    DB.supplies.forEach(s=>{
      if(s.quantidade>0 && s.tipoOperacao==='compra'){
        if(s.tipoFluido==='agua') consumoAgua[s.vesselId]=(consumoAgua[s.vesselId]||0)+s.quantidade;
        else { consumoOleo[s.vesselId]=(consumoOleo[s.vesselId]||0)+s.quantidade; gastoTotal[s.vesselId]=(gastoTotal[s.vesselId]||0)+(s.valorTotal||0); }
      }
    });
    const dados=DB.vessels.map(v=>({label:v.sigla,name:v.name,oleo:consumoOleo[v.id]||0,agua:consumoAgua[v.id]||0,gasto:gastoTotal[v.id]||0,material:v.material})).sort((a,b)=>b.oleo-a.oleo);

    container.innerHTML=`
      <div class="chart-card"><div class="card-header"><h3>Consumo por Embarcação (compras externas)</h3></div><div class="chart-container"><canvas id="consumptionChart"></canvas></div></div>
      <div class="table-container" style="margin-top:20px;">
        <div class="table-header"><h3>Detalhamento por Embarcação</h3></div>
        <div class="table-responsive"><table>
          <thead><tr><th>Embarcação</th><th>Material</th><th class="text-oleo">Total Óleo (L)</th><th class="text-oleo">Gasto Óleo (R$)</th><th class="text-oleo">Preço Médio</th><th class="text-agua">Total Água (L)</th></tr></thead>
          <tbody>${dados.map(d=>`<tr>
            <td><strong>${d.name}</strong></td>
            <td><span class="pill ${d.material==='Aço'?'pill-aco':'pill-madeira'}">${d.material}</span></td>
            <td class="text-oleo"><strong>${d.oleo.toLocaleString()}</strong></td>
            <td style="color:var(--success)">${d.gasto>0?formatMoney(d.gasto):'—'}</td>
            <td>${d.oleo>0&&d.gasto>0?formatMoney(d.gasto/d.oleo)+'/L':'—'}</td>
            <td class="text-agua">${d.agua.toLocaleString()}</td>
          </tr>`).join('')}</tbody>
        </table></div>
      </div>
    `;
    setTimeout(()=>{
      const ctx=document.getElementById('consumptionChart')?.getContext('2d');
      if(!ctx)return;
      if(charts.consumption)charts.consumption.destroy();
      charts.consumption=new Chart(ctx,{type:'bar',data:{labels:dados.map(d=>d.label),datasets:[{label:'Óleo (L)',data:dados.map(d=>d.oleo),backgroundColor:'rgba(14,165,233,0.7)',borderRadius:4},{label:'Água (L)',data:dados.map(d=>d.agua),backgroundColor:'rgba(6,182,212,0.5)',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true,title:{display:true,text:'Litros'}}}}});
    },80);
  }

  // =====================================================================
  //  CONSUMO OPERACIONAL
  // =====================================================================
  let consumoOpSearch = '', consumoOpVessel = 'all', consumoOpDate = '';

  function renderConsumoOp(container) {
    const hoje = new Date().toISOString().split('T')[0];
    let registros = (DB.consumoOp||[]).slice();

    // Filtros
    if (consumoOpVessel !== 'all') registros = registros.filter(r => r.vesselId === parseInt(consumoOpVessel));
    if (consumoOpDate)             registros = registros.filter(r => r.data === consumoOpDate);
    if (consumoOpSearch) {
      const q = consumoOpSearch.toLowerCase();
      registros = registros.filter(r => {
        const v = DB.vessels.find(x=>x.id===r.vesselId);
        return (v?.name||'').toLowerCase().includes(q) || (v?.sigla||'').toLowerCase().includes(q) || (r.observacao||'').toLowerCase().includes(q);
      });
    }
    registros.sort((a,b) => b.data.localeCompare(a.data) || b.id - a.id);

    // Totais para cards
    const allReg = DB.consumoOp||[];
    const totalOleo = allReg.reduce((a,r)=>a+(r.qtdOleo||0),0);
    const totalAgua = allReg.reduce((a,r)=>a+(r.qtdAgua||0),0);
    const byVessel = {};
    allReg.forEach(r=>{ byVessel[r.vesselId]=(byVessel[r.vesselId]||0)+(r.qtdOleo||0); });
    const topVessel = Object.entries(byVessel).sort((a,b)=>b[1]-a[1])[0];
    const topV = topVessel ? DB.vessels.find(v=>v.id===parseInt(topVessel[0])) : null;

    container.innerHTML = `
      <div class="kpi-grid" style="margin-bottom:16px;">
        <div class="kpi-card kpi-card-oleo"><div class="kpi-icon kpi-icon-oleo"><i class="fas fa-oil-can"></i></div><div class="kpi-label">Total Óleo Consumido</div><div class="kpi-value">${totalOleo.toLocaleString()} L</div><div class="kpi-trend">${allReg.length} lançamentos</div></div>
        <div class="kpi-card kpi-card-agua"><div class="kpi-icon kpi-icon-agua"><i class="fas fa-tint"></i></div><div class="kpi-label">Total Água Consumida</div><div class="kpi-value">${totalAgua.toLocaleString()} L</div></div>
        <div class="kpi-card kpi-card-neutral"><div class="kpi-icon kpi-icon-neutral"><i class="fas fa-ship"></i></div><div class="kpi-label">Maior Consumidor</div><div class="kpi-value">${topV?.sigla||'—'}</div><div class="kpi-trend">${topVessel?topVessel[1].toLocaleString()+' L':''}</div></div>
        <div class="kpi-card kpi-card-neutral" style="cursor:pointer;" onclick="document.getElementById('consumoOpForm').scrollIntoView({behavior:'smooth'})"><div class="kpi-icon kpi-icon-success"><i class="fas fa-plus-circle"></i></div><div class="kpi-label">Novo Lançamento</div><div class="kpi-value" style="font-size:14px;">Registrar consumo</div></div>
      </div>

      <!-- FORMULÁRIO DE LANÇAMENTO -->
      <div class="card" id="consumoOpForm" style="margin-bottom:20px;">
        <div class="card-header"><h3><i class="fas fa-fire" style="color:var(--warning);margin-right:8px;"></i>Lançar Consumo Operacional</h3><span style="font-size:12px;color:var(--text-secondary)">Deduz automaticamente do estoque a bordo</span></div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Embarcação *</label>
            <select class="form-control" id="cOp_vessel" onchange="atualizarEstoqueInfo()">
              <option value="">Selecione...</option>
              ${minhasEmbarcacoes().map(v=>`<option value="${v.id}">${v.sigla} — ${v.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Data *</label>
            <input type="date" class="form-control" id="cOp_data" value="${hoje}" max="${hoje}">
          </div>
        </div>
        <div id="cOp_estoqueInfo" style="display:none;background:var(--gray-50);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:12px 16px;margin-bottom:16px;font-size:13px;">
          <div style="display:flex;gap:24px;flex-wrap:wrap;">
            <div><span style="color:var(--text-secondary)">Estoque Óleo: </span><strong id="cOp_saldoOleo" style="color:var(--oleo-color)">—</strong></div>
            <div><span style="color:var(--text-secondary)">Estoque Água: </span><strong id="cOp_saldoAgua" style="color:var(--agua-color)">—</strong></div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" style="color:var(--oleo-color)">Óleo Consumido (L)</label>
            <input type="number" class="form-control" id="cOp_oleo" min="0" step="0.1" placeholder="0" oninput="atualizarPreview()">
          </div>
          <div class="form-group">
            <label class="form-label" style="color:var(--agua-color)">Água Consumida (L)</label>
            <input type="number" class="form-control" id="cOp_agua" min="0" step="0.1" placeholder="0" oninput="atualizarPreview()">
          </div>
          <div class="form-group">
            <label class="form-label">Horas de Operação</label>
            <input type="number" class="form-control" id="cOp_horas" min="0" step="0.5" placeholder="0">
          </div>
        </div>
        <div id="cOp_previewSaldo" style="display:none;background:rgba(220,100,0,0.05);border:1px solid rgba(220,100,0,0.18);border-radius:var(--radius-lg);padding:10px 16px;margin-bottom:12px;font-size:13px;">
          <div style="display:flex;gap:24px;flex-wrap:wrap;">
            <div id="cOp_prevOleo"></div>
            <div id="cOp_prevAgua"></div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Observação / Motivo</label>
          <input type="text" class="form-control" id="cOp_obs" placeholder="Ex: Operação noturna, patrulha, etc.">
        </div>
        <div style="display:flex;gap:10px;margin-top:4px;">
          <button class="btn btn-primary" onclick="saveConsumoOp()"><i class="fas fa-save"></i> Registrar Consumo</button>
          <button class="btn btn-outline" onclick="clearConsumoOpForm()"><i class="fas fa-eraser"></i> Limpar</button>
        </div>
      </div>

      <!-- FILTROS E TABELA -->
      <div class="filter-bar" style="flex-wrap:wrap;gap:10px;">
        <div class="filter-group"><span class="filter-label">Buscar:</span><input type="text" class="search-box" placeholder="Embarcação ou obs..." value="${consumoOpSearch}" onkeyup="consumoOpSearch=this.value;renderDashboard('consumoOp')"></div>
        <div class="filter-group"><span class="filter-label">Embarcação:</span>
          <select class="filter-select" onchange="consumoOpVessel=this.value;renderDashboard('consumoOp')">
            <option value="all" ${consumoOpVessel==='all'?'selected':''}>Todas</option>
            ${DB.vessels.map(v=>`<option value="${v.id}" ${consumoOpVessel==v.id?'selected':''}>${v.sigla}</option>`).join('')}
          </select>
        </div>
        <div class="filter-group"><span class="filter-label">Data:</span><input type="date" class="filter-select" value="${consumoOpDate}" onchange="consumoOpDate=this.value;renderDashboard('consumoOp')"></div>
        <button class="btn btn-outline btn-sm" onclick="consumoOpSearch='';consumoOpVessel='all';consumoOpDate='';renderDashboard('consumoOp')"><i class="fas fa-times"></i> Limpar</button>
      </div>

      <div class="table-container">
        <div class="table-header"><h3>Histórico de Consumo Operacional</h3><span class="badge">${registros.length} registros</span></div>
        <div class="table-responsive"><table>
          <thead><tr><th>Data</th><th>Embarcação</th><th class="text-oleo">Óleo (L)</th><th style="font-size:11px;color:var(--text-secondary)">Saldo antes→depois</th><th class="text-agua">Água (L)</th><th style="font-size:11px;color:var(--text-secondary)">Saldo antes→depois</th><th>Horas Op.</th><th>L/hora</th><th>Observação</th><th>Ações</th></tr></thead>
          <tbody>${registros.length ? registros.map(r => {
            const v = DB.vessels.find(x=>x.id===r.vesselId);
            const lph = r.horas > 0 ? ((r.qtdOleo||0)/r.horas).toFixed(1) : '—';
            // look up linked supply entries for before/after
            const supOleo = DB.supplies.find(s=>s.consumoOpId===r.id && s.tipoFluido==='oleo' && s.tipoOperacao==='consumo_op');
            const supAgua = DB.supplies.find(s=>s.consumoOpId===r.id && s.tipoFluido==='agua' && s.tipoOperacao==='consumo_op');
            const oleoAntes = supOleo ? (supOleo.quantidadeAntes||0).toLocaleString()+' L' : '—';
            const oleoDepois= supOleo ? (supOleo.quantidadeBordo||0).toLocaleString()+' L' : '—';
            const aguaAntes = supAgua ? (supAgua.quantidadeAntes||0).toLocaleString()+' L' : '—';
            const aguaDepois= supAgua ? (supAgua.quantidadeBordo||0).toLocaleString()+' L' : '—';
            return `<tr>
              <td>${new Date(r.data+'T12:00:00').toLocaleDateString('pt-BR')}</td>
              <td><span class="pill ${v?.material==='Aço'?'pill-aco':'pill-madeira'}">${v?.sigla||'?'}</span> <span style="font-size:11px;color:var(--text-secondary)">${v?.name||''}</span></td>
              <td class="text-oleo"><strong>${(r.qtdOleo||0)>0?(r.qtdOleo).toLocaleString():'—'}</strong></td>
              <td style="font-size:11px;color:var(--text-secondary)">${(r.qtdOleo||0)>0?`${oleoAntes} → <strong style="color:var(--danger)">${oleoDepois}</strong>`:'—'}</td>
              <td class="text-agua">${(r.qtdAgua||0)>0?(r.qtdAgua).toLocaleString():'—'}</td>
              <td style="font-size:11px;color:var(--text-secondary)">${(r.qtdAgua||0)>0?`${aguaAntes} → <strong style="color:var(--danger)">${aguaDepois}</strong>`:'—'}</td>
              <td>${r.horas>0?r.horas+'h':'—'}</td>
              <td>${lph !== '—' ? lph+' L/h' : '—'}</td>
              <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${r.observacao||''}">${r.observacao||''}</td>
              <td>${isAdmin() ? `
                <button class="btn btn-sm btn-danger btn-icon" onclick="deleteConsumoOp(${r.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                ` : `
                <button class="btn-solicitar" onclick="solicitarCorrecao('consumoOp', ${r.id}, 'Consumo Operacional de ${DB.vessels.find(v=>v.id===r.vesselId)?.sigla||"?"} em ${r.data}')" title="Solicitar correção"><i class="fas fa-exclamation-circle"></i> Corrigir</button>
                `}</td>
            </tr>`;
          }).join('') : '<tr><td colspan="10" style="text-align:center;padding:32px;color:var(--text-secondary)">Nenhum lançamento encontrado</td></tr>'}</tbody>
        </table></div>
      </div>
    `;
  }

  function saveConsumoOp() {
    const vesselId = parseInt(document.getElementById('cOp_vessel').value);
    const data = document.getElementById('cOp_data').value;
    const qtdOleo = parseFloat(document.getElementById('cOp_oleo').value) || 0;
    const qtdAgua = parseFloat(document.getElementById('cOp_agua').value) || 0;
    const horas = parseFloat(document.getElementById('cOp_horas').value) || 0;
    const observacao = document.getElementById('cOp_obs').value.trim();

    if (!vesselId) { toast('Selecione uma embarcação!', 'error'); return; }
    if (!data)     { toast('Informe a data!', 'error'); return; }
    if (qtdOleo <= 0 && qtdAgua <= 0) { toast('Informe pelo menos uma quantidade > 0!', 'error'); return; }

    // ── Validar estoque suficiente ──
    if (qtdOleo > 0) {
      const estoqueOleo = getPosicaoAtual(vesselId, 'oleo');
      if (qtdOleo > estoqueOleo) {
        toast(`Estoque de óleo insuficiente! Disponível: ${estoqueOleo.toLocaleString()} L`, 'error');
        return;
      }
    }
    if (qtdAgua > 0) {
      const estoqueAgua = getPosicaoAtual(vesselId, 'agua');
      if (qtdAgua > estoqueAgua) {
        toast(`Estoque de água insuficiente! Disponível: ${estoqueAgua.toLocaleString()} L`, 'error');
        return;
      }
    }

    if (!DB.consumoOp) DB.consumoOp = [];
    if (!DB.nextId.consumoOp) DB.nextId.consumoOp = 1;
    const consumoUserId = currentUser?.id; const consumoUserNome = currentUser?.nome;

    const consumoOpId = DB.nextId.consumoOp++;
    DB.consumoOp.push({ id: consumoOpId, vesselId, data, qtdOleo, qtdAgua, horas, observacao });

    // ── Criar registros de débito em DB.supplies (fonte da verdade do estoque) ──
    const obs = `Consumo operacional${observacao ? ': ' + observacao : ''}`;

    if (qtdOleo > 0) {
      const antesOleo = getPosicaoAtual(vesselId, 'oleo');
      DB.supplies.push({
        id: DB.nextId.supplies++,
        consumoOpId,
        vesselId,
        companyId: null,
        data,
        tipoFluido: 'oleo',
        tipoOperacao: 'consumo_op',
        quantidade: qtdOleo,
        quantidadeAntes: antesOleo,
        quantidadeSolicitada: qtdOleo,
        quantidadeBordo: Math.max(0, antesOleo - qtdOleo),
        valorUnitario: 0,
        valorTotal: 0,
        observacao: obs
      });
    }

    if (qtdAgua > 0) {
      const antesAgua = getPosicaoAtual(vesselId, 'agua');
      DB.supplies.push({
        id: DB.nextId.supplies++,
        consumoOpId,
        vesselId,
        companyId: null,
        data,
        tipoFluido: 'agua',
        tipoOperacao: 'consumo_op',
        quantidade: qtdAgua,
        quantidadeAntes: antesAgua,
        quantidadeSolicitada: qtdAgua,
        quantidadeBordo: Math.max(0, antesAgua - qtdAgua),
        valorUnitario: 0,
        valorTotal: 0,
        observacao: obs
      });
    }

    saveToStorage();
    toast('Consumo registrado! Estoque deduzido automaticamente.', 'success');
    renderDashboard('consumoOp');
  }

  function deleteConsumoOp(id) {
    if (!isAdmin()) { toast('Ação restrita ao administrador.','error'); return; }
    if (!confirm('Excluir este lançamento? O estoque da embarcação será restaurado automaticamente.')) return;
    // Remove consumoOp record
    DB.consumoOp = (DB.consumoOp||[]).filter(r => r.id !== id);
    // Remove linked supply deduction entries — this restores the stock
    DB.supplies = DB.supplies.filter(s => s.consumoOpId !== id);
    saveToStorage();
    toast('Consumo excluído! Estoque restaurado.', 'success');
    renderDashboard('consumoOp');
  }

  function clearConsumoOpForm() {
    ['cOp_vessel','cOp_oleo','cOp_agua','cOp_horas','cOp_obs'].forEach(id=>{ const el=document.getElementById(id); if(el)el.value=''; });
    const hoje = new Date().toISOString().split('T')[0];
    const d = document.getElementById('cOp_data'); if(d) d.value = hoje;
    const info = document.getElementById('cOp_estoqueInfo'); if(info) info.style.display='none';
    const prev = document.getElementById('cOp_previewSaldo'); if(prev) prev.style.display='none';
  }

  window.atualizarEstoqueInfo = function() {
    const vesselId = parseInt(document.getElementById('cOp_vessel')?.value);
    const info = document.getElementById('cOp_estoqueInfo');
    if (!info) return;
    if (!vesselId) { info.style.display='none'; return; }
    const saldoOleo = getPosicaoAtual(vesselId, 'oleo');
    const saldoAgua = getPosicaoAtual(vesselId, 'agua');
    document.getElementById('cOp_saldoOleo').textContent = saldoOleo.toLocaleString() + ' L';
    document.getElementById('cOp_saldoAgua').textContent = saldoAgua.toLocaleString() + ' L';
    info.style.display = 'block';
    atualizarPreview();
  };

  window.atualizarPreview = function() {
    const vesselId = parseInt(document.getElementById('cOp_vessel')?.value);
    const prev = document.getElementById('cOp_previewSaldo');
    if (!prev || !vesselId) { if(prev) prev.style.display='none'; return; }
    const qtdOleo = parseFloat(document.getElementById('cOp_oleo')?.value) || 0;
    const qtdAgua = parseFloat(document.getElementById('cOp_agua')?.value) || 0;
    if (qtdOleo <= 0 && qtdAgua <= 0) { prev.style.display='none'; return; }
    const saldoOleo = getPosicaoAtual(vesselId,'oleo');
    const saldoAgua = getPosicaoAtual(vesselId,'agua');
    const novoOleo = Math.max(0, saldoOleo - qtdOleo);
    const novoAgua = Math.max(0, saldoAgua - qtdAgua);
    const fmtOleo = qtdOleo > 0
      ? `<i class="fas fa-oil-can" style="color:var(--oleo-color)"></i> Óleo: <span style="text-decoration:line-through;color:var(--text-secondary)">${saldoOleo.toLocaleString()} L</span> → <strong style="color:${qtdOleo>saldoOleo?'var(--danger)':'var(--success)'}">${novoOleo.toLocaleString()} L</strong>${qtdOleo>saldoOleo?' ⚠ insuficiente':''}`
      : '';
    const fmtAgua = qtdAgua > 0
      ? `<i class="fas fa-tint" style="color:var(--agua-color)"></i> Água: <span style="text-decoration:line-through;color:var(--text-secondary)">${saldoAgua.toLocaleString()} L</span> → <strong style="color:${qtdAgua>saldoAgua?'var(--danger)':'var(--success)'}">${novoAgua.toLocaleString()} L</strong>${qtdAgua>saldoAgua?' ⚠ insuficiente':''}`
      : '';
    document.getElementById('cOp_prevOleo').innerHTML = fmtOleo;
    document.getElementById('cOp_prevAgua').innerHTML = fmtAgua;
    prev.style.display = 'flex';
    prev.style.gap = '24px';
    prev.style.flexWrap = 'wrap';
    prev.style.alignItems = 'center';
  };

  // =====================================================================
  //  COMPARATIVO
  // =====================================================================
  function renderComparative(container) {
    const acoIds     = DB.vessels.filter(v=>v.material==='Aço').map(v=>v.id);
    const madeiraIds = DB.vessels.filter(v=>v.material==='Madeira').map(v=>v.id);
    const calc = (ids, field) => DB.supplies
      .filter(s => ids.includes(s.vesselId) && s.tipoOperacao==='compra' && (s.tipoFluido==='oleo'||!s.tipoFluido) && s.quantidade>0)
      .reduce((s,r) => s+(r[field]||0), 0);
    const totalAco=calc(acoIds,'quantidade'), totalMadeira=calc(madeiraIds,'quantidade');
    const gastoAco=calc(acoIds,'valorTotal'), gastoMadeira=calc(madeiraIds,'valorTotal');

    // Per-vessel data for bar chart
    const vesselLabels=[], vesselOleo=[], vesselColors=[];
    DB.vessels.forEach(v=>{
      const tot = DB.supplies.filter(s=>s.vesselId===v.id&&s.tipoOperacao==='compra'&&(s.tipoFluido==='oleo'||!s.tipoFluido)&&s.quantidade>0).reduce((a,s)=>a+s.quantidade,0);
      vesselLabels.push(v.sigla);
      vesselOleo.push(tot);
      vesselColors.push(v.material==='Aço' ? 'rgba(30,58,95,0.75)' : 'rgba(139,94,60,0.75)');
    });

    container.innerHTML=`
      <div class="kpi-grid">
        <div class="kpi-card kpi-card-neutral"><div class="kpi-icon kpi-icon-neutral"><i class="fas fa-anchor"></i></div><div class="kpi-label">Aço — Total Óleo</div><div class="kpi-value">${totalAco.toLocaleString()} L</div><div class="kpi-trend">${acoIds.length} embarcações</div></div>
        <div class="kpi-card kpi-card-neutral"><div class="kpi-icon kpi-icon-neutral"><i class="fas fa-ship"></i></div><div class="kpi-label">Madeira — Total Óleo</div><div class="kpi-value">${totalMadeira.toLocaleString()} L</div><div class="kpi-trend">${madeiraIds.length} embarcações</div></div>
        <div class="kpi-card kpi-card-neutral"><div class="kpi-icon kpi-icon-neutral"><i class="fas fa-dollar-sign"></i></div><div class="kpi-label">Aço — Custo Médio/L</div><div class="kpi-value">${formatMoney(totalAco>0?gastoAco/totalAco:0)}</div><div class="kpi-trend">${formatMoney(gastoAco)} total</div></div>
        <div class="kpi-card kpi-card-neutral"><div class="kpi-icon kpi-icon-neutral"><i class="fas fa-dollar-sign"></i></div><div class="kpi-label">Madeira — Custo Médio/L</div><div class="kpi-value">${formatMoney(totalMadeira>0?gastoMadeira/totalMadeira:0)}</div><div class="kpi-trend">${formatMoney(gastoMadeira)} total</div></div>
      </div>
      <div class="chart-grid">
        <div class="chart-card">
          <div class="card-header"><h3>Consumo por Embarcação</h3><span class="badge">Azul = Aço · Marrom = Madeira</span></div>
          <div class="chart-container"><canvas id="comparativeBarChart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="card-header"><h3>Proporção Aço vs Madeira</h3></div>
          <div class="chart-container-sm"><canvas id="comparativeDoughnut"></canvas></div>
          <div style="display:flex;justify-content:center;gap:20px;margin-top:12px;font-size:12px;">
            <span style="display:flex;align-items:center;gap:5px;"><span style="width:12px;height:12px;border-radius:2px;background:#1e3a5f;display:inline-block;"></span>Aço: ${totalAco.toLocaleString()} L</span>
            <span style="display:flex;align-items:center;gap:5px;"><span style="width:12px;height:12px;border-radius:2px;background:#8b5e3c;display:inline-block;"></span>Madeira: ${totalMadeira.toLocaleString()} L</span>
          </div>
        </div>
      </div>
    `;
    setTimeout(()=>{
      const ctx1 = document.getElementById('comparativeBarChart')?.getContext('2d');
      if (ctx1) {
        if (charts.comparativeBar) charts.comparativeBar.destroy();
        charts.comparativeBar = new Chart(ctx1, {
          type: 'bar',
          data: { labels: vesselLabels, datasets: [{ label: 'Óleo (L)', data: vesselOleo, backgroundColor: vesselColors, borderRadius: 5 }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Litros' } } } }
        });
      }
      const ctx2 = document.getElementById('comparativeDoughnut')?.getContext('2d');
      if (ctx2) {
        if (charts.comparativeDoughnut) charts.comparativeDoughnut.destroy();
        charts.comparativeDoughnut = new Chart(ctx2, {
          type: 'doughnut',
          data: { labels:['Aço','Madeira'], datasets:[{ data:[totalAco,totalMadeira], backgroundColor:['#1e3a5f','#8b5e3c'], borderWidth:2, borderColor:'#fff' }] },
          options: { responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label: c=>`${c.label}: ${c.raw.toLocaleString()} L` } } } }
        });
      }
    }, 80);
  }

  // =====================================================================
  //  RELATÓRIO NAVAL PDF
  // =====================================================================
  let relVessel = '', relDateStart = '', relDateEnd = '';

  function renderRelatorio(container) {
    const hoje = new Date().toISOString().split('T')[0];
    const trinta = new Date(new Date().setDate(new Date().getDate()-30)).toISOString().split('T')[0];
    if (!relDateStart) relDateStart = trinta;
    if (!relDateEnd)   relDateEnd   = hoje;

    // Build preview
    let preview = [];
    if (relVessel) {
      let f = DB.supplies.filter(s => s.vesselId === parseInt(relVessel) && s.tipoOperacao !== 'consumo_op');
      if (relDateStart) f = f.filter(s => s.data >= relDateStart);
      if (relDateEnd)   f = f.filter(s => s.data <= relDateEnd);
      f.sort((a,b)=>a.data.localeCompare(b.data)||a.id-b.id);
      // also consumoOp
      let op = (DB.consumoOp||[]).filter(r => r.vesselId === parseInt(relVessel));
      if (relDateStart) op = op.filter(r=>r.data>=relDateStart);
      if (relDateEnd)   op = op.filter(r=>r.data<=relDateEnd);
      preview = { supplies: f, consumoOp: op };
    }

    const vessel = DB.vessels.find(v=>v.id===parseInt(relVessel));
    const previewRows = preview.supplies ? preview.supplies.map(s => {
      const c = DB.companies.find(x=>x.id===s.companyId);
      return `<tr>
        <td>${new Date(s.data+'T12:00:00').toLocaleDateString('pt-BR')}</td>
        <td><span class="pill ${s.tipoFluido==='agua'?'pill-agua':'pill-oleo'}">${s.tipoFluido==='agua'?'💧 Água':'🛢 Óleo'}</span></td>
        <td><span class="pill ${s.tipoOperacao==='compra'?'pill-compra':'pill-passagem'}">${s.tipoOperacao==='compra'?'Compra':'Passagem'}</span></td>
        <td>${(s.quantidadeAntes||0).toLocaleString()} L</td>
        <td>${Math.abs(s.quantidade).toLocaleString()} L</td>
        <td>${(s.quantidadeBordo||0).toLocaleString()} L</td>
        <td>${s.valorTotal?formatMoney(s.valorTotal):'—'}</td>
        <td>${s.tipoOperacao==='passagem_saida'?('→ '+(DB.vessels.find(v=>v.id===s.embarcacaoDestinoId)?.sigla||'?')):s.tipoOperacao==='passagem'?('← '+(DB.vessels.find(v=>v.id===s.embarcacaoOrigemId)?.sigla||'?')):(c?.name||'—')}</td>
        <td>${s.observacao||''}</td>
      </tr>`;
    }).join('') : '';

    container.innerHTML = `
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header"><h3>Configurar Relatório Naval</h3></div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Embarcação *</label>
            <select class="form-control" onchange="relVessel=this.value;renderDashboard('relatorio')">
              <option value="">Selecione...</option>
              ${minhasEmbarcacoes().map(v=>`<option value="${v.id}" ${relVessel==v.id?'selected':''}>${v.sigla} — ${v.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Data Início</label>
            <input type="date" class="form-control" value="${relDateStart}" onchange="relDateStart=this.value;renderDashboard('relatorio')">
          </div>
          <div class="form-group">
            <label class="form-label">Data Fim</label>
            <input type="date" class="form-control" value="${relDateEnd}" onchange="relDateEnd=this.value;renderDashboard('relatorio')">
          </div>
        </div>
        ${vessel ? `
        <div style="background:var(--gray-50);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:16px;margin-bottom:16px;">
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            <div><span class="pill ${vessel.material==='Aço'?'pill-aco':'pill-madeira'}" style="font-size:13px;padding:4px 12px;">${vessel.sigla}</span></div>
            <div><strong>${vessel.name}</strong></div>
            <div style="font-size:12px;color:var(--text-secondary)">Material: ${vessel.material} · CC: ${vessel.cc} · CR: ${vessel.cr} · Tripulação: ${vessel.tripulacao}</div>
            <div style="font-size:12px;color:var(--text-secondary)">Cap. Óleo: ${vessel.capacidadeOleo}kL · Cap. Água: ${vessel.capacidadeAgua}kL</div>
            <div style="margin-left:auto;"><span class="badge badge-oleo">${preview.supplies?.length||0} movimentações</span></div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="gerarPDFNaval()">
          <i class="fas fa-file-pdf"></i> Gerar PDF Naval
        </button>
        <button class="btn btn-outline btn-sm" onclick="relVessel='';relDateStart='';relDateEnd='';renderDashboard('relatorio')" style="margin-left:8px;">
          <i class="fas fa-times"></i> Limpar
        </button>` : `<div class="info-box"><i class="fas fa-info-circle"></i> Selecione uma embarcação e o período para visualizar os eventos e gerar o relatório PDF.</div>`}
      </div>

      ${vessel && preview.supplies ? `
      <div class="table-container">
        <div class="table-header">
          <h3>Pré-visualização — ${vessel.sigla} · ${relDateStart?new Date(relDateStart+'T12:00:00').toLocaleDateString('pt-BR'):''} a ${relDateEnd?new Date(relDateEnd+'T12:00:00').toLocaleDateString('pt-BR'):''}</h3>
          <span class="badge">${preview.supplies.length} movimentações</span>
        </div>
        <div class="table-responsive"><table>
          <thead><tr><th>Data</th><th>Fluido</th><th>Tipo</th><th>Antes</th><th>Movimentado</th><th>Após</th><th>Valor</th><th>Empresa / Emb.</th><th>Obs.</th></tr></thead>
          <tbody>${previewRows || '<tr><td colspan="9" style="text-align:center;padding:24px;color:var(--text-secondary)">Nenhum evento no período</td></tr>'}</tbody>
        </table></div>
      </div>
      ${preview.consumoOp?.length > 0 ? `
      <div class="table-container" style="margin-top:16px;">
        <div class="table-header"><h3>Consumo Operacional no Período</h3><span class="badge">${preview.consumoOp.length} registros</span></div>
        <div class="table-responsive"><table>
          <thead><tr><th>Data</th><th>Óleo (L)</th><th>Água (L)</th><th>Horas</th><th>Observação</th></tr></thead>
          <tbody>${preview.consumoOp.map(r=>`<tr>
            <td>${new Date(r.data+'T12:00:00').toLocaleDateString('pt-BR')}</td>
            <td class="text-oleo">${(r.qtdOleo||0).toLocaleString()}</td>
            <td class="text-agua">${(r.qtdAgua||0).toLocaleString()}</td>
            <td>${r.horas>0?r.horas+'h':'—'}</td>
            <td>${r.observacao||''}</td>
          </tr>`).join('')}</tbody>
        </table></div>
      </div>` : ''}
      ` : ''}
    `;
  }

  function _hashId(str) {
    let h = 0x811c9dc5;
    for (let i = 0; i < str.length; i++) { h ^= str.charCodeAt(i); h = (h * 0x01000193) >>> 0; }
    return 'NAV-' + h.toString(16).toUpperCase().padStart(8,'0');
  }

  function gerarPDFNaval() {
    const vessel = DB.vessels.find(v=>v.id===parseInt(relVessel));
    if (!vessel) { toast('Selecione uma embarcação!','error'); return; }

    let f = DB.supplies.filter(s => s.vesselId===vessel.id && s.tipoOperacao!=='consumo_op');
    if (relDateStart) f = f.filter(s=>s.data>=relDateStart);
    if (relDateEnd)   f = f.filter(s=>s.data<=relDateEnd);
    f.sort((a,b)=>a.data.localeCompare(b.data)||a.id-b.id);

    let op = (DB.consumoOp||[]).filter(r=>r.vesselId===vessel.id);
    if (relDateStart) op = op.filter(r=>r.data>=relDateStart);
    if (relDateEnd)   op = op.filter(r=>r.data<=relDateEnd);
    op.sort((a,b)=>a.data.localeCompare(b.data));

    const { jsPDF } = window.jspdf;
    if (!jsPDF) { toast('Biblioteca jsPDF não carregada. Verifique conexão.','error'); return; }

    const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();

    // Cores
    const NAVY    = [15, 40, 80];
    const GOLD    = [180, 140, 40];
    const LTBLUE  = [230, 240, 255];
    const WHITE   = [255, 255, 255];
    const GRAY    = [100, 110, 130];

    const hashSeed = `${vessel.id}-${relDateStart}-${relDateEnd}-${f.length}-${Date.now()}`;
    const hashId   = _hashId(hashSeed);
    const geradoEm = new Date().toLocaleString('pt-BR');
    const operador = config.operadorNome || 'Sistema NavControl';

    const drawPage = (pageNum, totalPages) => {
      // Cabeçalho naval
      doc.setFillColor(...NAVY);
      doc.rect(0, 0, W, 22, 'F');

      // Linha dourada
      doc.setFillColor(...GOLD);
      doc.rect(0, 22, W, 1.5, 'F');

      // Logo - simbolo ASCII compativel com jsPDF/helvetica (sem Unicode alem de Latin-1)
      doc.setFontSize(14);
      doc.setFont('helvetica','bold');
      doc.setTextColor(...GOLD);
      // Desenhar um "âncora" geométrica simples com formas vetoriais
      // Círculo topo
      doc.setDrawColor(...GOLD);
      doc.setLineWidth(1.2);
      doc.circle(14, 7, 3, 'S');
      // Haste vertical
      doc.setLineWidth(1.5);
      doc.line(14, 10, 14, 18);
      // Travessa horizontal
      doc.line(10, 12, 18, 12);
      // Curvas base (simuladas com linhas diagonais)
      doc.line(14, 18, 10, 15);
      doc.line(14, 18, 18, 15);

      // Título
      doc.setFontSize(13);
      doc.setTextColor(...WHITE);
      doc.text('RELATÓRIO DE MOVIMENTAÇÃO DE COMBUSTÍVEL E ÁGUA', W/2, 10, {align:'center'});

      doc.setFontSize(8);
      doc.setTextColor(...GOLD);
      doc.text('SISTEMA DE GESTAO NAVAL - NAVCONTROL', W/2, 17, {align:'center'});

      // Hash no canto
      doc.setFontSize(7);
      doc.setTextColor(200,210,230);
      doc.text(`${hashId}`, W-10, 17, {align:'right'});
      doc.text(`Pág. ${pageNum}/${totalPages}`, W-10, 11, {align:'right'});

      // Barra azul clara - dados da embarcacao
      doc.setFillColor(...LTBLUE);
      doc.rect(0, 23.5, W, 18, 'F');
      doc.setDrawColor(...NAVY);
      doc.setLineWidth(0.3);
      doc.rect(0, 23.5, W, 18, 'S');

      doc.setFont('helvetica','bold');
      doc.setFontSize(9);
      doc.setTextColor(...NAVY);
      doc.text('EMBARCAÇÃO', 10, 29);
      doc.text('SIGLA', 90, 29);
      doc.text('MATERIAL', 130, 29);
      doc.text('CC / CR', 180, 29);
      doc.text('PERÍODO', 235, 29);

      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.text(vessel.name, 10, 37);
      doc.text(vessel.sigla, 90, 37);
      doc.text(vessel.material, 130, 37);
      doc.text(`${vessel.cc} / ${vessel.cr}`, 180, 37);
      const per = `${relDateStart?new Date(relDateStart+'T12:00:00').toLocaleDateString('pt-BR'):''} a ${relDateEnd?new Date(relDateEnd+'T12:00:00').toLocaleDateString('pt-BR'):''}`;
      doc.text(per, 235, 37);

      // Rodapé
      doc.setFillColor(...NAVY);
      doc.rect(0, H-12, W, 12, 'F');
      doc.setFillColor(...GOLD);
      doc.rect(0, H-12, W, 0.8, 'F');

      doc.setFont('helvetica','normal');
      doc.setFontSize(7);
      doc.setTextColor(200,210,230);
      doc.text(`Documento de auditoria | ${hashId} | Gerado em: ${geradoEm} | Operador: ${operador}`, W/2, H-6, {align:'center'});
      doc.text('Este documento é controlado e possui identificação única para fins de rastreabilidade.', W/2, H-2.5, {align:'center'});
    };

    // ---- PÁGINA 1: ABASTECIMENTOS ----
    drawPage(1, op.length > 0 ? 2 : 1);

    // Sumário
    const fEntradas = f.filter(s=>s.tipoOperacao!=='passagem_saida');
    const totalOleo = fEntradas.filter(s=>s.tipoFluido==='oleo'||!s.tipoFluido).reduce((a,s)=>a+s.quantidade,0);
    const totalAgua = fEntradas.filter(s=>s.tipoFluido==='agua').reduce((a,s)=>a+s.quantidade,0);
    const totalGasto = fEntradas.reduce((a,s)=>a+(s.valorTotal||0),0);

    doc.setFillColor(245,248,255);
    doc.rect(8, 43, (W-16)/3-4, 14, 'F');
    doc.rect(8+(W-16)/3, 43, (W-16)/3-4, 14, 'F');
    doc.rect(8+2*(W-16)/3, 43, (W-16)/3-4, 14, 'F');
    doc.setDrawColor(...NAVY);
    doc.setLineWidth(0.2);
    doc.rect(8, 43, (W-16)/3-4, 14, 'S');
    doc.rect(8+(W-16)/3, 43, (W-16)/3-4, 14, 'S');
    doc.rect(8+2*(W-16)/3, 43, (W-16)/3-4, 14, 'S');

    doc.setFont('helvetica','bold'); doc.setFontSize(7.5); doc.setTextColor(...GRAY);
    doc.text('TOTAL ÓLEO ABASTECIDO', 10, 48); doc.text('TOTAL ÁGUA ABASTECIDA', 10+(W-16)/3+2, 48); doc.text('CUSTO TOTAL ÓLEO', 10+2*(W-16)/3+2, 48);
    doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(...NAVY);
    doc.text(`${totalOleo.toLocaleString()} L`, 10, 54); doc.text(`${totalAgua.toLocaleString()} L`, 10+(W-16)/3+2, 54); doc.text(formatMoney(totalGasto), 10+2*(W-16)/3+2, 54);

    // Título tabela
    doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(...NAVY);
    doc.text('REGISTRO DE MOVIMENTAÇÕES', 8, 62);

    // Tabela autoTable
    if (f.length > 0) {
      doc.autoTable({
        startY: 64,
        margin: { left: 8, right: 8, bottom: 18 },
        head: [['Data','Fluido','Tipo Op.','Antes (L)','Movimentado (L)','Após (L)','V. Unit.','Valor Total','Empresa / Emb.','Observação']],
        body: f.map(s => {
          const c = DB.companies.find(x=>x.id===s.companyId);
          return [
            new Date(s.data+'T12:00:00').toLocaleDateString('pt-BR'),
            s.tipoFluido==='agua'?'Água':'Óleo',
            s.tipoOperacao==='compra'?'Compra':s.tipoOperacao==='passagem_saida'?'Pass. Saída':'Pass. Entrada',
            (s.quantidadeAntes||0).toLocaleString(),
            Math.abs(s.quantidade).toLocaleString(),
            (s.quantidadeBordo||0).toLocaleString(),
            s.valorUnitario?'R$'+s.valorUnitario.toFixed(2):'-',
            s.valorTotal?formatMoney(s.valorTotal):'-',
            s.tipoOperacao==='passagem_saida'?('>> '+(DB.vessels.find(v=>v.id===s.embarcacaoDestinoId)?.sigla||'?')):s.tipoOperacao==='passagem'?('<< '+(DB.vessels.find(v=>v.id===s.embarcacaoOrigemId)?.sigla||'?')):(c?.name||'-'),
            s.observacao||''
          ];
        }),
        headStyles: { fillColor: NAVY, textColor: WHITE, fontStyle:'bold', fontSize:7.5 },
        bodyStyles: { fontSize: 7, textColor: [30,30,50] },
        alternateRowStyles: { fillColor: LTBLUE },
        columnStyles: {
          0:{cellWidth:22}, 1:{cellWidth:16}, 2:{cellWidth:20},
          3:{cellWidth:22,halign:'right'}, 4:{cellWidth:22,halign:'right'},
          5:{cellWidth:22,halign:'right'}, 6:{cellWidth:20,halign:'right'},
          7:{cellWidth:26,halign:'right'}, 8:{cellWidth:35}, 9:{cellWidth:'auto'}
        },
        didDrawPage: (data) => {
          drawPage(data.pageNumber, op.length > 0 ? data.pageNumber+1 : data.pageNumber);
        }
      });
    } else {
      doc.setFontSize(9); doc.setTextColor(...GRAY);
      doc.text('Nenhum abastecimento encontrado no período.', W/2, 75, {align:'center'});
    }

    // ---- PÁGINA 2: CONSUMO OPERACIONAL ----
    if (op.length > 0) {
      doc.addPage();
      const totalPgs = doc.internal.getNumberOfPages();
      drawPage(totalPgs, totalPgs);

      const totalOpOleo = op.reduce((a,r)=>a+(r.qtdOleo||0),0);
      const totalOpAgua = op.reduce((a,r)=>a+(r.qtdAgua||0),0);

      doc.setFillColor(245,248,255);
      doc.rect(8, 43, (W-16)/2-4, 14, 'F');
      doc.rect(8+(W-16)/2, 43, (W-16)/2-4, 14, 'F');
      doc.setDrawColor(...NAVY); doc.setLineWidth(0.2);
      doc.rect(8, 43, (W-16)/2-4, 14, 'S');
      doc.rect(8+(W-16)/2, 43, (W-16)/2-4, 14, 'S');

      doc.setFont('helvetica','bold'); doc.setFontSize(7.5); doc.setTextColor(...GRAY);
      doc.text('TOTAL ÓLEO CONSUMIDO OP.', 10, 48);
      doc.text('TOTAL ÁGUA CONSUMIDA OP.', 10+(W-16)/2+2, 48);
      doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(...NAVY);
      doc.text(`${totalOpOleo.toLocaleString()} L`, 10, 54);
      doc.text(`${totalOpAgua.toLocaleString()} L`, 10+(W-16)/2+2, 54);

      doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(...NAVY);
      doc.text('CONSUMO OPERACIONAL', 8, 62);

      doc.autoTable({
        startY: 64,
        margin: { left: 8, right: 8, bottom: 18 },
        head: [['Data','Óleo Consumido (L)','Água Consumida (L)','Horas Op.','L/hora','Observação']],
        body: op.map(r => [
          new Date(r.data+'T12:00:00').toLocaleDateString('pt-BR'),
          (r.qtdOleo||0).toLocaleString(),
          (r.qtdAgua||0).toLocaleString(),
          r.horas>0?r.horas+'h':'-',
          r.horas>0?((r.qtdOleo||0)/r.horas).toFixed(1)+' L/h':'-',
          r.observacao||''
        ]),
        headStyles: { fillColor: NAVY, textColor: WHITE, fontStyle:'bold', fontSize:8 },
        bodyStyles: { fontSize: 8, textColor: [30,30,50] },
        alternateRowStyles: { fillColor: LTBLUE },
        columnStyles: {
          1:{halign:'right'}, 2:{halign:'right'}, 3:{halign:'center'}, 4:{halign:'center'}
        },
        didDrawPage: (data) => {
          drawPage(data.pageNumber+totalPgs-1, doc.internal.getNumberOfPages());
        }
      });
    }

    // Salvar
    const fname = `NavControl_${vessel.sigla}_${relDateStart}_${relDateEnd}_${hashId}.pdf`;
    doc.save(fname);
    toast(`PDF gerado: ${hashId}`, 'success');
  }


  // =====================================================================
  //  GESTÃO DE USUÁRIOS (admin)
  // =====================================================================
  function renderUsers(container) {
    if (!isAdmin()) { renderPermBlock(container, 'Gestão de Usuários'); return; }
    const users = DB.users || [];
    container.innerHTML = `
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header">
          <h3>Usuários do Sistema</h3>
          <button class="btn btn-primary btn-sm" onclick="openUserModal()"><i class="fas fa-user-plus"></i> Novo Usuário</button>
        </div>
        <div class="table-responsive"><table>
          <thead><tr>
            <th>Nome</th><th>Login</th><th>Perfil</th><th>Embarcações</th>
            <th>Último Login</th><th>Status</th><th>Ações</th>
          </tr></thead>
          <tbody>
          ${users.map(u => {
            const embs = u.embarcacoes === 'all'
              ? '<span style="color:var(--success);font-size:12px;font-weight:600;">⬤ Todas</span>'
              : (Array.isArray(u.embarcacoes) && u.embarcacoes.length > 0
                  ? u.embarcacoes.map(id => {
                      const v = DB.vessels.find(x=>x.id===id);
                      return v ? `<span class="vessel-chip selected" style="margin:1px 2px">${v.sigla}</span>` : '';
                    }).join('')
                  : '<span style="color:var(--text-secondary);font-size:12px">Nenhuma</span>');
            const ult = u.ultimoLogin ? new Date(u.ultimoLogin).toLocaleString('pt-BR') : '—';
            const isMe = u.id === currentUser?.id;
            return `<tr>
              <td><strong>${u.nome}</strong>${isMe ? ' <span class="badge badge-operador" style="font-size:10px">você</span>' : ''}</td>
              <td><code style="font-size:12px;background:var(--gray-100);padding:2px 6px;border-radius:4px">${u.username}</code></td>
              <td><span class="badge ${u.perfil==='admin'?'badge-admin':'badge-operador'}">${u.perfil==='admin'?'Administrador':'Operador'}</span></td>
              <td><div style="display:flex;flex-wrap:wrap;gap:3px;max-width:280px">${embs}</div></td>
              <td style="font-size:12px;color:var(--text-secondary)">${ult}</td>
              <td><span class="badge ${u.ativo!==false?'badge-operador':'badge-inativo'}">${u.ativo!==false?'Ativo':'Inativo'}</span></td>
              <td style="white-space:nowrap">
                <button class="btn btn-sm btn-outline btn-icon" onclick="openUserModal(${u.id})" title="Editar"><i class="fas fa-edit"></i></button>
                ${!isMe ? `<button class="btn btn-sm btn-outline btn-icon" onclick="toggleUserAtivo(${u.id})" title="${u.ativo!==false?'Desativar':'Ativar'}"><i class="fas ${u.ativo!==false?'fa-user-slash':'fa-user-check'}"></i></button>` : ''}
                ${!isMe ? `<button class="btn btn-sm btn-danger btn-icon" onclick="deleteUser(${u.id})" title="Remover"><i class="fas fa-trash"></i></button>` : ''}
              </td>
            </tr>`;
          }).join('')}
          </tbody>
        </table></div>
      </div>
    `;
  }

  function openUserModal(editId = null) {
    const u = editId ? (DB.users||[]).find(x=>x.id===editId) : null;
    const allVessels = DB.vessels;
    const selEmbs = u ? (u.embarcacoes === 'all' ? allVessels.map(v=>v.id) : (u.embarcacoes||[])) : [];
    const isAllSel = u?.embarcacoes === 'all';

    const existingModal = document.getElementById('userModal');
    if (existingModal) existingModal.remove();
    const m = document.createElement('div');
    m.id = 'userModal';
    m.className = 'modal-overlay show';
    m.innerHTML = `
      <div class="modal" style="max-width:600px;">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-user-cog"></i> ${u ? 'Editar Usuário' : 'Novo Usuário'}</h3>
          <button class="modal-close" onclick="document.getElementById('userModal').remove()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Nome completo *</label>
              <input type="text" class="form-control" id="uNome" value="${u?.nome||''}" placeholder="Nome do operador">
            </div>
            <div class="form-group">
              <label class="form-label">Login (username) *</label>
              <input type="text" class="form-control" id="uUsername" value="${u?.username||''}" placeholder="login sem espaços" autocomplete="off">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">${u ? 'Nova Senha (deixe em branco para manter)' : 'Senha *'}</label>
              <input type="password" class="form-control" id="uSenha" placeholder="${u?'••••••••':'Mínimo 4 caracteres'}" autocomplete="new-password">
            </div>
            <div class="form-group">
              <label class="form-label">Perfil *</label>
              <select class="form-control" id="uPerfil">
                <option value="operador" ${!u||u.perfil==='operador'?'selected':''}>Operador</option>
                <option value="admin" ${u?.perfil==='admin'?'selected':''}>Administrador</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" style="display:flex;align-items:center;gap:10px;">
              Embarcações com acesso *
              <label style="display:flex;align-items:center;gap:5px;font-weight:400;cursor:pointer">
                <input type="checkbox" id="uTodas" ${isAllSel||!u?'checked':''} onchange="toggleTodasEmbs(this.checked)"> Todas as embarcações
              </label>
            </label>
            <div class="vessel-select-grid" id="embGrid" style="${isAllSel||!u?'opacity:.4;pointer-events:none':''}">
              ${allVessels.map(v=>`
                <label class="vessel-select-item ${selEmbs.includes(v.id)?'selected':''}" id="embItem_${v.id}" onclick="toggleEmbItem(${v.id},this)">
                  <input type="checkbox" id="embChk_${v.id}" ${selEmbs.includes(v.id)?'checked':''} onclick="event.stopPropagation()">
                  <span class="pill ${v.material==='Aço'?'pill-aco':'pill-madeira'}" style="font-size:11px">${v.sigla}</span>
                  <span style="font-size:12px">${v.name.length>14?v.name.slice(0,14)+'…':v.name}</span>
                </label>`).join('')}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="document.getElementById('userModal').remove()">Cancelar</button>
          <button class="btn btn-primary" onclick="saveUser(${editId||'null'})">
            <i class="fas fa-save"></i> ${u ? 'Salvar Alterações' : 'Criar Usuário'}
          </button>
        </div>
      </div>`;
    document.body.appendChild(m);
    m.addEventListener('click', e => { if (e.target === m) m.remove(); });
  }

  window.toggleTodasEmbs = function(checked) {
    const grid = document.getElementById('embGrid');
    if (grid) { grid.style.opacity = checked ? '.4' : '1'; grid.style.pointerEvents = checked ? 'none' : ''; }
  };

  window.toggleEmbItem = function(id, el) {
    el.classList.toggle('selected');
    const chk = document.getElementById('embChk_'+id);
    if (chk) chk.checked = el.classList.contains('selected');
  };

  function saveUser(editId) {
    // Normalizar: template HTML passa 'null' como string quando não há ID
    editId = (editId === 'null' || editId === null || editId === undefined) ? null : Number(editId);
    const nome     = document.getElementById('uNome')?.value.trim();
    const username = document.getElementById('uUsername')?.value.trim().toLowerCase();
    const senha    = document.getElementById('uSenha')?.value;
    const perfil   = document.getElementById('uPerfil')?.value;
    const todas    = document.getElementById('uTodas')?.checked;

    if (!nome || !username) { toast('Nome e login são obrigatórios.','error'); return; }
    if (!editId && !senha)  { toast('Senha obrigatória para novo usuário.','error'); return; }
    if (senha && senha.length < 4) { toast('Senha mínima: 4 caracteres.','error'); return; }

    const dupUser = (DB.users||[]).find(u => u.username===username && u.id!==editId); // editId é null ou Number aqui
    if (dupUser) { toast('Este login já está em uso.','error'); return; }

    const embarcacoes = todas ? 'all' : (() => {
      const ids = [];
      DB.vessels.forEach(v => { if (document.getElementById('embChk_'+v.id)?.checked) ids.push(v.id); });
      return ids;
    })();
    if (embarcacoes !== 'all' && embarcacoes.length === 0) { toast('Selecione ao menos uma embarcação.','error'); return; }

    if (!DB.users) DB.users = [];
    if (!DB.nextId.users) DB.nextId.users = 2;

    if (editId) {
      const u = DB.users.find(x=>x.id===editId);
      if (!u) return;
      u.nome = nome; u.username = username; u.perfil = perfil; u.embarcacoes = embarcacoes;
      if (senha) u.pwdHash = _hashPwd(username, senha);
      toast('Usuário atualizado!','success');
    } else {
      DB.users.push({ id: DB.nextId.users++, nome, username, pwdHash: _hashPwd(username, senha), perfil, embarcacoes, ativo: true, criadoEm: new Date().toISOString().slice(0,10), ultimoLogin: null });
      toast('Usuário criado!','success');
    }
    saveToStorage();
    document.getElementById('userModal').remove();
    renderDashboard('users');
  }

  function toggleUserAtivo(id) {
    const u = (DB.users||[]).find(x=>x.id===id);
    if (!u) return;
    if (u.id === currentUser?.id) { toast('Não é possível desativar sua própria conta.','error'); return; }
    u.ativo = !u.ativo;
    saveToStorage();
    toast(u.ativo ? 'Usuário reativado.' : 'Usuário desativado.','info');
    renderDashboard('users');
  }

  function deleteUser(id) {
    const u = (DB.users||[]).find(x=>x.id===id);
    if (!u) return;
    if (u.id === currentUser?.id) { toast('Não é possível excluir sua própria conta.','error'); return; }
    if (!confirm(`Remover o usuário "${u.nome}"? Esta ação não pode ser desfeita.`)) return;
    DB.users = DB.users.filter(x=>x.id!==id);
    saveToStorage();
    toast('Usuário removido.','success');
    renderDashboard('users');
  }


  // =====================================================================
  //  SOLICITAÇÕES DE CORREÇÃO
  // =====================================================================
  function renderSolicitacoes(container) {
    const minhas = isAdmin()
      ? (DB.solicitacoes||[])
      : (DB.solicitacoes||[]).filter(r=>r.usuarioId===currentUser?.id);
    const pendentes = minhas.filter(r=>r.status==='pendente');
    const resolvidas = minhas.filter(r=>r.status!=='pendente');
    const urgColors = { normal:'var(--primary)', alta:'var(--warning)', critica:'var(--danger)' };
    const renderCard = (r) => {
      const supply = r.tipo==='supply' ? DB.supplies.find(s=>s.id===r.refId) : null;
      const consumo = r.tipo==='consumoOp' ? (DB.consumoOp||[]).find(c=>c.id===r.refId) : null;
      const vessel = supply ? DB.vessels.find(v=>v.id===supply?.vesselId) : consumo ? DB.vessels.find(v=>v.id===consumo?.vesselId) : null;
      const refLabel = r.tipo==='supply'
        ? `Abastecimento #${r.refId}${vessel?' — '+vessel.sigla:''} (${supply?.data||'?'})`
        : r.tipo==='consumoOp'
        ? `Consumo Op. #${r.refId}${vessel?' — '+vessel.sigla:''} (${consumo?.data||'?'})`
        : `Referência: ${r.tipo} #${r.refId}`;
      const criadoEm = new Date(r.criadoEm).toLocaleString('pt-BR');
      return `
        <div class="req-card ${r.status!=='pendente'?'req-resolvida':''}">
          <div class="req-header">
            <div style="flex:1">
              <div class="req-num">SOL-${String(r.id).padStart(4,'0')} · ${criadoEm} · <strong>${r.usuarioNome}</strong></div>
              <div style="margin-top:4px;font-size:12px;color:var(--text-secondary)">${refLabel}</div>
            </div>
            <span style="font-size:11px;font-weight:700;color:${urgColors[r.urgencia]||urgColors.normal};text-transform:uppercase;letter-spacing:.5px;padding:2px 8px;border:1px solid currentColor;border-radius:12px">${r.urgencia||'normal'}</span>
            <span class="badge ${r.status==='pendente'?'badge-operador':'badge-inativo'}">${r.status==='pendente'?'⏳ Pendente':'✅ Resolvida'}</span>
          </div>
          <div class="req-body">${r.texto}</div>
          ${r.notaAdmin ? `<div style="font-size:12px;color:var(--success);background:var(--greenlt);padding:8px 12px;border-radius:var(--radius-md);margin-top:4px"><i class="fas fa-check-circle"></i> <strong>Admin:</strong> ${r.notaAdmin}</div>` : ''}
          <div class="req-meta">
            ${r.resolvidoEm ? `<span><i class="fas fa-check"></i> Resolvida em ${new Date(r.resolvidoEm).toLocaleString('pt-BR')} por ${r.resolvidoPor}</span>` : ''}
            ${isAdmin() && r.status==='pendente' ? `
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <input type="text" class="form-control" id="nota_${r.id}" placeholder="Nota de resolução (opcional)" style="max-width:340px;font-size:12px;padding:5px 10px;">
                <button class="btn btn-primary btn-sm" onclick="resolverSolicitacao(${r.id})"><i class="fas fa-check"></i> Marcar Resolvida</button>
              </div>` : ''}
          </div>
        </div>`;
    };
    container.innerHTML = `
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <h3>${isAdmin()?'Central de Solicitações':'Minhas Solicitações'}</h3>
          <span class="badge ${pendentes.length>0?'badge-operador':'badge-inativo'}">${pendentes.length} pendente${pendentes.length!==1?'s':''}</span>
        </div>
        ${minhas.length===0 ? `
          <div class="perm-block" style="padding:32px"><i class="fas fa-check-circle" style="opacity:.3"></i><h3>Tudo em dia</h3><p>Nenhuma solicitação encontrada.</p></div>
        ` : `
          ${pendentes.length>0?`<h4 style="font-size:13px;font-weight:700;color:var(--warning);margin-bottom:12px"><i class="fas fa-clock"></i> Pendentes (${pendentes.length})</h4>${pendentes.map(renderCard).join('')}`:''}
          ${resolvidas.length>0?`<h4 style="font-size:13px;font-weight:700;color:var(--text-secondary);margin:20px 0 12px"><i class="fas fa-check-double"></i> Resolvidas</h4>${resolvidas.map(renderCard).join('')}`:''}
        `}
      </div>
    `;
  }

  function resolverSolicitacao(id) {
    const r = (DB.solicitacoes||[]).find(x=>x.id===id);
    if (!r) return;
    const nota = document.getElementById('nota_'+id)?.value.trim() || '';
    r.status = 'resolvida';
    r.resolvidoEm = new Date().toISOString();
    r.resolvidoPor = currentUser?.nome || 'Admin';
    r.notaAdmin = nota || null;
    saveToStorage();
    renderSidebar();
    _atualizarSidebarAlerts();
    renderDashboard('solicitacoes');
    toast('Solicitação marcada como resolvida!','success');
  }

  // =====================================================================
  //  MEMORIAL
  // =====================================================================
  function renderMemorial(container) {
    container.innerHTML=`
      <div class="card">
        <div class="card-header"><h3>Conversor de Unidades</h3></div>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:20px;">Densidade padrão: <strong>${config.defaultDensity} kg/L</strong> (ajustável nas Configurações).</p>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
          <div style="background:var(--gray-50);border-radius:var(--radius-lg);padding:18px;border:1px solid var(--border-color);">
            <h4 style="margin-bottom:12px;font-size:14px;">Toneladas → Litros</h4>
            <input type="number" class="form-control" id="toneladas" placeholder="Toneladas" step="0.001" min="0" style="margin-bottom:8px;">
            <button class="btn btn-outline btn-sm btn-full" onclick="converterToneladas()">Converter</button>
            <div style="font-size:22px;font-weight:700;color:var(--primary);margin-top:10px;" id="resultToneladas">—</div>
          </div>
          <div style="background:var(--gray-50);border-radius:var(--radius-lg);padding:18px;border:1px solid var(--border-color);">
            <h4 style="margin-bottom:12px;font-size:14px;">Quilogramas → Litros</h4>
            <input type="number" class="form-control" id="kg" placeholder="kg" step="0.1" min="0" style="margin-bottom:8px;">
            <button class="btn btn-outline btn-sm btn-full" onclick="converterKg()">Converter</button>
            <div style="font-size:22px;font-weight:700;color:var(--primary);margin-top:10px;" id="resultKg">—</div>
          </div>
          <div style="background:var(--gray-50);border-radius:var(--radius-lg);padding:18px;border:1px solid var(--border-color);">
            <h4 style="margin-bottom:12px;font-size:14px;">Metros Cúbicos → Litros</h4>
            <input type="number" class="form-control" id="m3" placeholder="m³" step="0.001" min="0" style="margin-bottom:8px;">
            <button class="btn btn-outline btn-sm btn-full" onclick="converterM3()">Converter</button>
            <div style="font-size:22px;font-weight:700;color:var(--primary);margin-top:10px;" id="resultM3">—</div>
          </div>
        </div>
      </div>
    `;
  }

  window.converterToneladas = function() { const t=parseFloat(document.getElementById('toneladas').value)||0; document.getElementById('resultToneladas').innerText=((t*1000)/config.defaultDensity).toFixed(2)+' L'; };
  window.converterKg = function() { const k=parseFloat(document.getElementById('kg').value)||0; document.getElementById('resultKg').innerText=(k/config.defaultDensity).toFixed(2)+' L'; };
  window.converterM3 = function() { const m=parseFloat(document.getElementById('m3').value)||0; document.getElementById('resultM3').innerText=(m*1000).toFixed(2)+' L'; };

  // =====================================================================
  //  EVOLUÇÃO
  // =====================================================================
  function renderEvolution(container) {
    if (!DB.vessels.length) { container.innerHTML='<div class="card"><p style="color:var(--text-secondary);text-align:center;padding:32px">Nenhuma embarcação cadastrada.</p></div>'; return; }
    container.innerHTML=`
      <div class="card">
        <div class="card-header"><h3>Evolução do Consumo</h3><span class="badge">mensal</span></div>
        <div class="filter-bar" style="margin-bottom:16px;">
          <div class="filter-group"><label class="filter-label">Embarcação:</label><select id="evolutionVessel" class="filter-select" onchange="updateEvolutionChart()">${DB.vessels.map(v=>`<option value="${v.id}">${v.name} (${v.sigla})</option>`).join('')}</select></div>
          <div class="filter-group"><label class="filter-label">Fluido:</label><select id="evolutionFluido" class="filter-select" onchange="updateEvolutionChart()"><option value="oleo">🛢 Óleo</option><option value="agua">💧 Água</option></select></div>
        </div>
        <div class="chart-container"><canvas id="evolutionChart"></canvas></div>
      </div>
    `;
    setTimeout(updateEvolutionChart, 80);
  }

  function updateEvolutionChart() {
    const vesselId=parseInt(document.getElementById('evolutionVessel')?.value);
    const fluido=document.getElementById('evolutionFluido')?.value||'oleo';
    if(!vesselId||isNaN(vesselId))return;
    const supplies=DB.supplies.filter(s=>s.vesselId===vesselId&&s.quantidade>0&&(fluido==='oleo'?(s.tipoFluido==='oleo'||!s.tipoFluido):s.tipoFluido===fluido));
    const monthly={};
    supplies.forEach(s=>{const m=s.data.substring(0,7); monthly[m]=(monthly[m]||0)+s.quantidade;});
    const months=Object.keys(monthly).sort();
    const ctx=document.getElementById('evolutionChart')?.getContext('2d');
    if(!ctx)return;
    if(charts.evolution)charts.evolution.destroy();
    charts.evolution=new Chart(ctx,{type:'line',data:{labels:months,datasets:[{label:`${fluido==='agua'?'Água':'Óleo'} (L)`,data:months.map(m=>monthly[m]),borderColor:fluido==='agua'?'#06b6d4':'#0ea5e9',backgroundColor:fluido==='agua'?'rgba(6,182,212,0.1)':'rgba(14,165,233,0.1)',tension:0.3,fill:true,pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,title:{display:true,text:'Litros'}}}}});
  }

  // =====================================================================
  //  IMPORT / EXPORT / BACKUP / SETTINGS
  // =====================================================================
  const COLUMN_MAP = {
    supplies: {
      data:['data','date','dt','data_abastecimento'],
      embarcacao:['embarcacao','embarcação','navio','vessel','vessel_name'],
      empresa:['empresa','fornecedor','company','supplier'],
      quantidadeAntes:['quantidadeantes','qtd_antes','quantidade_antes','antes','estoque_antes'],
      quantidadeSolicitada:['quantidadesolicitada','qtd_solicitada','solicitada','solicitado'],
      quantidadeAbastecida:['quantidadeabastecida','qtd_abastecida','abastecida','abastecido','quantidade','litros'],
      quantidadeApos:['quantidadeapos','qtd_apos','apos','após'],
      valorUnitario:['valorunitario','valor_unitario','preco','preço','unit_price','valor'],
      tipoOperacao:['tipooperacao','tipo_operacao','tipo','operacao'],
      tipoFluido:['tipofluido','tipo_fluido','fluido','fluid'],
      observacao:['observacao','observação','obs','notes']
    },
    companies:{name:['name','nome','empresa'],cnpj:['cnpj','documento'],contato:['contato','email','contact'],telefone:['telefone','fone','phone'],endereco:['endereco','endereço','address']},
    vessels:{name:['name','nome','embarcacao','embarcação'],sigla:['sigla','abbr'],material:['material','tipo'],cc:['cc'],cr:['cr'],tripulacao:['tripulacao','tripulação','crew'],capacidadeOleo:['capacidadeoleo','capacidade_oleo','cap_oleo','capacidade'],capacidadeAgua:['capacidadeagua','capacidade_agua','cap_agua']}
  };

  function normalizeKey(s){return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');}
  function mapColumn(h,type){const n=normalizeKey(h);const map=COLUMN_MAP[type]||{};for(const[field,aliases]of Object.entries(map)){if(aliases.some(a=>n===a||n.includes(a)))return field;}return null;}
  function resolveVessel(str){if(!str)return null;const n=normalizeKey(str);return DB.vessels.find(v=>normalizeKey(v.name)===n||normalizeKey(v.sigla)===n)||null;}
  function resolveCompany(str){if(!str)return null;const n=normalizeKey(str);return DB.companies.find(c=>normalizeKey(c.name)===n)||null;}

  function parseDate(value){
    if(!value)return null;const s=String(value).trim();
    if(/^\d{4}-\d{2}-\d{2}/.test(s))return s.substring(0,10);
    const dmy=s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
    if(dmy)return `${dmy[3]}-${String(dmy[2]).padStart(2,'0')}-${String(dmy[1]).padStart(2,'0')}`;
    const num=Number(s);
    if(!isNaN(num)&&num>30000){const d=new Date(Math.round((num-25569)*86400*1000));return d.toISOString().split('T')[0];}
    return null;
  }

  function parseNum(v){if(v===null||v===undefined||v==='')return 0;return parseFloat(String(v).replace(/[^\d,\.\-]/g,'').replace(',','.'))||0;}

  function processSupplies(rows,headers){
    const fieldMap={};headers.forEach(h=>{const f=mapColumn(h,'supplies');if(f)fieldMap[f]=h;});
    const missing=['data','embarcacao','quantidadeAbastecida'].filter(f=>!fieldMap[f]);
    if(missing.length)return{ok:false,error:`Colunas obrigatórias não encontradas: ${missing.join(', ')}`};
    const results={imported:0,skipped:0,errors:[],newVessels:[],newCompanies:[]};
    rows.forEach((row,idx)=>{
      const get=f=>fieldMap[f]?String(row[fieldMap[f]]||'').trim():'';
      const data=parseDate(get('data'));
      if(!data){results.errors.push(`Linha ${idx+2}: data inválida`);results.skipped++;return;}
      const embStr=get('embarcacao');
      let vessel=resolveVessel(embStr);
      if(!vessel){const nid=DB.nextId.vessels++;vessel={id:nid,name:embStr.toUpperCase(),sigla:embStr.substring(0,8).toUpperCase(),material:'Aço',cc:0,cr:'',tripulacao:0,capacidadeOleo:14,capacidadeAgua:5};DB.vessels.push(vessel);results.newVessels.push(embStr);}
      const empStr=get('empresa');let company=empStr?resolveCompany(empStr):null;
      if(empStr&&!company){const nid=DB.nextId.companies++;company={id:nid,name:empStr,cnpj:'',contato:'',telefone:'',endereco:''};DB.companies.push(company);results.newCompanies.push(empStr);}
      const quantidade=parseNum(get('quantidadeAbastecida'));
      const valorUnitario=parseNum(get('valorUnitario'));
      const quantidadeAntes=parseNum(get('quantidadeAntes'));
      const quantidadeSolicitada=parseNum(get('quantidadeSolicitada'))||quantidade;
      const quantidadeApos=parseNum(get('quantidadeApos'))||(quantidadeAntes+quantidade);
      const tipoRaw=get('tipoOperacao').toLowerCase();
      const tipoOperacao=tipoRaw.includes('pass')?'passagem':'compra';
      const tipoFluidoRaw=get('tipoFluido').toLowerCase();
      const tipoFluido=tipoFluidoRaw.includes('agua')||tipoFluidoRaw.includes('água')||tipoFluidoRaw.includes('water')?'agua':'oleo';
      DB.supplies.push({id:DB.nextId.supplies++,vesselId:vessel.id,companyId:company?company.id:null,data,tipoFluido,tipo:tipoFluido==='agua'?'Água Potável':'Diesel Marítimo',quantidade,valorUnitario,valorTotal:quantidade*valorUnitario,quantidadeAntes,quantidadeSolicitada,quantidadeBordo:quantidadeApos,tipoOperacao,observacao:get('observacao')});
      results.imported++;
    });
    return{ok:true,results};
  }

  function processCompanies(rows,headers){const fieldMap={};headers.forEach(h=>{const f=mapColumn(h,'companies');if(f)fieldMap[f]=h;});if(!fieldMap['name'])return{ok:false,error:'Coluna "name" não encontrada.'};const results={imported:0,skipped:0,errors:[]};rows.forEach((row,idx)=>{const get=f=>fieldMap[f]?String(row[fieldMap[f]]||'').trim():'';const name=get('name');if(!name){results.skipped++;return;}if(DB.companies.some(c=>normalizeKey(c.name)===normalizeKey(name))){results.errors.push(`Linha ${idx+2}: "${name}" já existe`);results.skipped++;return;}DB.companies.push({id:DB.nextId.companies++,name,cnpj:get('cnpj'),contato:get('contato'),telefone:get('telefone'),endereco:get('endereco')});results.imported++;});return{ok:true,results};}

  function processVessels(rows,headers){const fieldMap={};headers.forEach(h=>{const f=mapColumn(h,'vessels');if(f)fieldMap[f]=h;});if(!fieldMap['name'])return{ok:false,error:'Coluna "name" não encontrada.'};const results={imported:0,skipped:0,errors:[]};rows.forEach((row,idx)=>{const get=f=>fieldMap[f]?String(row[fieldMap[f]]||'').trim():'';const name=get('name');if(!name){results.skipped++;return;}if(DB.vessels.some(v=>normalizeKey(v.name)===normalizeKey(name))){results.errors.push(`Linha ${idx+2}: "${name}" já existe`);results.skipped++;return;}DB.vessels.push({id:DB.nextId.vessels++,name:name.toUpperCase(),sigla:get('sigla').toUpperCase()||name.substring(0,8).toUpperCase(),material:get('material')||'Aço',cc:parseNum(get('cc')),cr:get('cr'),tripulacao:parseNum(get('tripulacao')),capacidadeOleo:parseNum(get('capacidadeOleo'))||14,capacidadeAgua:parseNum(get('capacidadeAgua'))||5});results.imported++;});return{ok:true,results};}

  async function parseFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          let rows = [], headers = [];
          if (file.name.endsWith('.csv')) {
            const result = Papa.parse(e.target.result, { header: true, skipEmptyLines: true });
            rows = result.data; headers = result.meta.fields || [];
          } else {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
            if (data.length < 2) { resolve({ rows: [], headers: [] }); return; }
            headers = data[0].map(String);
            rows = data.slice(1).map(row => { const obj = {}; headers.forEach((h, i) => { obj[h] = row[i] ?? ''; }); return obj; });
          }
          resolve({ rows, headers });
        } catch (err) { reject(err); }
      };
      if (file.name.endsWith('.csv')) reader.readAsText(file, 'utf-8');
      else reader.readAsBinaryString(file);
    });
  }

  function renderImport(container) {
    container.innerHTML = `
      <style>.drop-zone{border:2px dashed var(--border-color);border-radius:12px;padding:40px;text-align:center;cursor:pointer;transition:all 0.2s;color:var(--text-secondary);}.drop-zone:hover,.drop-zone.drag-over{border-color:var(--accent);background:rgba(37,99,235,0.04);color:var(--accent);}.drop-zone i{font-size:40px;margin-bottom:12px;display:block;}.import-log{background:var(--gray-100);border-radius:8px;padding:14px;font-family:'JetBrains Mono',monospace;font-size:12px;max-height:180px;overflow-y:auto;}.log-ok{color:var(--success);}.log-warn{color:var(--warning);}.log-err{color:var(--danger);}</style>
      <div class="import-steps" style="display:flex;gap:8px;margin-bottom:20px;">
        <div style="flex:1;padding:10px;border-radius:8px;border:2px solid var(--accent);background:rgba(37,99,235,0.05);color:var(--accent);text-align:center;font-size:12px;font-weight:600;" id="step1Ind">① Arquivo</div>
        <div style="flex:1;padding:10px;border-radius:8px;border:2px solid var(--border-color);text-align:center;font-size:12px;font-weight:600;color:var(--text-secondary);" id="step2Ind">② Configurar</div>
        <div style="flex:1;padding:10px;border-radius:8px;border:2px solid var(--border-color);text-align:center;font-size:12px;font-weight:600;color:var(--text-secondary);" id="step3Ind">③ Resultado</div>
      </div>
      <div id="importStep1">
        <div class="card">
          <div class="card-header"><h3>Selecionar Arquivo</h3></div>
          <div class="drop-zone" id="dropZone" onclick="document.getElementById('importFileHidden').click()"><i class="fas fa-cloud-upload-alt"></i><strong>Clique ou arraste o arquivo</strong><p style="margin-top:8px;font-size:12px;">CSV, XLSX, XLS</p></div>
          <input type="file" id="importFileHidden" accept=".csv,.xlsx,.xls" style="display:none" onchange="onFileSelected(event)">
        </div>
        <div class="card"><div class="card-header"><h3>Templates</h3></div><div style="display:flex;gap:10px;flex-wrap:wrap;"><button class="btn btn-outline btn-sm" onclick="downloadTemplate('supplies')"><i class="fas fa-download"></i> Abastecimentos</button><button class="btn btn-outline btn-sm" onclick="downloadTemplate('companies')"><i class="fas fa-download"></i> Empresas</button><button class="btn btn-outline btn-sm" onclick="downloadTemplate('vessels')"><i class="fas fa-download"></i> Embarcações</button></div></div>
      </div>
      <div id="importStep2" style="display:none;">
        <div class="card">
          <div class="card-header"><h3>Configurar Importação</h3></div>
          <div class="form-row"><div class="form-group"><label class="form-label">Tipo de dado</label><select class="form-control" id="importType" onchange="updateMapping()"><option value="supplies">Abastecimentos</option><option value="companies">Empresas</option><option value="vessels">Embarcações</option></select></div><div class="form-group"><label class="form-label">Em caso de duplicata</label><select class="form-control" id="duplicateStrategy"><option value="skip">Ignorar</option><option value="add">Adicionar mesmo assim</option></select></div></div>
          <div id="mappingDisplay" style="margin-bottom:16px;display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;"></div>
          <div id="previewTable" style="max-height:220px;overflow-y:auto;border-radius:8px;border:1px solid var(--border-color);"></div>
        </div>
        <div style="display:flex;gap:10px;"><button class="btn btn-outline" onclick="backToStep1()">Voltar</button><button class="btn btn-primary" onclick="runImport()"><i class="fas fa-file-import"></i> Importar</button></div>
      </div>
      <div id="importStep3" style="display:none;">
        <div class="card">
          <div class="card-header"><h3>Resultado</h3></div>
          <div id="importSummary" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;"></div>
          <div id="importLog" class="import-log"></div>
          <div style="display:flex;gap:10px;margin-top:12px;"><button class="btn btn-outline" onclick="backToStep1()">Nova Importação</button><button class="btn btn-primary" onclick="changeDashboard('dashboard')">Ver Dashboard</button></div>
        </div>
      </div>
    `;
    const dz=document.getElementById('dropZone');
    dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
    dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
    dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f)handleFile(f);});
  }

  let importState={file:null,rows:[],headers:[]};

  function onFileSelected(event){const f=event.target.files[0];if(f)handleFile(f);}

  async function handleFile(file){
    showLoading(true);
    try{
      const{rows,headers}=await parseFile(file);
      importState={file,rows,headers};
      document.getElementById('importStep1').style.display='none';
      document.getElementById('importStep2').style.display='block';
      document.getElementById('step1Ind').style.borderColor='var(--success)';document.getElementById('step1Ind').style.color='var(--success)';
      document.getElementById('step2Ind').style.borderColor='var(--accent)';document.getElementById('step2Ind').style.color='var(--accent)';document.getElementById('step2Ind').style.background='rgba(37,99,235,0.05)';
      updateMapping();
      const{rows:r,headers:h}=importState;const preview=r.slice(0,8);
      const pt=document.getElementById('previewTable');
      if(pt)pt.innerHTML=`<table><thead><tr>${h.map(x=>`<th>${x}</th>`).join('')}</tr></thead><tbody>${preview.map(row=>`<tr>${h.map(x=>`<td>${row[x]??''}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
      toast(`Arquivo carregado: ${rows.length} linhas`,'success');
    }catch(err){toast('Erro: '+err.message,'error');}
    finally{showLoading(false);}
  }

  function updateMapping(){
    const type=document.getElementById('importType')?.value;
    if(!type||!importState.headers.length)return;
    const labels={supplies:{data:'Data',embarcacao:'Embarcação',empresa:'Empresa',quantidadeAntes:'Antes',quantidadeSolicitada:'Solicitada',quantidadeAbastecida:'Abastecida*',quantidadeApos:'Após',valorUnitario:'Val. Unit.',tipoOperacao:'Tipo Op.',tipoFluido:'Fluido',observacao:'Obs.'},companies:{name:'Nome*',cnpj:'CNPJ*',contato:'Contato',telefone:'Tel.',endereco:'Endereço'},vessels:{name:'Nome*',sigla:'Sigla',material:'Material',cc:'CC',cr:'CR',tripulacao:'Tripulação',capacidadeOleo:'Cap. Óleo',capacidadeAgua:'Cap. Água'}};
    const lbl=labels[type]||{};
    let html='';
    for(const[field,label]of Object.entries(lbl)){
      const col=importState.headers.find(h=>mapColumn(h,type)===field);
      html+=col?`<div style="display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--gray-100);border-radius:6px;"><span style="flex:1;color:var(--text-secondary)">${label}</span><i class="fas fa-arrow-right" style="color:var(--success)"></i><strong style="flex:1">"${col}"</strong></div>`
               :`<div style="display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--gray-100);border-radius:6px;"><span style="flex:1;color:var(--text-secondary)">${label}</span><i class="fas fa-times" style="color:var(--danger)"></i><span style="flex:1;color:var(--gray-400);font-style:italic">não mapeada</span></div>`;
    }
    const md=document.getElementById('mappingDisplay');if(md)md.innerHTML=html;
  }

  function backToStep1(){['importStep1','importStep2','importStep3'].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.style.display=i===0?'block':'none';});importState={file:null,rows:[],headers:[]};const fi=document.getElementById('importFileHidden');if(fi)fi.value='';}

  async function runImport(){
    const type=document.getElementById('importType').value;
    const{rows,headers}=importState;
    if(!rows.length){toast('Nenhum dado para importar','error');return;}
    showLoading(true);await new Promise(r=>setTimeout(r,80));
    let result;
    if(type==='supplies')result=processSupplies(rows,headers);
    else if(type==='companies')result=processCompanies(rows,headers);
    else result=processVessels(rows,headers);
    showLoading(false);
    if(!result.ok){toast('Erro: '+result.error,'error');return;}
    saveToStorage();
    document.getElementById('importStep2').style.display='none';
    document.getElementById('importStep3').style.display='block';
    document.getElementById('step2Ind').style.borderColor='var(--success)';document.getElementById('step2Ind').style.color='var(--success)';
    document.getElementById('step3Ind').style.borderColor='var(--accent)';document.getElementById('step3Ind').style.color='var(--accent)';document.getElementById('step3Ind').style.background='rgba(37,99,235,0.05)';
    const r=result.results;
    document.getElementById('importSummary').innerHTML=`
      <div style="padding:14px;border-radius:8px;background:rgba(5,150,105,0.1);border:1px solid var(--success);text-align:center;"><div style="font-size:28px;font-weight:700;color:var(--success)">${r.imported}</div><div style="font-size:12px;color:var(--text-secondary)">Importados</div></div>
      <div style="padding:14px;border-radius:8px;background:rgba(217,119,6,0.1);border:1px solid var(--warning);text-align:center;"><div style="font-size:28px;font-weight:700;color:var(--warning)">${r.skipped}</div><div style="font-size:12px;color:var(--text-secondary)">Ignorados</div></div>
      <div style="padding:14px;border-radius:8px;background:${r.errors.length?'rgba(220,38,38,0.1)':'rgba(5,150,105,0.1)'};border:1px solid ${r.errors.length?'var(--danger)':'var(--success)'};text-align:center;"><div style="font-size:28px;font-weight:700;color:${r.errors.length?'var(--danger)':'var(--success)'}">${r.errors.length}</div><div style="font-size:12px;color:var(--text-secondary)">Erros</div></div>
    `;
    let log=`<div class="log-ok">✔ Importação concluída</div>`;
    if(r.newVessels?.length)log+=r.newVessels.map(n=>`<div class="log-warn">⚠ Embarcação criada: ${n}</div>`).join('');
    if(r.newCompanies?.length)log+=r.newCompanies.map(n=>`<div class="log-warn">⚠ Empresa criada: ${n}</div>`).join('');
    if(r.errors.length)log+=r.errors.map(e=>`<div class="log-err">✖ ${e}</div>`).join('');
    document.getElementById('importLog').innerHTML=log;
    toast(`${r.imported} registros importados!`,'success');
  }

  function downloadTemplate(type){
    let headers=[],example=[];
    if(type==='supplies'){headers=['data','embarcacao','empresa','tipoFluido','quantidadeAntes','quantidadeSolicitada','quantidadeAbastecida','quantidadeApos','valorUnitario','tipoOperacao','observacao'];example=['2026-03-01','RS CORREGO DO OURO','Petrobras','oleo','3500','5000','5000','8500','5.80','compra','Abastecimento'];}
    else if(type==='companies'){headers=['name','cnpj','contato','telefone','endereco'];example=['Nova Empresa','00.000.000/0001-00','contato@email.com','(21) 1234-5678','Endereço'];}
    else{headers=['name','sigla','material','cc','cr','tripulacao','capacidadeOleo','capacidadeAgua'];example=['Nova Embarcação','SIGLA','Aço','100','CR123','12','14','5'];}
    const csv=[headers.join(','),example.join(',')].join('\n');
    const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),download:`template_${type}.csv`});
    a.click();
  }

  function renderExport(container){
    container.innerHTML=`<div class="card"><div class="card-header"><h3>Exportar Dados</h3></div><div class="form-group"><label class="form-label">Tipo de dados</label><select class="form-control" id="exportType"><option value="supplies">Abastecimentos</option><option value="companies">Empresas</option><option value="vessels">Embarcações</option></select></div><div class="form-group"><label class="form-label">Formato</label><select class="form-control" id="exportFormat"><option value="csv">CSV</option><option value="xlsx">Excel (XLSX)</option></select></div><button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> Exportar</button></div>`;
  }

  function exportData(){
    const type=document.getElementById('exportType').value;
    const fmt=document.getElementById('exportFormat').value;
    let data,filename;
    if(type==='supplies'){data=DB.supplies.map(s=>({id:s.id,data:s.data,embarcacao:DB.vessels.find(v=>v.id===s.vesselId)?.name||'',empresa:DB.companies.find(c=>c.id===s.companyId)?.name||'',tipoFluido:s.tipoFluido||'oleo',quantidadeAntes:s.quantidadeAntes,quantidadeSolicitada:s.quantidadeSolicitada,quantidadeAbastecida:s.quantidade,quantidadeApos:s.quantidadeBordo,valorUnitario:s.valorUnitario,valorTotal:s.valorTotal,tipoOperacao:s.tipoOperacao,observacao:s.observacao}));filename='abastecimentos';}
    else if(type==='companies'){data=DB.companies;filename='empresas';}
    else{data=DB.vessels.map(v=>({...v,capacidade:undefined}));filename='embarcacoes';}
    if(fmt==='csv'){const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([Papa.unparse(data)],{type:'text/csv'})),download:filename+'.csv'});a.click();}
    else{const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Dados');XLSX.writeFile(wb,filename+'.xlsx');}
  }

  function renderBackup(container){
    container.innerHTML=`<div class="card"><div class="card-header"><h3>Backup Completo</h3></div><p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Exporte toda a base em JSON para importar posteriormente.</p><button class="btn btn-primary" onclick="exportBackup()"><i class="fas fa-download"></i> Exportar Backup</button><hr class="section-divider"><h3 style="margin-bottom:10px;">Restaurar Backup</h3><div class="form-group"><input type="file" id="backupFile" accept=".json" class="form-control"></div><button class="btn btn-danger" onclick="importBackup()"><i class="fas fa-upload"></i> Restaurar</button><hr class="section-divider"><div style="display:flex;gap:10px;flex-wrap:wrap;"><button class="btn btn-danger" onclick="promptReset()">Restaurar Demonstração</button><button class="btn btn-danger" onclick="clearAllData()">Apagar Todos os Dados</button></div></div>`;
  }

  function exportBackup(){const j=JSON.stringify({vessels:DB.vessels,companies:DB.companies,supplies:DB.supplies,nextId:DB.nextId,config},null,2);const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([j],{type:'application/json'})),download:`navcontrol_backup_${new Date().toISOString().slice(0,10)}.json`});a.click();}

  function importBackup(){const f=document.getElementById('backupFile').files[0];if(!f){toast('Selecione um arquivo!','error');return;}const r=new FileReader();r.onload=e=>{try{const b=JSON.parse(e.target.result);if(!b.vessels||!b.companies||!b.supplies||!b.nextId){toast('Arquivo inválido!','error');return;}if(!confirm('Substituir todos os dados?'))return;DB=b;if(b.config)config=b.config;saveToStorage();toast('Backup restaurado!','success');renderDashboard(currentDashboard);}catch(err){toast('Erro: '+err.message,'error');}};r.readAsText(f);}

  function promptReset(){if(confirm('Restaurar base de demonstração?'))resetDatabase();}

  function renderSettings(container){
    container.innerHTML=`
    <div class="card" style="margin-bottom:16px;">
      <div class="card-header"><h3>Configurações do Sistema</h3></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Nome do Operador</label><input type="text" class="form-control" id="configOperador" value="${config.operadorNome||''}" placeholder="Seu nome..."></div>
        <div class="form-group"><label class="form-label">Densidade padrão do diesel (kg/L)</label><input type="number" class="form-control" id="configDensity" step="0.01" min="0.5" max="1.5" value="${config.defaultDensity}"></div>
      </div>
      <div class="form-group"><label class="form-label">Linhas por página</label>
        <div class="form-row-3">
          <div class="form-group"><label style="font-size:12px;color:var(--text-secondary)">Abastecimentos</label><input type="number" class="form-control" id="configRowsSupplies" min="5" max="100" value="${config.rowsPerPage.supplies}"></div>
          <div class="form-group"><label style="font-size:12px;color:var(--text-secondary)">Empresas</label><input type="number" class="form-control" id="configRowsCompanies" min="5" max="100" value="${config.rowsPerPage.companies}"></div>
          <div class="form-group"><label style="font-size:12px;color:var(--text-secondary)">Embarcações</label><input type="number" class="form-control" id="configRowsVessels" min="5" max="100" value="${config.rowsPerPage.vessels}"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label" style="color:var(--danger)">⚠ Threshold Crítico (%) — abaixo disso</label><input type="number" class="form-control" id="configAlertCritical" min="1" max="50" step="1" value="${config.alertCritical||20}"></div>
        <div class="form-group"><label class="form-label" style="color:var(--warning)">⚠ Threshold Baixo (%) — abaixo disso</label><input type="number" class="form-control" id="configAlertWarning" min="5" max="80" step="1" value="${config.alertWarning||40}"></div>
      </div>
      <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save"></i> Salvar Configurações</button>
    </div>
    ${renderAutoSaveSettings()}`;
  }

  function saveSettings(){
    config.defaultDensity=parseFloat(document.getElementById('configDensity').value)||0.85;
    config.rowsPerPage.supplies=parseInt(document.getElementById('configRowsSupplies').value)||10;
    config.rowsPerPage.companies=parseInt(document.getElementById('configRowsCompanies').value)||10;
    config.rowsPerPage.vessels=parseInt(document.getElementById('configRowsVessels').value)||10;
    config.operadorNome=document.getElementById('configOperador').value.trim();
    config.alertCritical=parseInt(document.getElementById('configAlertCritical').value)||20;
    config.alertWarning=parseInt(document.getElementById('configAlertWarning').value)||40;
    saveToStorage(); toast('Configurações salvas!','success'); renderDashboard('settings');
  }

  function closeModal(id){
    document.getElementById(id).classList.remove('show');
    if(id==='supplyModal')currentEditSupply=null;
    if(id==='companyModal')currentEditCompany=null;
    if(id==='vesselModal')currentEditVessel=null;
  }

  // =====================================================================
  //  AUTO-SAVE ENGINE
  // =====================================================================
  const AUTOSAVE_INTERVAL_MS = 45 * 60 * 1000;
  let autoSaveTimer=null, countdownTimer=null, nextSaveAt=null, lastSaveAt=null;

  function toggleAutoSave(){config.autoSave=!config.autoSave;saveToStorage();if(config.autoSave){iniciarAutoSave();toast('Auto-Save ativado','success');}else{pararAutoSave();toast('Auto-Save desativado','info');}atualizarWidgetAutoSave();}

  function iniciarAutoSave(){pararAutoSave();nextSaveAt=new Date(Date.now()+AUTOSAVE_INTERVAL_MS);autoSaveTimer=setInterval(executarAutoSave,AUTOSAVE_INTERVAL_MS);countdownTimer=setInterval(atualizarCountdown,1000);atualizarWidgetAutoSave();}

  function pararAutoSave(){if(autoSaveTimer){clearInterval(autoSaveTimer);autoSaveTimer=null;}if(countdownTimer){clearInterval(countdownTimer);countdownTimer=null;}nextSaveAt=null;atualizarWidgetAutoSave();}

  function executarAutoSave(manual=false){if(!loggedIn)return;saveToStorage();lastSaveAt=new Date();exportarPlanilhasAutoSave(lastSaveAt,manual);nextSaveAt=new Date(Date.now()+AUTOSAVE_INTERVAL_MS);atualizarWidgetAutoSave();toast(manual?'Planilhas baixadas!':'Auto-Save concluído!','success');}

  function salvarAgora(){const btn=document.getElementById('btnSaveNow');if(btn)btn.classList.add('saving');executarAutoSave(true);setTimeout(()=>{if(btn)btn.classList.remove('saving');},600);}

  function exportarPlanilhasAutoSave(ts,manual){
    try{
      const wb=XLSX.utils.book_new();
      const filename=`NavControl_${ts.toISOString().slice(0,10)}_${manual?'manual':'auto'}.xlsx`;
      const abastSheet=DB.supplies.map(s=>({'ID':s.id,'Data':s.data,'Embarcação':DB.vessels.find(v=>v.id===s.vesselId)?.name||'','Fluido':s.tipoFluido==='agua'?'Água':'Óleo','Empresa':DB.companies.find(c=>c.id===s.companyId)?.name||'','Qtd. Antes (L)':s.quantidadeAntes??'','Qtd. Solicitada (L)':s.quantidadeSolicitada??'','Qtd. Recebida (L)':s.quantidade,'Qtd. Após (L)':s.quantidadeBordo??'','Valor Unit. (R$)':s.valorUnitario??'','Valor Total (R$)':s.valorTotal??'','Tipo':s.tipoOperacao,'Observação':s.observacao||''}));
      XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(abastSheet),'Abastecimentos');
      const vesselSheet=DB.vessels.map(v=>({'ID':v.id,'Nome':v.name,'Sigla':v.sigla,'Material':v.material,'CC':v.cc,'CR':v.cr,'Tripulação':v.tripulacao,'Cap. Óleo (m³)':v.capacidadeOleo||v.capacidade||0,'Cap. Água (m³)':v.capacidadeAgua||0}));
      XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(vesselSheet),'Embarcações');
      // Posição de Estoque
      const stockSheet=DB.vessels.map(v=>({'Embarcação':v.name,'Sigla':v.sigla,'Óleo Atual (L)':getPosicaoAtual(v.id,'oleo'),'Cap. Óleo (L)':(v.capacidadeOleo||0)*1000,'% Óleo':((v.capacidadeOleo||0)*1000>0?(getPosicaoAtual(v.id,'oleo')/((v.capacidadeOleo||0)*1000)*100).toFixed(1):0),'Água Atual (L)':getPosicaoAtual(v.id,'agua'),'Cap. Água (L)':(v.capacidadeAgua||0)*1000,'% Água':((v.capacidadeAgua||0)*1000>0?(getPosicaoAtual(v.id,'agua')/((v.capacidadeAgua||0)*1000)*100).toFixed(1):0)}));
      XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(stockSheet),'Posição de Estoque');
      XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(DB.companies),'Empresas');
      XLSX.writeFile(wb,filename);
    }catch(err){console.error('[AutoSave]',err);toast('Erro ao gerar planilha: '+err.message,'error');}
  }

  function atualizarWidgetAutoSave(){const w=document.getElementById('autosaveWidget'),lb=document.getElementById('autosaveLabel'),cd=document.getElementById('autosaveCountdown');if(!w)return;if(config.autoSave){w.classList.add('active');if(lb)lb.textContent='Auto-Save ON';if(cd)cd.style.display='inline';}else{w.classList.remove('active');if(lb)lb.textContent='Auto-Save OFF';if(cd){cd.style.display='none';cd.textContent='';}}}

  function atualizarCountdown(){if(!config.autoSave||!nextSaveAt)return;const cd=document.getElementById('autosaveCountdown');if(!cd)return;const rem=Math.max(0,nextSaveAt-Date.now());cd.textContent=`${String(Math.floor(rem/60000)).padStart(2,'0')}:${String(Math.floor((rem%60000)/1000)).padStart(2,'0')}`;}

  function renderAutoSaveSettings(){
    const ls=lastSaveAt?lastSaveAt.toLocaleString('pt-BR'):'Nenhum save nesta sessão';
    return `<div class="card"><div class="card-header"><h3>Salvamento Automático</h3></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <div><div style="font-weight:600;font-size:14px;">Habilitar Auto-Save</div><div style="font-size:12px;color:var(--text-secondary);margin-top:2px;">Baixa planilhas XLSX a cada 45 minutos.</div></div>
        <div onclick="toggleAutoSave()" style="width:46px;height:24px;border-radius:12px;background:${config.autoSave?'var(--success)':'var(--gray-300)'};position:relative;cursor:pointer;transition:background 0.2s;"><div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:2px;left:${config.autoSave?'24px':'2px'};transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:12px;margin-bottom:14px;">
        <div style="background:var(--gray-50);padding:10px;border-radius:var(--radius-md);border:1px solid var(--border-color);"><div style="color:var(--text-secondary);margin-bottom:2px;">⏱ Intervalo</div><div style="font-weight:700;font-family:'JetBrains Mono',monospace;">45 minutos</div></div>
        <div style="background:var(--gray-50);padding:10px;border-radius:var(--radius-md);border:1px solid var(--border-color);"><div style="color:var(--text-secondary);margin-bottom:2px;">🕐 Próximo save</div><div style="font-weight:700;font-family:'JetBrains Mono',monospace;">${config.autoSave&&nextSaveAt?nextSaveAt.toLocaleTimeString('pt-BR'):'—'}</div></div>
        <div style="background:var(--gray-50);padding:10px;border-radius:var(--radius-md);border:1px solid var(--border-color);grid-column:1/-1;"><div style="color:var(--text-secondary);margin-bottom:2px;">💾 Último save</div><div style="font-weight:700;font-family:'JetBrains Mono',monospace;font-size:11px;">${ls}</div></div>
      </div>
      <div style="display:flex;gap:10px;"><button class="btn btn-primary btn-sm" onclick="salvarAgora()"><i class="fas fa-download"></i> Baixar Agora</button><button class="btn btn-outline btn-sm" onclick="renderDashboard('settings')"><i class="fas fa-sync-alt"></i> Atualizar</button></div>
    </div>`;
  }

  function inicializarAutoSaveAposLogin(){if(config.autoSave)iniciarAutoSave();atualizarWidgetAutoSave();}

  // =====================================================================
  //  INIT
  // =====================================================================
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appContainer').style.display = 'none';
    // Mostrar dica de credenciais padrão apenas se não houver dados salvos
    const hint = document.getElementById('loginHint');
    if (hint && !localStorage.getItem('navcontrol_db')) {
      hint.textContent = 'Primeira vez? Use admin / 123456';
      hint.style.color = 'var(--oleo-color)';
    }
  });

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') ['supplyModal','companyModal','vesselModal'].forEach(id=>{const el=document.getElementById(id);if(el&&el.classList.contains('show'))closeModal(id);});
  });

  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', e => { if (e.target === overlay && overlay.id) closeModal(overlay.id); });
  });

  setInterval(() => { if (loggedIn) saveToStorage(); }, 30000);
  window.addEventListener('beforeunload', () => { if (loggedIn) saveToStorage(); });
  </script>
</body>
</html>